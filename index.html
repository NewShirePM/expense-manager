<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NewShire Expense Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700;800;900&family=Source+Code+Pro:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Source Sans 3','Segoe UI',sans-serif;background:#1C3740;color:#E8ECEE}
#root{min-height:100vh}
input,select,textarea,button{font-family:inherit}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#15292F}
::-webkit-scrollbar-thumb{background:#3D6B7B;border-radius:3px}
::placeholder{color:#5A8A9A}
@media print{body{background:#fff!important}.no-print{display:none!important}}
</style>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script crossorigin src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
const{useState,useEffect,useCallback,useRef,useMemo}=React;

// ============================================================
// CONFIGURATION
// ============================================================
const CONFIG={
  clientId:"32e75ffa-747a-4cf0-8209-6a19150c4547",
  tenantId:"33575d04-ca7b-4396-8011-9eaea4030b46",
  siteId:"vanrockre.sharepoint.com,a02c1cd8-9f1f-4827-8286-7b6b7ce74232,01202419-6625-4499-b0d5-8ceb1cffdba3",
  listName:"Expense Log",
  configListName:"Expense Config",
  googleMapsKey:"AIzaSyCgm0GDTAcsYUJtTVrZLR3xS8sazfqXxSY",
  version:"1.2.0",
};
const GRAPH="https://graph.microsoft.com/v1.0";

// ============================================================
// CONSTANTS
// ============================================================
const ROLES={ADMIN:"admin",ACCOUNTING:"accounting",EMPLOYEE:"employee"};
const ROLE_LABELS={admin:"Admin",accounting:"Accounting",employee:"Employee"};
const STATUS={DRAFT:"Draft",SUBMITTED:"Submitted",APPROVED:"Approved",REJECTED:"Rejected",PENDING_PAYMENT:"Pending Payment",PROCESSED:"Processed",PAID:"Paid"};
const STATUS_COLORS={Draft:"#6FA0B0",Submitted:"#CDA04B",Approved:"#3DA06B",Rejected:"#D35B4B","Pending Payment":"#6A8EC8",Processed:"#6A8EC8",Paid:"#3DA06B"};

const DEFAULT_CATEGORIES=["Office Supplies","Travel","Meals/Entertainment","Software/Subscriptions","Maintenance/Repairs","Marketing","Professional Development","Vehicle/Fuel","Other"];
const DEFAULT_EXPENSE_TYPES=["Personal Reimbursement","Mileage","Credit Card Reconciliation"];
const DEFAULT_PROPERTIES=["Fusion Pointe","Townes at Converse","Liberty Square","City View","Villas at Oakwood","701 East Main","Arlington Townes","Hampton Avenue","The Orchard","Single Family"];

const DEFAULT_USERS=[
  {email:"bturner@newshirepm.com",name:"Brandy Turner",role:"admin",homeOffice:"130 Milestone Way, Greenville, SC"},
  {email:"cmunson@newshirepm.com",name:"C. Munson",role:"admin",homeOffice:""},
  {email:"jwhite@vanrockre.com",name:"J. White",role:"admin",homeOffice:""},
];

const DEFAULT_SETTINGS={
  mileageRate:0.70,
  mileageRateYear:"2025",
  categories:DEFAULT_CATEGORIES,
  expenseTypes:DEFAULT_EXPENSE_TYPES,
  properties:DEFAULT_PROPERTIES,
  powerAutomateUrl:"",
};

const DEFAULT_ROUTING={
  "Personal Reimbursement":{approvers:["bturner@newshirepm.com","cmunson@newshirepm.com","jwhite@vanrockre.com"],accounting:[]},
  "Mileage":{approvers:["bturner@newshirepm.com","cmunson@newshirepm.com","jwhite@vanrockre.com"],accounting:[]},
  "Credit Card Reconciliation":{approvers:["bturner@newshirepm.com","cmunson@newshirepm.com","jwhite@vanrockre.com"],accounting:[]},
};

// ============================================================
// BRAND TOKENS
// ============================================================
const B={
  bg:"#1C3740",card:"#1E3A44",cardAlt:"#1A3440",
  teal900:"#15292F",teal800:"#1A3440",teal700:"#1E3A44",teal600:"#2A5262",teal500:"#3D6B7B",teal400:"#4A7E91",teal300:"#6FA0B0",teal200:"#A3C5D0",teal100:"#D0E1E8",
  gold:"#CDA04B",goldLight:"#E8CC7A",goldDim:"#9E7B2F",
  text:"#E8ECEE",textMuted:"#8BA8B4",textDim:"#5A8A9A",
  ok:"#3DA06B",no:"#D35B4B",white:"#FFFFFF",
  border:"#2A5262",inputBg:"#15292F",inputBorder:"#2A5262",
};
const fb="'Source Sans 3','Segoe UI',sans-serif";

// ============================================================
// HELPERS
// ============================================================
function localToday(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function fmtDate(iso){if(!iso)return"‚Äî";const d=new Date(iso);return d.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}
function fmtMoney(v){if(v==null||isNaN(v))return"$0.00";return"$"+Number(v).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}

// ============================================================
// MSAL AUTH
// ============================================================
const msalConfig={auth:{clientId:CONFIG.clientId,authority:`https://login.microsoftonline.com/${CONFIG.tenantId}`,redirectUri:window.location.origin+window.location.pathname},cache:{cacheLocation:"sessionStorage"}};
let msalInstance=null;
try{msalInstance=new msal.PublicClientApplication(msalConfig)}catch(e){console.error("MSAL init failed:",e)}

async function getToken(scopes=["https://graph.microsoft.com/.default"]){
  if(!msalInstance)throw new Error("MSAL not initialized");
  const accounts=msalInstance.getAllAccounts();
  if(accounts.length===0){const resp=await msalInstance.loginPopup({scopes});return resp.accessToken}
  try{const resp=await msalInstance.acquireTokenSilent({scopes,account:accounts[0]});return resp.accessToken}
  catch(e){const resp=await msalInstance.loginPopup({scopes});return resp.accessToken}
}

function getUserEmail(){
  if(!msalInstance)return null;
  const accounts=msalInstance.getAllAccounts();
  return accounts.length>0?(accounts[0].username||accounts[0].idTokenClaims?.preferred_username||"").toLowerCase():null;
}

function getUserName(){
  if(!msalInstance)return null;
  const accounts=msalInstance.getAllAccounts();
  return accounts.length>0?(accounts[0].name||accounts[0].username||""):null;
}

// ============================================================
// SHAREPOINT API HELPERS
// ============================================================
async function spGet(url){
  const token=await getToken();
  const r=await fetch(url,{headers:{Authorization:`Bearer ${token}`,"Accept":"application/json"}});
  if(!r.ok)throw new Error(`SP GET ${r.status}: ${await r.text()}`);
  return r.json();
}

async function spPost(url,body){
  const token=await getToken();
  const r=await fetch(url,{method:"POST",headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(!r.ok)throw new Error(`SP POST ${r.status}: ${await r.text()}`);
  return r.json();
}

async function spPatch(url,body){
  const token=await getToken();
  const r=await fetch(url,{method:"PATCH",headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(!r.ok)throw new Error(`SP PATCH ${r.status}: ${await r.text()}`);
  return r.status===204?{}:r.json();
}

// List item helpers
const listUrl=(listName)=>`${GRAPH}/sites/${CONFIG.siteId}/lists/${listName}`;

async function getListItems(listName,select,expand,filter,top=500){
  let url=`${listUrl(listName)}/items?$top=${top}`;
  if(select)url+=`&$select=${select}`;
  if(expand)url+=`&$expand=${expand}`;
  if(filter)url+=`&$filter=${filter}`;
  const data=await spGet(url);
  return data.value||[];
}

async function createListItem(listName,fields){
  return spPost(`${listUrl(listName)}/items`,{fields});
}

async function updateListItem(listName,itemId,fields){
  return spPatch(`${listUrl(listName)}/items/${itemId}/fields`,fields);
}

// Config helpers ‚Äî store JSON blob in a single list item
async function loadConfig(){
  try{
    const items=await getListItems(CONFIG.configListName,"id,fields","fields",null,1);
    if(items.length>0&&items[0].fields?.ConfigJSON){
      return JSON.parse(items[0].fields.ConfigJSON);
    }
  }catch(e){console.warn("Config load failed, using defaults:",e)}
  return{settings:DEFAULT_SETTINGS,users:DEFAULT_USERS,routing:DEFAULT_ROUTING};
}

async function saveConfig(config){
  const items=await getListItems(CONFIG.configListName,"id,fields","fields",null,1);
  const json=JSON.stringify(config);
  if(items.length>0){
    await updateListItem(CONFIG.configListName,items[0].id,{ConfigJSON:json});
  }else{
    await createListItem(CONFIG.configListName,{Title:"Config",ConfigJSON:json});
  }
}

// Expense helpers
async function loadExpenses(){
  const items=await getListItems(CONFIG.listName,"id,fields","fields");
  return items.map(i=>({id:i.id,...i.fields}));
}

async function createExpense(fields){
  return createListItem(CONFIG.listName,fields);
}

async function updateExpense(itemId,fields){
  return updateListItem(CONFIG.listName,itemId,fields);
}

// ============================================================
// ATTACHMENT HELPERS (SharePoint Document Library)
// ============================================================
async function uploadAttachment(expenseId,file){
  const token=await getToken();
  const folderPath=`Expense Attachments/${expenseId}`;
  // Ensure folder exists
  try{
    await fetch(`${GRAPH}/sites/${CONFIG.siteId}/drive/root:/${folderPath}`,{
      method:"PUT",headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},
      body:JSON.stringify({"folder":{},"@microsoft.graph.conflictBehavior":"replace"})
    });
  }catch(e){}
  // Upload file
  const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/drive/root:/${folderPath}/${file.name}:/content`,{
    method:"PUT",headers:{Authorization:`Bearer ${token}`,"Content-Type":file.type||"application/octet-stream"},
    body:file
  });
  if(!r.ok)throw new Error(`Upload failed: ${r.status}`);
  return r.json();
}

async function getAttachments(expenseId){
  try{
    const data=await spGet(`${GRAPH}/sites/${CONFIG.siteId}/drive/root:/Expense Attachments/${expenseId}:/children`);
    return(data.value||[]).map(f=>({name:f.name,size:f.size,url:f.webUrl,id:f.id}));
  }catch(e){return[]}
}

async function getAttachmentBase64(fileId){
  const t=await getToken();const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/drive/items/${fileId}/content`,{headers:{Authorization:`Bearer ${t}`}});
  if(!r.ok)throw new Error(`Download failed: ${r.status}`);const blob=await r.blob();
  return new Promise((res,rej)=>{const rd=new FileReader();rd.onloadend=()=>res({base64:rd.result.split(",")[1],contentType:blob.type||"application/octet-stream"});rd.onerror=rej;rd.readAsDataURL(blob)});
}

// ============================================================
// EMAIL (Graph /me/sendMail)
// ============================================================
async function sendEmail({to,subject,htmlBody,attachments}){
  const t=await getToken();
  const toR=(Array.isArray(to)?to:[to]).map(e=>({emailAddress:{address:e}}));
  const msg={subject,body:{contentType:"HTML",content:htmlBody},toRecipients:toR};
  if(attachments?.length>0)msg.attachments=attachments.map(a=>({"@odata.type":"#microsoft.graph.fileAttachment",name:a.name,contentType:a.contentType,contentBytes:a.base64}));
  const r=await fetch(`${GRAPH}/me/sendMail`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({message:msg,saveToSentItems:true})});
  if(!r.ok)throw new Error(`Email failed (${r.status}): ${await r.text()}`);
}

function buildExpenseEmailHtml(expense,action,opts={}){
  const{approverName,rejectionNotes,powerAutomateUrl,expenseId}=opts;
  const lineItems=expense.LineItemsJSON?JSON.parse(expense.LineItemsJSON):[];
  const mileStops=expense.MileageStopsJSON?JSON.parse(expense.MileageStopsJSON):[];
  const mileProps=expense.MileagePropertiesJSON?JSON.parse(expense.MileagePropertiesJSON):[];
  const isM=expense.ExpenseType==="Mileage";
  const isCC=expense.ExpenseType==="Credit Card Reconciliation";
  const hdr={
    submitted:{t:"New Expense Submitted",c:"#CDA04B",i:`A new ${expense.ExpenseType} expense has been submitted and requires your review.`},
    approved:{t:"Expense Approved \u2014 Ready for Processing",c:"#3DA06B",i:`An expense has been approved by ${approverName||"an admin"} and is ready for processing.`},
    rejected:{t:"Expense Rejected",c:"#D35B4B",i:"Your expense has been reviewed and was not approved."},
    processed:{t:"Credit Card Expense Processed",c:"#6A8EC8",i:"Your credit card expense has been processed."},
    pending_payment:{t:"Expense Pending Payment",c:"#6A8EC8",i:`An expense has been processed and is pending payment on the next payroll cycle.`},
  }[action];
  let rows=`<tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px;width:140px">Type</td><td style="padding:6px 12px;font-size:12px;font-weight:600;color:#E8ECEE">${expense.ExpenseType}</td></tr><tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Date</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">${fmtDate(expense.ExpenseDate)}</td></tr><tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Submitted By</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">${expense.SubmittedByName||expense.SubmittedBy}</td></tr><tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px;font-weight:700">Amount</td><td style="padding:6px 12px;font-size:16px;font-weight:800;color:#CDA04B">${fmtMoney(expense.Amount)}</td></tr>`;
  if(!isM&&expense.Vendor)rows+=`<tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Vendor</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">${expense.Vendor}</td></tr>`;
  if(expense.Category)rows+=`<tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Category</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">${expense.Category}</td></tr>`;
  if(expense.Description)rows+=`<tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Notes</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">${expense.Description}</td></tr>`;
  if(expense.Tax>0)rows+=`<tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Tax</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">${fmtMoney(expense.Tax)}</td></tr>`;
  if(expense.Tip>0)rows+=`<tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Tip</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">${fmtMoney(expense.Tip)}</td></tr>`;
  if(expense.CardLast4)rows+=`<tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Card</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">\u2022\u2022\u2022\u2022 ${expense.CardLast4}</td></tr>`;
  if(isM){rows+=`<tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Miles</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">${expense.Miles} mi @ $${(expense.MileageRate||0.70).toFixed(2)}/mi</td></tr>`;if(mileStops.length>0)rows+=`<tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Route</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">${mileStops.join(" \u2192 ")}</td></tr>`;if(mileProps.length>0)rows+=`<tr><td style="padding:6px 12px;color:#8BA8B4;font-size:12px">Properties</td><td style="padding:6px 12px;font-size:12px;color:#E8ECEE">${mileProps.join(", ")}</td></tr>`}
  if(action==="rejected"&&rejectionNotes)rows+=`<tr><td style="padding:6px 12px;color:#D35B4B;font-size:12px;font-weight:700">Reason</td><td style="padding:6px 12px;font-size:12px;color:#D35B4B">${rejectionNotes}</td></tr>`;
  let lineHtml="";
  if(lineItems.length>0){lineHtml=`<div style="margin-top:16px"><div style="font-size:11px;font-weight:700;color:#8BA8B4;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Line Items</div><table style="width:100%;border-collapse:collapse;font-size:12px;color:#E8ECEE"><tr style="background:#1A3440"><th style="text-align:left;padding:6px 8px;color:#6FA0B0;font-size:10px">Category</th><th style="text-align:left;padding:6px 8px;color:#6FA0B0;font-size:10px">Description</th><th style="text-align:left;padding:6px 8px;color:#6FA0B0;font-size:10px">Property</th><th style="text-align:right;padding:6px 8px;color:#6FA0B0;font-size:10px">Amount</th></tr>`;lineItems.forEach(li=>{lineHtml+=`<tr style="border-bottom:1px solid #2A5262"><td style="padding:5px 8px">${li.category||"\u2014"}</td><td style="padding:5px 8px">${li.description||"\u2014"}</td><td style="padding:5px 8px">${li.property||"\u2014"}${li.sfAddress?` (${li.sfAddress})`:""}</td><td style="padding:5px 8px;text-align:right;font-weight:600">${fmtMoney(li.amount)}</td></tr>`});lineHtml+=`</table></div>`}
  let actBtns="";
  if(action==="approved"&&powerAutomateUrl&&expenseId){const sep=powerAutomateUrl.includes("?")?"&":"?";const lbl=isCC?"\u2713 Mark as Processed":"\u2713 Mark as Pending Payment";actBtns=`<div style="margin-top:20px;padding:16px;background:#1A3440;border:1px solid #2A5262;border-radius:8px;text-align:center"><div style="font-size:11px;font-weight:700;color:#8BA8B4;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">Take Action</div><a href="${powerAutomateUrl}${sep}expenseId=${expenseId}&action=${isCC?"processed":"pending_payment"}" style="display:inline-block;padding:10px 24px;background:#3DA06B;color:#FFF;text-decoration:none;border-radius:6px;font-weight:700;font-size:13px;margin-right:12px">${lbl}</a><a href="${powerAutomateUrl}${sep}expenseId=${expenseId}&action=flagged" style="display:inline-block;padding:10px 24px;background:#D35B4B;color:#FFF;text-decoration:none;border-radius:6px;font-weight:700;font-size:13px">\u26A0 Flag Issue</a></div>`}
  return`<!DOCTYPE html><html><body style="margin:0;padding:0;background:#1C3740;font-family:'Segoe UI',sans-serif"><div style="max-width:600px;margin:20px auto;background:#1E3A44;border-radius:8px;overflow:hidden;border:1px solid #2A5262"><div style="background:#15292F;padding:16px 20px;border-bottom:2px solid ${hdr.c}"><div style="font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:#CDA04B">NewShire Property Management</div><div style="font-size:18px;font-weight:800;color:#E8ECEE;margin-top:2px">${hdr.t}</div></div><div style="padding:20px"><p style="font-size:13px;color:#A3C5D0;margin-bottom:16px">${hdr.i}</p><table style="width:100%;border-collapse:collapse;background:#15292F;border-radius:6px;overflow:hidden">${rows}</table>${lineHtml}${actBtns}</div><div style="padding:12px 20px;background:#15292F;text-align:center;font-size:9px;color:#3D6B7B">NewShire Expense Manager v${CONFIG.version}</div></div></body></html>`;
}

async function sendNotificationEmail(expense,action,{routing,settings,users,approverName,rejectionNotes,expenseId}){
  const route=routing?.[expense.ExpenseType];if(!route)return;
  try{
    if(action==="submitted"){const a=route.approvers||[];if(a.length===0)return;await sendEmail({to:a,subject:`[Expense Review] ${expense.ExpenseType} \u2014 ${fmtMoney(expense.Amount)} from ${expense.SubmittedByName||expense.SubmittedBy}`,htmlBody:buildExpenseEmailHtml(expense,"submitted",{})})}
    else if(action==="approved"){const ac=route.accounting||[];if(ac.length===0)return;let att=[];try{const fs=await getAttachments(expenseId);for(const f of fs){try{const{base64,contentType}=await getAttachmentBase64(f.id);att.push({name:f.name,contentType,base64})}catch(e){}}}catch(e){}await sendEmail({to:ac,subject:`[Approved \u2014 Process] ${expense.ExpenseType} \u2014 ${fmtMoney(expense.Amount)} from ${expense.SubmittedByName||expense.SubmittedBy}`,htmlBody:buildExpenseEmailHtml(expense,"approved",{approverName,powerAutomateUrl:settings?.powerAutomateUrl||"",expenseId}),attachments:att})}
    else if(action==="rejected"){if(!expense.SubmittedBy)return;await sendEmail({to:expense.SubmittedBy,subject:`[Expense Rejected] ${expense.ExpenseType} \u2014 ${fmtMoney(expense.Amount)}`,htmlBody:buildExpenseEmailHtml(expense,"rejected",{approverName,rejectionNotes})})}
    else if(action==="processed"){const a=route.approvers||[];if(a.length===0)return;await sendEmail({to:a,subject:`[Processed] ${expense.ExpenseType} \u2014 ${fmtMoney(expense.Amount)} from ${expense.SubmittedByName||expense.SubmittedBy}`,htmlBody:buildExpenseEmailHtml(expense,"processed",{})})}
    else if(action==="pending_payment"){const a=route.approvers||[];if(a.length===0)return;await sendEmail({to:a,subject:`[Pending Payment] ${expense.ExpenseType} \u2014 ${fmtMoney(expense.Amount)} from ${expense.SubmittedByName||expense.SubmittedBy}`,htmlBody:buildExpenseEmailHtml(expense,"pending_payment",{})})}
  }catch(e){console.error("Email notification failed:",e)}
}

// ============================================================
// UI COMPONENTS
// ============================================================
const lCss={display:"block",fontSize:"9px",fontWeight:700,textTransform:"uppercase",letterSpacing:"0.8px",color:B.teal300,marginBottom:"3px"};

function Card({children,style,...props}){
  return <div style={{background:B.card,borderRadius:"8px",border:`1px solid ${B.border}`,padding:"16px",...style}} {...props}>{children}</div>;
}

function Btn({children,v="primary",disabled,style,...props}){
  const base={fontFamily:fb,fontWeight:700,fontSize:"11px",border:"none",borderRadius:"4px",cursor:disabled?"not-allowed":"pointer",padding:"7px 16px",letterSpacing:"0.3px",opacity:disabled?0.5:1,transition:"all 0.15s"};
  const variants={
    primary:{...base,background:B.gold,color:"#1C3740"},
    secondary:{...base,background:B.teal600,color:B.teal100},
    danger:{...base,background:B.no,color:B.white},
    ghost:{...base,background:"transparent",color:B.teal300,padding:"7px 10px"},
    small:{...base,background:B.teal600,color:B.teal200,fontSize:"10px",padding:"4px 10px"},
  };
  return <button style={{...variants[v],...style}} disabled={disabled} {...props}>{children}</button>;
}

function F({label,children,required,style}){
  return <div style={{marginBottom:"8px",...style}}>
    {label&&<label style={lCss}>{label}{required&&<span style={{color:B.no}}> *</span>}</label>}
    {children}
  </div>;
}

const inputStyle={
  width:"100%",padding:"7px 10px",background:B.inputBg,border:`1px solid ${B.inputBorder}`,
  borderRadius:"4px",color:B.text,fontSize:"12px",fontFamily:fb,outline:"none",
};

function Inp({style,...props}){return <input style={{...inputStyle,...style}} {...props}/>}

function Sel({options,placeholder,style,...props}){
  return <select style={{...inputStyle,cursor:"pointer",...style}} {...props}>
    {placeholder&&<option value="">{placeholder}</option>}
    {(options||[]).map(o=><option key={o} value={o}>{o}</option>)}
  </select>;
}

function Txt({style,...props}){return <textarea style={{...inputStyle,minHeight:"60px",resize:"vertical",...style}} {...props}/>}

function StatusBadge({status}){
  return <span style={{display:"inline-block",padding:"2px 8px",borderRadius:"3px",fontSize:"9px",fontWeight:800,textTransform:"uppercase",letterSpacing:"0.5px",background:STATUS_COLORS[status]||B.teal600,color:status==="Submitted"?"#1C3740":B.white}}>{status}</span>;
}

function Toast({message,type="info",onClose}){
  if(!message)return null;
  const bg={info:B.teal600,success:B.ok,error:B.no}[type]||B.teal600;
  return <div style={{position:"fixed",top:"16px",right:"16px",background:bg,color:B.white,padding:"10px 20px",borderRadius:"6px",fontSize:"12px",fontWeight:600,zIndex:9999,boxShadow:"0 4px 20px rgba(0,0,0,0.4)",display:"flex",alignItems:"center",gap:"10px",maxWidth:"400px"}}>
    <span>{message}</span>
    <button onClick={onClose} style={{background:"none",border:"none",color:B.white,cursor:"pointer",fontSize:"16px",lineHeight:1}}>√ó</button>
  </div>;
}

// ============================================================
// EXPENSE FORM COMPONENT
// ============================================================
function ExpenseForm({settings,users,userEmail,onSubmit,onCancel}){
  const s=settings||DEFAULT_SETTINGS;
  const cats=s.categories||DEFAULT_CATEGORIES;
  const props=s.properties||DEFAULT_PROPERTIES;
  const currentUser=users?.find(u=>u.email.toLowerCase()===(userEmail||"").toLowerCase());
  const homeOffice=currentUser?.homeOffice||"";

  const[expType,setExpType]=useState("");
  const[date,setDate]=useState(localToday());
  const[vendor,setVendor]=useState("");
  const[description,setDescription]=useState("");
  // Line items (Reimb/CC)
  const[lineItems,setLineItems]=useState([{category:"",description:"",amount:"",property:"",sfAddress:"",taxable:true}]);
  const[tax,setTax]=useState("");
  const[tip,setTip]=useState("");
  // Mileage
  const defaultStops=homeOffice?[homeOffice,""]:["",""];
  const[stops,setStops]=useState(defaultStops);
  const[miles,setMiles]=useState("");
  const[mileCategory,setMileCategory]=useState("Travel");
  const[mileProperties,setMileProperties]=useState([]);
  const[mileSfAddress,setMileSfAddress]=useState("");
  const[routeInfo,setRouteInfo]=useState(null);
  const[calculating,setCalculating]=useState(false);
  // CC
  const[ccLast4,setCcLast4]=useState("");
  const[ccDate,setCcDate]=useState("");
  // Attachments
  const[files,setFiles]=useState([]);
  const fileRef=useRef(null);
  const cameraRef=useRef(null);
  // State
  const[submitting,setSubmitting]=useState(false);
  const[error,setError]=useState(null);

  const isMileage=expType==="Mileage";
  const isCC=expType==="Credit Card Reconciliation";
  const isReimb=expType==="Personal Reimbursement";
  const hasLineItems=isReimb||isCC;

  // Line item helpers
  const updateLine=(idx,field,val)=>{
    const next=[...lineItems];next[idx]={...next[idx],[field]:val};
    if(field==="property"&&val!=="Single Family")next[idx].sfAddress="";
    setLineItems(next);
  };
  const addLine=()=>setLineItems([...lineItems,{category:"",description:"",amount:"",property:"",sfAddress:"",taxable:true}]);
  const removeLine=(idx)=>lineItems.length>1&&setLineItems(lineItems.filter((_,i)=>i!==idx));

  // Mileage stop helpers
  const updateStop=(idx,val)=>{const next=[...stops];next[idx]=val;setStops(next)};
  const addStop=()=>setStops([...stops,""]);
  const removeStop=(idx)=>stops.length>2&&setStops(stops.filter((_,i)=>i!==idx));

  // Totals
  const subtotal=hasLineItems?lineItems.reduce((t,l)=>t+(parseFloat(l.amount)||0),0):0;
  const taxNum=parseFloat(tax)||0;
  const tipNum=parseFloat(tip)||0;
  const grandTotal=hasLineItems?subtotal+taxNum+tipNum:0;
  const mileageTotal=isMileage?(parseFloat(miles)||0)*(s.mileageRate||0.70):0;

  // Tax allocation preview
  const taxableSum=lineItems.filter(l=>l.taxable).reduce((t,l)=>t+(parseFloat(l.amount)||0),0);

  // Calculate mileage route
  const calculateRoute=useCallback(async()=>{
    const validStops=stops.filter(s=>s.trim());
    if(validStops.length<2)return;
    setCalculating(true);setRouteInfo(null);
    try{
      const directionsService=new google.maps.DirectionsService();
      const origin=validStops[0];
      const destination=validStops[validStops.length-1];
      const waypoints=validStops.slice(1,-1).map(s=>({location:s,stopover:true}));
      const result=await directionsService.route({origin,destination,waypoints,travelMode:"DRIVING"});
      const totalMeters=result.routes[0].legs.reduce((t,l)=>t+l.distance.value,0);
      const totalMiles=Math.round(totalMeters*0.000621371*10)/10;
      const totalDuration=result.routes[0].legs.reduce((t,l)=>t+l.duration.value,0);
      const durMin=Math.round(totalDuration/60);
      setMiles(String(totalMiles));
      setRouteInfo({miles:totalMiles,duration:`${durMin} min`,legs:result.routes[0].legs.length});
    }catch(e){
      setError("Route calculation failed: "+e.message);
    }finally{setCalculating(false)}
  },[stops]);

  // File handling
  const handleFiles=(newFiles)=>{
    const total=[...files,...Array.from(newFiles)].slice(0,5);
    setFiles(total);
  };
  const removeFile=(idx)=>setFiles(files.filter((_,i)=>i!==idx));

  // Submit
  const handleSubmit=async()=>{
    if(!expType){setError("Select an expense type");return}
    if(!date){setError("Date is required");return}
    if(hasLineItems&&lineItems.every(l=>!l.amount)){setError("Add at least one line item");return}
    if(isMileage&&!miles){setError("Miles are required");return}
    if(isCC&&!ccLast4){setError("Card last 4 digits required");return}

    setSubmitting(true);setError(null);
    try{
      const fields={
        Title:expType,
        ExpenseType:expType,
        ExpenseDate:date+"T00:00:00Z",
        Description:description||`${expType} - ${vendor||""}`.trim(),
        Vendor:isMileage?"":vendor,
        Status:"Submitted",
        SubmittedBy:userEmail,
        SubmittedByName:getUserName()||userEmail,
        SubmittedDate:new Date().toISOString(),
      };

      if(hasLineItems){
        fields.LineItemsJSON=JSON.stringify(lineItems.map(l=>({
          category:l.category,description:l.description,
          amount:parseFloat(l.amount)||0,property:l.property,
          sfAddress:l.sfAddress,taxable:l.taxable
        })));
        fields.Amount=grandTotal;
        fields.Tax=taxNum;
        fields.Tip=tipNum;
        fields.Category=lineItems[0]?.category||"";
      }

      if(isMileage){
        fields.MileageStopsJSON=JSON.stringify(stops.filter(s=>s.trim()));
        fields.Miles=parseFloat(miles)||0;
        fields.MileageRate=s.mileageRate||0.70;
        fields.Amount=mileageTotal;
        fields.Category=mileCategory;
        fields.MileagePropertiesJSON=JSON.stringify(mileProperties);
        if(mileProperties.includes("Single Family")&&mileSfAddress){
          fields.MileSfAddress=mileSfAddress;
        }
      }

      if(isCC){
        fields.CardLast4=ccLast4;
        fields.ChargeDate=ccDate?ccDate+"T00:00:00Z":"";
      }

      const result=await createExpense(fields);
      const newId=result?.id;

      // Upload attachments
      if(newId&&files.length>0){
        for(const f of files){
          try{await uploadAttachment(newId,f)}catch(e){console.warn("Attachment upload failed:",e)}
        }
      }

      onSubmit&&onSubmit({fields,expenseId:newId});
    }catch(e){
      setError("Submit failed: "+e.message);
    }finally{setSubmitting(false)}
  };

  const handleTypeChange=(v)=>{
    setExpType(v);setMiles("");setTax("");setTip("");setVendor("");setDescription("");
    setLineItems([{category:"",description:"",amount:"",property:"",sfAddress:"",taxable:true}]);
    setFiles([]);setRouteInfo(null);setCcLast4("");setCcDate("");
    if(v==="Mileage")setStops(homeOffice?[homeOffice,""]:[""]);
    setMileProperties([]);setMileSfAddress("");
  };

  return <Card>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"}}>
      <h3 style={{fontSize:"14px",fontWeight:800,color:B.gold,textTransform:"uppercase",letterSpacing:"1px"}}>Submit Expense</h3>
      {onCancel&&<Btn v="ghost" onClick={onCancel}>‚Üê Back</Btn>}
    </div>

    {error&&<div style={{background:"rgba(211,91,75,0.15)",border:`1px solid ${B.no}`,borderRadius:"4px",padding:"8px 12px",marginBottom:"10px",fontSize:"11px",color:B.no,fontWeight:600}}>{error}</div>}

    {/* Expense Type */}
    <F label="Expense Type" required>
      <Sel value={expType} onChange={e=>handleTypeChange(e.target.value)} options={s.expenseTypes||DEFAULT_EXPENSE_TYPES} placeholder="Select type..."/>
    </F>

    {expType&&<>
      {/* Common fields */}
      <div style={{display:"grid",gridTemplateColumns:isCC?"1fr 1fr 1fr":isMileage?"1fr":"1fr 1fr",gap:"8px"}}>
        <F label="Date" required><Inp type="date" value={date} onChange={e=>setDate(e.target.value)}/></F>
        {!isMileage&&<F label="Vendor / Payee"><Inp value={vendor} onChange={e=>setVendor(e.target.value)} placeholder="e.g. Home Depot, Shell"/></F>}
        {isCC&&<F label="Card Last 4" required><Inp value={ccLast4} onChange={e=>setCcLast4(e.target.value.replace(/\D/g,"").slice(0,4))} placeholder="1234" maxLength={4}/></F>}
      </div>
      {isCC&&<F label="Charge Date"><Inp type="date" value={ccDate} onChange={e=>setCcDate(e.target.value)}/></F>}

      {/* ‚îÄ‚îÄ LINE ITEMS (Reimb/CC) ‚îÄ‚îÄ */}
      {hasLineItems&&<div style={{marginTop:"8px"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"}}>
          <label style={{...lCss,marginBottom:0}}>Line Items</label>
          <Btn v="small" onClick={addLine}>+ Add Line</Btn>
        </div>
        {lineItems.map((li,idx)=>(
          <div key={idx} style={{background:B.teal900,border:`1px solid ${B.teal600}`,borderRadius:"6px",padding:"8px",marginBottom:"6px",position:"relative"}}>
            {lineItems.length>1&&<button onClick={()=>removeLine(idx)} style={{position:"absolute",top:"4px",right:"6px",background:"none",border:"none",color:B.no,cursor:"pointer",fontSize:"14px",fontWeight:700}}>√ó</button>}
            <div style={{display:"grid",gridTemplateColumns:"1fr 2fr 80px",gap:"6px",marginBottom:"4px"}}>
              <Sel value={li.category} onChange={e=>updateLine(idx,"category",e.target.value)} options={cats} placeholder="Category" style={{fontSize:"11px",padding:"5px 6px"}}/>
              <Inp value={li.description} onChange={e=>updateLine(idx,"description",e.target.value)} placeholder="Description" style={{fontSize:"11px",padding:"5px 6px"}}/>
              <Inp type="number" value={li.amount} onChange={e=>updateLine(idx,"amount",e.target.value)} placeholder="$0.00" style={{fontSize:"11px",padding:"5px 6px",textAlign:"right"}} step="0.01" min="0"/>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr auto",gap:"6px",alignItems:"center"}}>
              <Sel value={li.property} onChange={e=>updateLine(idx,"property",e.target.value)} options={props} placeholder="Property (optional)" style={{fontSize:"10px",padding:"4px 6px"}}/>
              {li.property==="Single Family"&&<Inp value={li.sfAddress} onChange={e=>updateLine(idx,"sfAddress",e.target.value)} placeholder="Address..." style={{fontSize:"10px",padding:"4px 6px"}}/>}
              {li.property!=="Single Family"&&<div/>}
              <label style={{display:"flex",alignItems:"center",gap:"4px",fontSize:"10px",color:B.teal300,cursor:"pointer",whiteSpace:"nowrap"}}>
                <input type="checkbox" checked={li.taxable} onChange={e=>updateLine(idx,"taxable",e.target.checked)}/> Tax
              </label>
            </div>
          </div>
        ))}

        {/* Tax & Tip */}
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"8px",marginTop:"8px"}}>
          <F label="Tax"><Inp type="number" value={tax} onChange={e=>setTax(e.target.value)} placeholder="$0.00" step="0.01" min="0"/></F>
          <F label="Tip"><Inp type="number" value={tip} onChange={e=>setTip(e.target.value)} placeholder="$0.00" step="0.01" min="0"/></F>
          <F label="Grand Total">
            <div style={{padding:"7px 10px",background:B.teal900,border:`1px solid ${B.gold}`,borderRadius:"4px",fontSize:"14px",fontWeight:800,color:B.gold,textAlign:"right"}}>{fmtMoney(grandTotal)}</div>
          </F>
        </div>

        {/* Tax allocation preview */}
        {taxNum>0&&taxableSum>0&&<div style={{background:B.teal900,borderRadius:"4px",padding:"6px 8px",marginTop:"4px",fontSize:"10px",color:B.teal300}}>
          <span style={{fontWeight:700}}>Tax allocation:</span>{" "}
          {lineItems.filter(l=>l.taxable&&parseFloat(l.amount)>0).map((l,i,arr)=>{
            const pct=(parseFloat(l.amount)||0)/taxableSum;
            const alloc=Math.round(pct*taxNum*100)/100;
            return <span key={i}>{l.category||`Line ${i+1}`}: {fmtMoney(alloc)}{i<arr.length-1?", ":""}</span>;
          })}
        </div>}
      </div>}

      {/* ‚îÄ‚îÄ MILEAGE ‚îÄ‚îÄ */}
      {isMileage&&<div style={{marginTop:"8px"}}>
        <label style={lCss}>Route Stops</label>
        {stops.map((stop,idx)=>(
          <div key={idx} style={{display:"flex",gap:"6px",alignItems:"center",marginBottom:"4px"}}>
            <span style={{fontSize:"10px",color:B.teal400,fontWeight:700,width:"14px"}}>{idx===0?"A":idx===stops.length-1?"B":String.fromCharCode(65+idx)}</span>
            <Inp value={stop} onChange={e=>updateStop(idx,e.target.value)} placeholder={idx===0?"Start address...":"Destination..."} style={{flex:1}}/>
            {stops.length>2&&idx>0&&idx<stops.length-1&&<button onClick={()=>removeStop(idx)} style={{background:"none",border:"none",color:B.no,cursor:"pointer",fontSize:"14px"}}>√ó</button>}
          </div>
        ))}
        <div style={{display:"flex",gap:"8px",marginTop:"4px",marginBottom:"8px"}}>
          <Btn v="small" onClick={addStop}>+ Add Stop</Btn>
          <Btn v="primary" onClick={calculateRoute} disabled={stops.filter(s=>s.trim()).length<2||calculating} style={{fontSize:"10px",padding:"4px 12px"}}>
            {calculating?"Calculating...":"üó∫Ô∏è Calculate Route"}
          </Btn>
        </div>
        {routeInfo&&<div style={{background:B.teal900,borderRadius:"4px",padding:"6px 8px",marginBottom:"8px",fontSize:"11px",color:B.ok,fontWeight:600}}>
          ‚úì Route: {routeInfo.miles} mi ‚Ä¢ ~{routeInfo.duration}{routeInfo.legs>1?` ‚Ä¢ ${routeInfo.legs} legs`:""}
        </div>}

        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"8px"}}>
          <F label="Miles"><Inp type="number" value={miles} onChange={e=>setMiles(e.target.value)} placeholder="0.0" step="0.1" min="0"/></F>
          <F label={`Rate ($${(s.mileageRate||0.70).toFixed(2)}/mi)`}>
            <div style={{...inputStyle,background:B.teal800,color:B.teal300}}>{fmtMoney(mileageTotal)}</div>
          </F>
          <F label="Category"><Sel value={mileCategory} onChange={e=>setMileCategory(e.target.value)} options={cats}/></F>
        </div>

        {/* Multi-property selector */}
        <div style={{marginTop:"8px"}}>
          <label style={lCss}>Associated Properties (cost splits evenly)</label>
          <div style={{display:"flex",gap:"4px",flexWrap:"wrap",marginTop:"4px"}}>
            {props.map(p=>(
              <button key={p} onClick={()=>setMileProperties(prev=>prev.includes(p)?prev.filter(x=>x!==p):[...prev,p])}
                style={{background:mileProperties.includes(p)?B.teal700:B.teal900,color:mileProperties.includes(p)?B.gold:B.teal400,
                  border:`1px solid ${mileProperties.includes(p)?B.gold:B.teal600}`,borderRadius:"4px",padding:"3px 8px",fontSize:"10px",fontWeight:600,cursor:"pointer"}}>
                {mileProperties.includes(p)?"‚úì ":""}{p}
              </button>
            ))}
          </div>
          {mileProperties.includes("Single Family")&&<div style={{marginTop:"4px"}}>
            <Inp value={mileSfAddress} onChange={e=>setMileSfAddress(e.target.value)} placeholder="Single Family address..." style={{fontSize:"11px"}}/>
          </div>}
          {mileProperties.length>1&&<div style={{fontSize:"10px",color:B.teal300,marginTop:"4px"}}>
            Split: {fmtMoney(mileageTotal/mileProperties.length)} each √ó {mileProperties.length} properties
          </div>}
        </div>
      </div>}

      {/* Description */}
      <F label="Notes / Description" style={{marginTop:"8px"}}>
        <Txt value={description} onChange={e=>setDescription(e.target.value)} placeholder="Additional details..." rows={2}/>
      </F>

      {/* ‚îÄ‚îÄ ATTACHMENTS (hidden for Mileage) ‚îÄ‚îÄ */}
      {!isMileage&&<div style={{marginTop:"8px"}}>
        <label style={lCss}>Attachments ({files.length}/5)</label>
        <div style={{display:"flex",gap:"6px",marginTop:"4px"}}>
          <input ref={fileRef} type="file" accept="image/*,.pdf" multiple hidden onChange={e=>handleFiles(e.target.files)}/>
          <input ref={cameraRef} type="file" accept="image/*" capture="environment" hidden onChange={e=>handleFiles(e.target.files)}/>
          <Btn v="small" onClick={()=>fileRef.current?.click()} disabled={files.length>=5}>üìé Upload</Btn>
          <Btn v="small" onClick={()=>cameraRef.current?.click()} disabled={files.length>=5}>üì∑ Camera</Btn>
        </div>
        {files.length>0&&<div style={{marginTop:"6px",display:"flex",gap:"4px",flexWrap:"wrap"}}>
          {files.map((f,i)=>(
            <div key={i} style={{background:B.teal900,border:`1px solid ${B.teal600}`,borderRadius:"4px",padding:"3px 8px",fontSize:"10px",color:B.teal200,display:"flex",alignItems:"center",gap:"6px"}}>
              <span>{f.name.length>20?f.name.slice(0,18)+"...":f.name}</span>
              <span style={{color:B.teal400}}>({(f.size/1024).toFixed(0)}KB)</span>
              <button onClick={()=>removeFile(i)} style={{background:"none",border:"none",color:B.no,cursor:"pointer",fontSize:"12px"}}>√ó</button>
            </div>
          ))}
        </div>}
      </div>}

      {/* Submit */}
      <div style={{display:"flex",justifyContent:"flex-end",gap:"8px",marginTop:"16px",borderTop:`1px solid ${B.teal600}`,paddingTop:"12px"}}>
        {onCancel&&<Btn v="secondary" onClick={onCancel}>Cancel</Btn>}
        <Btn onClick={handleSubmit} disabled={submitting}>{submitting?"Submitting...":"Submit Expense"}</Btn>
      </div>
    </>}
  </Card>;
}

// ============================================================
// EXPENSE LIST COMPONENT
// ============================================================
function ExpenseList({expenses,title,filter,userRole,userEmail,onAction,onView,actionLoading}){
  const filtered=filter?expenses.filter(filter):expenses;
  if(filtered.length===0)return <Card style={{marginBottom:"8px"}}><div style={{fontSize:"11px",color:B.teal400,textAlign:"center",padding:"8px"}}>{title}: None</div></Card>;
  const isCC=(exp)=>exp.ExpenseType==="Credit Card Reconciliation";
  return <Card style={{marginBottom:"8px"}}>
    <h4 style={{fontSize:"11px",fontWeight:800,color:B.gold,textTransform:"uppercase",letterSpacing:"0.8px",marginBottom:"8px"}}>{title} ({filtered.length})</h4>
    {filtered.map(exp=>(
      <div key={exp.id} onClick={()=>onView&&onView(exp)} style={{background:B.teal900,border:`1px solid ${B.teal600}`,borderRadius:"6px",padding:"8px 10px",marginBottom:"4px",cursor:"pointer",transition:"background 0.15s"}}
        onMouseEnter={e=>e.currentTarget.style.background="rgba(205,160,75,0.06)"}
        onMouseLeave={e=>e.currentTarget.style.background=B.teal900}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <div style={{display:"flex",alignItems:"center",gap:"8px",flex:1}}>
            <StatusBadge status={exp.Status}/>
            <span style={{fontSize:"12px",fontWeight:700,color:B.text}}>{exp.SubmittedByName||exp.SubmittedBy}</span>
            <span style={{fontSize:"11px",color:B.teal300}}>{exp.ExpenseType}</span>
            {exp.Vendor&&<span style={{fontSize:"10px",color:B.teal400}}>{"\u2022"} {exp.Vendor}</span>}
          </div>
          <div style={{display:"flex",alignItems:"center",gap:"10px"}}>
            <span style={{fontSize:"13px",fontWeight:800,color:B.gold}}>{fmtMoney(exp.Amount)}</span>
            <span style={{fontSize:"10px",color:B.teal400}}>{fmtDate(exp.ExpenseDate)}</span>
            {/* Any admin can approve/reject */}
            {userRole==="admin"&&exp.Status==="Submitted"&&onAction&&<>
              <Btn v="small" style={{background:B.ok,color:B.white,fontSize:"9px",padding:"3px 8px"}} onClick={e=>{e.stopPropagation();onAction(exp.id,"approve")}} disabled={actionLoading}>{"\u2713"}</Btn>
              <Btn v="small" style={{background:B.no,color:B.white,fontSize:"9px",padding:"3px 8px"}} onClick={e=>{e.stopPropagation();const n=prompt("Rejection reason (optional):");if(n!==null)onAction(exp.id,"reject",n)}} disabled={actionLoading}>{"\u2717"}</Btn>
            </>}
            {/* Process: CC‚ÜíProcessed, Reimb/Mileage‚ÜíPending Payment */}
            {userRole==="admin"&&exp.Status==="Approved"&&onAction&&
              <Btn v="small" style={{background:"#6A8EC8",color:B.white,fontSize:"9px",padding:"3px 8px"}} onClick={e=>{e.stopPropagation();onAction(exp.id,"process")}} disabled={actionLoading}>{isCC(exp)?"$ Processed":"$ Pend Pmt"}</Btn>
            }
            {userRole==="accounting"&&exp.Status==="Approved"&&onAction&&
              <Btn v="small" style={{background:B.ok,color:B.white,fontSize:"9px",padding:"3px 8px"}} onClick={e=>{e.stopPropagation();onAction(exp.id,"process")}} disabled={actionLoading}>{isCC(exp)?"$ Processed":"$ Pend Pmt"}</Btn>
            }
            {/* Mark Pending Payment as Paid */}
            {userRole==="admin"&&exp.Status==="Pending Payment"&&onAction&&
              <Btn v="small" style={{background:B.ok,color:B.white,fontSize:"9px",padding:"3px 8px"}} onClick={e=>{e.stopPropagation();onAction(exp.id,"paid")}} disabled={actionLoading}>{"\u2713"} Paid</Btn>
            }
          </div>
        </div>
      </div>
    ))}
  </Card>;
}

// ============================================================
// DASHBOARD COMPONENT
// ============================================================
function Dashboard({expenses}){
  const[activeKpi,setActiveKpi]=useState(null);
  const submitted=expenses.filter(e=>e.Status==="Submitted");
  const approved=expenses.filter(e=>e.Status==="Approved");
  const pendingPmt=expenses.filter(e=>e.Status==="Pending Payment");
  const processed=expenses.filter(e=>e.Status==="Processed");
  const paid=expenses.filter(e=>e.Status==="Paid");
  const rejected=expenses.filter(e=>e.Status==="Rejected");
  const total=expenses.reduce((t,e)=>t+(e.Amount||0),0);
  const totalTips=expenses.reduce((t,e)=>t+(e.Tip||0),0);
  const totalTax=expenses.reduce((t,e)=>t+(e.Tax||0),0);

  // By expense type
  const byType={};expenses.forEach(e=>{const t=e.ExpenseType||"Other";byType[t]=(byType[t]||0)+(e.Amount||0)});
  const typeEntries=Object.entries(byType).sort((a,b)=>b[1]-a[1]);

  // By category (Mileage as its own)
  const byCat={};expenses.forEach(e=>{const c=e.ExpenseType==="Mileage"?"Mileage":(e.Category||"Other");byCat[c]=(byCat[c]||0)+(e.Amount||0)});
  const catEntries=Object.entries(byCat).sort((a,b)=>b[1]-a[1]);

  const typeColors={"Personal Reimbursement":"#CDA04B","Mileage":"#3DA06B","Credit Card Reconciliation":"#6A8EC8"};
  const catColors=["#CDA04B","#3DA06B","#6A8EC8","#D35B4B","#9E7B2F","#6FA0B0","#A3C5D0","#4A7E91","#E8CC7A","#D0E1E8"];

  const kpiDefs=[
    {id:"total",label:"Total",value:fmtMoney(total),sub:`${expenses.length} expenses`,color:B.gold,filter:()=>expenses},
    {id:"pending",label:"Pending",value:submitted.length,sub:fmtMoney(submitted.reduce((t,e)=>t+(e.Amount||0),0)),color:B.goldDim,filter:()=>submitted},
    {id:"approved",label:"Approved",value:approved.length,color:B.ok,filter:()=>approved},
    {id:"pending_pmt",label:"Pending Pmt",value:pendingPmt.length,sub:fmtMoney(pendingPmt.reduce((t,e)=>t+(e.Amount||0),0)),color:"#6A8EC8",filter:()=>pendingPmt},
    {id:"processed",label:"Processed",value:processed.length,color:"#6A8EC8",filter:()=>processed},
    {id:"paid",label:"Paid",value:paid.length,color:B.ok,filter:()=>paid},
    {id:"rejected",label:"Rejected",value:rejected.length,color:B.no,filter:()=>rejected},
  ];
  if(totalTips>0)kpiDefs.push({id:"tips",label:"Tips",value:fmtMoney(totalTips),sub:`${expenses.filter(e=>e.Tip>0).length} expense(s)`,color:"#9E7B2F",filter:()=>expenses.filter(e=>e.Tip>0)});
  if(totalTax>0)kpiDefs.push({id:"tax",label:"Tax Paid",value:fmtMoney(totalTax),color:"#6B7A7A",filter:()=>expenses.filter(e=>e.Tax>0)});

  const activeFilter=kpiDefs.find(k=>k.id===activeKpi);
  const filteredExpenses=activeFilter?activeFilter.filter():[];

  const barChart=(entries,colors,label)=>{
    const max=entries.length>0?Math.max(...entries.map(e=>e[1])):1;
    return<div style={{marginBottom:"16px"}}>
      <h4 style={{fontSize:"11px",fontWeight:800,color:B.teal200,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:"8px"}}>{label}</h4>
      {entries.map(([name,amt],i)=>{
        const pct=max>0?Math.round(amt/max*100):0;
        const totalPct=total>0?Math.round(amt/total*100):0;
        const c=typeof colors==="object"&&!Array.isArray(colors)?colors[name]:colors[i%colors.length];
        return<div key={name} style={{display:"flex",alignItems:"center",gap:"8px",marginBottom:"6px"}}>
          <span style={{fontSize:"11px",color:B.teal200,width:"160px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{name}</span>
          <div style={{flex:1,height:"8px",background:B.teal800,borderRadius:"4px",overflow:"hidden"}}>
            <div style={{width:pct+"%",height:"100%",background:c,borderRadius:"4px",transition:"width 0.3s"}}/>
          </div>
          <span style={{fontSize:"10px",color:B.teal300,width:"70px",textAlign:"right"}}>{fmtMoney(amt)}</span>
          <span style={{fontSize:"9px",color:B.teal400,width:"30px",textAlign:"right"}}>{totalPct}%</span>
        </div>
      })}
    </div>;
  };

  return <Card>
    <h3 style={{fontSize:"14px",fontWeight:800,color:B.gold,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"12px"}}>Dashboard</h3>

    {/* KPIs ‚Äî clickable */}
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(100px,1fr))",gap:"8px",marginBottom:"16px"}}>
      {kpiDefs.map(k=>(
        <div key={k.id} onClick={()=>setActiveKpi(activeKpi===k.id?null:k.id)}
          style={{background:activeKpi===k.id?"rgba(205,160,75,0.1)":B.teal900,border:`1px solid ${activeKpi===k.id?B.gold:B.teal600}`,borderRadius:"6px",padding:"10px",textAlign:"center",cursor:"pointer",transition:"all 0.15s"}}>
          <div style={{fontSize:"18px",fontWeight:900,color:k.color||B.gold}}>{k.value}</div>
          <div style={{fontSize:"9px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px",marginTop:"2px"}}>{k.label}</div>
          {k.sub&&<div style={{fontSize:"9px",color:B.teal400,marginTop:"2px"}}>{k.sub}</div>}
        </div>
      ))}
    </div>

    {/* Filtered list when KPI clicked */}
    {activeKpi&&filteredExpenses.length>0&&<div style={{background:B.teal900,border:`1px solid ${B.gold}`,borderRadius:"6px",padding:"10px",marginBottom:"16px"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"}}>
        <span style={{fontSize:"10px",fontWeight:700,color:B.gold,textTransform:"uppercase"}}>{activeFilter.label} ({filteredExpenses.length})</span>
        <button onClick={()=>setActiveKpi(null)} style={{background:"none",border:"none",color:B.teal400,cursor:"pointer",fontSize:"12px"}}>{"\u00d7"} Close</button>
      </div>
      {filteredExpenses.map(exp=>(
        <div key={exp.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 0",borderBottom:`1px solid ${B.teal600}`}}>
          <div style={{display:"flex",alignItems:"center",gap:"6px"}}>
            <StatusBadge status={exp.Status}/>
            <span style={{fontSize:"11px",color:B.text}}>{exp.SubmittedByName||exp.SubmittedBy}</span>
            <span style={{fontSize:"10px",color:B.teal400}}>{exp.ExpenseType}</span>
          </div>
          <div style={{display:"flex",alignItems:"center",gap:"8px"}}>
            <span style={{fontSize:"12px",fontWeight:700,color:B.gold}}>{fmtMoney(exp.Amount)}</span>
            <span style={{fontSize:"10px",color:B.teal400}}>{fmtDate(exp.ExpenseDate)}</span>
          </div>
        </div>
      ))}
    </div>}

    {/* Charts */}
    {typeEntries.length>0&&barChart(typeEntries,typeColors,"By Expense Type")}
    {catEntries.length>0&&barChart(catEntries,catColors,"By Category")}
  </Card>;
}

// ============================================================
// ADMIN PANEL COMPONENT
// ============================================================
function AdminPanel({settings,users,routing,onSave,saving}){
  const[s,setS]=useState({...DEFAULT_SETTINGS,...settings});
  const[u,setU]=useState([...(users||DEFAULT_USERS)]);
  const[r,setR]=useState(JSON.parse(JSON.stringify(routing||DEFAULT_ROUTING)));
  const[newCat,setNewCat]=useState("");
  const[newProp,setNewProp]=useState("");
  const[newUser,setNewUser]=useState({email:"",name:"",role:"employee",homeOffice:""});
  const[newExtEmail,setNewExtEmail]=useState({type:"",email:""});

  const addCat=()=>{if(newCat.trim()&&!s.categories.includes(newCat.trim())){setS({...s,categories:[...s.categories,newCat.trim()]});setNewCat("")}};
  const removeCat=(c)=>setS({...s,categories:s.categories.filter(x=>x!==c)});
  const addProp=()=>{if(newProp.trim()&&!s.properties.includes(newProp.trim())){setS({...s,properties:[...s.properties,newProp.trim()]});setNewProp("")}};
  const removeProp=(p)=>p!=="Single Family"&&setS({...s,properties:s.properties.filter(x=>x!==p)});
  const addUser=()=>{if(newUser.email.trim()&&!u.find(x=>x.email.toLowerCase()===newUser.email.toLowerCase())){setU([...u,{...newUser,email:newUser.email.toLowerCase()}]);setNewUser({email:"",name:"",role:"employee",homeOffice:""})}};
  const removeUser=(email)=>setU(u.filter(x=>x.email!==email));
  const updateUserRole=(email,role)=>setU(u.map(x=>x.email===email?{...x,role}:x));
  const updateUserHome=(email,homeOffice)=>setU(u.map(x=>x.email===email?{...x,homeOffice}:x));

  // Routing toggles
  const adminEmails=u.filter(x=>x.role==="admin").map(x=>x.email);
  const accountingEmails=u.filter(x=>x.role==="accounting").map(x=>x.email);
  const toggleRouting=(expType,field,email)=>{
    const nr={...r};
    if(!nr[expType])nr[expType]={approvers:[],accounting:[]};
    const arr=nr[expType][field]||[];
    if(arr.includes(email)){nr[expType][field]=arr.filter(e=>e!==email)}else{nr[expType][field]=[...arr,email]}
    setR(nr);
  };
  const addExternalAccounting=(expType,email)=>{
    if(!email||!email.includes("@"))return;
    const nr={...r};if(!nr[expType])nr[expType]={approvers:[],accounting:[]};
    if(!nr[expType].accounting.includes(email)){nr[expType].accounting=[...nr[expType].accounting,email]}
    setR(nr);
  };
  const removeExternalAccounting=(expType,email)=>{
    const nr={...r};if(!nr[expType])return;
    nr[expType].accounting=(nr[expType].accounting||[]).filter(e=>e!==email);
    setR(nr);
  };

  const expTypes=s.expenseTypes||DEFAULT_EXPENSE_TYPES;

  return <Card>
    <h3 style={{fontSize:"14px",fontWeight:800,color:B.gold,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"12px"}}>Admin Settings</h3>

    {/* Mileage Rate */}
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px",marginBottom:"16px"}}>
      <F label="Mileage Rate ($/mile)"><Inp type="number" value={s.mileageRate} onChange={e=>setS({...s,mileageRate:parseFloat(e.target.value)||0})} step="0.01"/></F>
      <F label="Rate Year"><Inp value={s.mileageRateYear} onChange={e=>setS({...s,mileageRateYear:e.target.value})}/></F>
    </div>

    {/* Power Automate URL */}
    <div style={{marginBottom:"16px"}}>
      <F label="Power Automate Webhook URL (for accounting action buttons)">
        <Inp value={s.powerAutomateUrl||""} onChange={e=>setS({...s,powerAutomateUrl:e.target.value})} placeholder="https://prod-XX.westus.logic.azure.com/workflows/..."/>
      </F>
    </div>

    {/* Categories */}
    <div style={{marginBottom:"16px"}}>
      <label style={lCss}>Expense Categories</label>
      <div style={{display:"flex",gap:"4px",flexWrap:"wrap",marginBottom:"6px"}}>
        {s.categories.map(c=><span key={c} style={{background:B.teal900,border:`1px solid ${B.teal600}`,borderRadius:"4px",padding:"3px 8px",fontSize:"10px",color:B.teal200,display:"flex",alignItems:"center",gap:"4px"}}>
          {c}<button onClick={()=>removeCat(c)} style={{background:"none",border:"none",color:B.no,cursor:"pointer",fontSize:"11px"}}>√ó</button>
        </span>)}
      </div>
      <div style={{display:"flex",gap:"4px"}}>
        <Inp value={newCat} onChange={e=>setNewCat(e.target.value)} placeholder="New category..." onKeyDown={e=>e.key==="Enter"&&addCat()} style={{flex:1,fontSize:"11px"}}/>
        <Btn v="small" onClick={addCat}>Add</Btn>
      </div>
    </div>

    {/* Properties */}
    <div style={{marginBottom:"16px"}}>
      <label style={lCss}>Properties (for Bill-Backs)</label>
      <div style={{display:"flex",gap:"4px",flexWrap:"wrap",marginBottom:"6px"}}>
        {s.properties.map(p=><span key={p} style={{background:B.teal900,border:`1px solid ${p==="Single Family"?B.gold:B.teal600}`,borderRadius:"4px",padding:"3px 8px",fontSize:"10px",color:p==="Single Family"?B.gold:B.teal200,display:"flex",alignItems:"center",gap:"4px"}}>
          {p}{p!=="Single Family"&&<button onClick={()=>removeProp(p)} style={{background:"none",border:"none",color:B.no,cursor:"pointer",fontSize:"11px"}}>√ó</button>}
        </span>)}
      </div>
      <div style={{display:"flex",gap:"4px"}}>
        <Inp value={newProp} onChange={e=>setNewProp(e.target.value)} placeholder="New property..." onKeyDown={e=>e.key==="Enter"&&addProp()} style={{flex:1,fontSize:"11px"}}/>
        <Btn v="small" onClick={addProp}>Add</Btn>
      </div>
    </div>

    {/* Users */}
    <div style={{marginBottom:"16px"}}>
      <label style={lCss}>Users & Roles</label>
      {u.map(user=>(
        <div key={user.email} style={{background:B.teal900,border:`1px solid ${B.teal600}`,borderRadius:"4px",padding:"6px 8px",marginBottom:"4px",display:"grid",gridTemplateColumns:"1fr 1fr auto 1fr auto",gap:"6px",alignItems:"center"}}>
          <span style={{fontSize:"11px",color:B.text,fontWeight:600}}>{user.name||user.email}</span>
          <span style={{fontSize:"10px",color:B.teal400}}>{user.email}</span>
          <Sel value={user.role} onChange={e=>updateUserRole(user.email,e.target.value)} options={["admin","accounting","employee"]} style={{fontSize:"10px",padding:"3px 6px",width:"100px"}}/>
          <Inp value={user.homeOffice||""} onChange={e=>updateUserHome(user.email,e.target.value)} placeholder="Home office address" style={{fontSize:"10px",padding:"3px 6px"}}/>
          <button onClick={()=>removeUser(user.email)} style={{background:"none",border:"none",color:B.no,cursor:"pointer",fontSize:"14px"}}>√ó</button>
        </div>
      ))}
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr auto auto",gap:"4px",marginTop:"6px"}}>
        <Inp value={newUser.email} onChange={e=>setNewUser({...newUser,email:e.target.value})} placeholder="Email" style={{fontSize:"10px"}}/>
        <Inp value={newUser.name} onChange={e=>setNewUser({...newUser,name:e.target.value})} placeholder="Name" style={{fontSize:"10px"}}/>
        <Sel value={newUser.role} onChange={e=>setNewUser({...newUser,role:e.target.value})} options={["admin","accounting","employee"]} style={{fontSize:"10px",padding:"3px",width:"90px"}}/>
        <Btn v="small" onClick={addUser}>Add</Btn>
      </div>
    </div>

    {/* Email Routing Matrix */}
    <div style={{marginBottom:"16px",borderTop:`1px solid ${B.teal600}`,paddingTop:"12px"}}>
      <label style={lCss}>Email Routing Matrix</label>
      <div style={{fontSize:"10px",color:B.teal400,marginBottom:"10px"}}>Routing controls email notifications only. All admins can see and act on all expenses in the approval queue.</div>
      {expTypes.map(et=>{
        const route=r[et]||{approvers:[],accounting:[]};
        const externalAcct=(route.accounting||[]).filter(e=>![...adminEmails,...accountingEmails].includes(e));
        return <div key={et} style={{background:B.teal900,border:`1px solid ${B.teal600}`,borderRadius:"6px",padding:"10px",marginBottom:"8px"}}>
          <div style={{fontSize:"12px",fontWeight:800,color:B.text,marginBottom:"8px"}}>{et}</div>

          {/* Approvers (notify on submit) */}
          <div style={{marginBottom:"6px"}}>
            <span style={{fontSize:"9px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px"}}>Notify on Submit</span>
            <div style={{display:"flex",gap:"6px",flexWrap:"wrap",marginTop:"4px"}}>
              {adminEmails.map(email=>{
                const active=(route.approvers||[]).includes(email);
                const name=(u.find(x=>x.email===email)||{}).name||email;
                return <button key={email} onClick={()=>toggleRouting(et,"approvers",email)} style={{
                  background:active?"rgba(61,160,107,0.15)":"transparent",border:`1px solid ${active?B.ok:B.teal600}`,
                  borderRadius:"4px",padding:"3px 8px",fontSize:"10px",color:active?B.ok:B.teal400,cursor:"pointer",fontFamily:fb
                }}>{active?"\u2713 ":""}{name}</button>;
              })}
            </div>
          </div>

          {/* Accounting (notify on approve, with attachments) */}
          <div>
            <span style={{fontSize:"9px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px"}}>Notify on Approve (Accounting)</span>
            <div style={{display:"flex",gap:"6px",flexWrap:"wrap",marginTop:"4px"}}>
              {accountingEmails.map(email=>{
                const active=(route.accounting||[]).includes(email);
                const name=(u.find(x=>x.email===email)||{}).name||email;
                return <button key={email} onClick={()=>toggleRouting(et,"accounting",email)} style={{
                  background:active?"rgba(106,142,200,0.15)":"transparent",border:`1px solid ${active?"#6A8EC8":B.teal600}`,
                  borderRadius:"4px",padding:"3px 8px",fontSize:"10px",color:active?"#6A8EC8":B.teal400,cursor:"pointer",fontFamily:fb
                }}>{active?"\u2713 ":""}{name}</button>;
              })}
              {externalAcct.map(email=>(
                <span key={email} style={{background:"rgba(106,142,200,0.15)",border:"1px solid #6A8EC8",borderRadius:"4px",padding:"3px 8px",fontSize:"10px",color:"#6A8EC8",display:"flex",alignItems:"center",gap:"4px"}}>
                  {email}<button onClick={()=>removeExternalAccounting(et,email)} style={{background:"none",border:"none",color:B.no,cursor:"pointer",fontSize:"11px"}}>√ó</button>
                </span>
              ))}
            </div>
            <div style={{display:"flex",gap:"4px",marginTop:"4px"}}>
              <Inp value={newExtEmail.type===et?newExtEmail.email:""} onChange={e=>setNewExtEmail({type:et,email:e.target.value})}
                placeholder="External email (e.g. bookkeeper@...)" style={{flex:1,fontSize:"10px"}}
                onKeyDown={e=>{if(e.key==="Enter"){addExternalAccounting(et,newExtEmail.email);setNewExtEmail({type:"",email:""})}}}/>
              <Btn v="small" onClick={()=>{addExternalAccounting(et,newExtEmail.email);setNewExtEmail({type:"",email:""})}}>+</Btn>
            </div>
          </div>
        </div>;
      })}
    </div>

    <div style={{borderTop:`1px solid ${B.teal600}`,paddingTop:"12px",display:"flex",justifyContent:"flex-end"}}>
      <Btn onClick={()=>onSave(s,u,r)} disabled={saving}>{saving?"Saving...":"Save Settings"}</Btn>
    </div>
  </Card>;
}

// ============================================================
// MAIN APP
// ============================================================
function ExpenseManager(){
  const[authed,setAuthed]=useState(false);
  const[authError,setAuthError]=useState(null);
  const[userEmail,setUserEmail]=useState(null);
  const[userName,setUserName]=useState(null);
  const[settings,setSettings]=useState(DEFAULT_SETTINGS);
  const[users,setUsers]=useState(DEFAULT_USERS);
  const[routing,setRouting]=useState(DEFAULT_ROUTING);
  const[expenses,setExpenses]=useState([]);
  const[loading,setLoading]=useState(true);
  const[tab,setTab]=useState("submit");
  const[toast,setToast]=useState(null);
  const[actionLoading,setActionLoading]=useState(false);
  const[viewExpense,setViewExpense]=useState(null);
  const[adminSaving,setAdminSaving]=useState(false);

  // Determine role
  const userRole=useMemo(()=>{
    if(!userEmail)return"employee";
    const u=users.find(x=>x.email.toLowerCase()===userEmail.toLowerCase());
    return u?.role||"employee";
  },[userEmail,users]);

  const isAdmin=userRole==="admin";
  const isAccounting=userRole==="accounting";

  // Auth
  useEffect(()=>{
    (async()=>{
      try{
        await msalInstance?.initialize?.();
        const token=await getToken();
        setUserEmail(getUserEmail());
        setUserName(getUserName());
        setAuthed(true);
      }catch(e){
        setAuthError(e.message);
      }
    })();
  },[]);

  // Load data
  useEffect(()=>{
    if(!authed)return;
    (async()=>{
      setLoading(true);
      try{
        const[cfg,exps]=await Promise.all([loadConfig(),loadExpenses()]);
        setSettings(cfg.settings||DEFAULT_SETTINGS);
        setUsers(cfg.users||DEFAULT_USERS);
        setRouting(cfg.routing||DEFAULT_ROUTING);
        setExpenses(exps);
      }catch(e){
        console.error("Load error:",e);
        setToast({message:"Failed to load data: "+e.message,type:"error"});
      }finally{setLoading(false)}
    })();
  },[authed]);

  // Refresh expenses
  const refresh=async()=>{
    try{
      const exps=await loadExpenses();
      setExpenses(exps);
    }catch(e){console.error("Refresh error:",e)}
  };

  // Actions
  const handleAction=async(itemId,action,notes)=>{
    setActionLoading(true);
    try{
      const fields={};
      const expense=expenses.find(e=>e.id===itemId);
      const isCC=expense?.ExpenseType==="Credit Card Reconciliation";

      if(action==="approve"){
        fields.Status="Approved";fields.ApprovedBy=userEmail;fields.ApprovedDate=new Date().toISOString();
      }else if(action==="reject"){
        fields.Status="Rejected";fields.ApprovedBy=userEmail;fields.ApprovedDate=new Date().toISOString();
        if(notes)fields.RejectionNotes=notes;
      }else if(action==="process"){
        // CC ‚Üí Processed, Reimb/Mileage ‚Üí Pending Payment
        if(isCC){
          fields.Status="Processed";fields.ProcessedBy=userEmail;fields.ProcessedDate=new Date().toISOString();
        }else{
          fields.Status="Pending Payment";fields.ProcessedBy=userEmail;fields.ProcessedDate=new Date().toISOString();
        }
      }else if(action==="paid"){
        fields.Status="Paid";fields.PaidDate=new Date().toISOString();
      }
      await updateExpense(itemId,fields);

      // Send email notifications (fire-and-forget)
      if(expense){
        const emailAction=action==="process"?(isCC?"processed":"pending_payment"):action;
        if(emailAction!=="paid"){
          sendNotificationEmail({...expense,...fields},emailAction,{
            routing:routing||DEFAULT_ROUTING,settings,users,
            approverName:getUserName()||userEmail,
            rejectionNotes:notes,expenseId:itemId.toString()
          }).catch(e=>console.warn("Email notification error:",e));
        }
      }

      await refresh();
      setToast({message:`Expense ${action==="process"?(isCC?"processed":"moved to pending payment"):action==="paid"?"marked as paid":action+"d"} successfully`,type:"success"});
      setViewExpense(null);
    }catch(e){
      setToast({message:`Action failed: ${e.message}`,type:"error"});
    }finally{setActionLoading(false)}
  };

  // Admin save
  const handleAdminSave=async(newSettings,newUsers,newRouting)=>{
    setAdminSaving(true);
    try{
      await saveConfig({settings:newSettings,users:newUsers,routing:newRouting||routing});
      setSettings(newSettings);setUsers(newUsers);if(newRouting)setRouting(newRouting);
      setToast({message:"Settings saved",type:"success"});
    }catch(e){
      setToast({message:"Save failed: "+e.message,type:"error"});
    }finally{setAdminSaving(false)}
  };

  // Tabs
  const tabs=[
    {id:"submit",label:"Submit Expense",roles:["admin","accounting","employee"]},
    {id:"my",label:"My Expenses",roles:["admin","accounting","employee"]},
    {id:"queue",label:isAccounting?"Processing Queue":"Approval Queue",roles:["admin","accounting"]},
    {id:"dashboard",label:"Dashboard",roles:["admin","accounting"]},
    {id:"admin",label:"‚öô Admin",roles:["admin"]},
  ].filter(t=>t.roles.includes(userRole));

  // Login screen
  if(!authed){
    return <div style={{minHeight:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:B.bg}}>
      <div style={{textAlign:"center"}}>
        <div style={{fontSize:"10px",fontWeight:800,textTransform:"uppercase",letterSpacing:"3px",color:B.gold,marginBottom:"2px"}}>NewShire Property Management</div>
        <h1 style={{fontSize:"22px",fontWeight:900,color:B.text,marginBottom:"16px"}}>Expense Manager</h1>
        {authError?<div style={{color:B.no,fontSize:"12px",marginBottom:"12px"}}>{authError}</div>:
          <div style={{color:B.teal300,fontSize:"12px",marginBottom:"12px"}}>Connecting...</div>}
        <Btn onClick={async()=>{try{await getToken();setAuthed(true);setUserEmail(getUserEmail());setUserName(getUserName());setAuthError(null)}catch(e){setAuthError(e.message)}}}>
          Sign In with Microsoft
        </Btn>
      </div>
      <div style={{position:"fixed",bottom:"12px",fontSize:"9px",color:B.teal500}}>v{CONFIG.version}</div>
    </div>;
  }

  return <div style={{minHeight:"100vh",background:B.bg}}>
    {toast&&<Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)}/>}

    {/* Header */}
    <div style={{background:B.teal900,borderBottom:`2px solid ${B.gold}`,padding:"10px 20px",display:"flex",justifyContent:"space-between",alignItems:"center"}} className="no-print">
      <div>
        <div style={{fontSize:"9px",fontWeight:800,textTransform:"uppercase",letterSpacing:"2px",color:B.gold}}>NewShire Property Management</div>
        <div style={{fontSize:"16px",fontWeight:900,color:B.text}}>Expense Manager</div>
      </div>
      <div style={{display:"flex",alignItems:"center",gap:"6px"}}>
        {tabs.map(t=>(
          <button key={t.id} onClick={()=>setTab(t.id)} style={{
            background:tab===t.id?B.gold:"transparent",color:tab===t.id?"#1C3740":B.teal300,
            border:"none",borderRadius:"4px",padding:"6px 12px",fontSize:"10px",fontWeight:800,
            textTransform:"uppercase",letterSpacing:"0.5px",cursor:"pointer",fontFamily:fb
          }}>{t.label}</button>
        ))}
        <span style={{fontSize:"10px",color:B.teal400,marginLeft:"8px"}}>‚úì {userName} ({ROLE_LABELS[userRole]})</span>
      </div>
    </div>

    {/* Content */}
    <div style={{maxWidth:"1000px",margin:"16px auto",padding:"0 16px"}}>
      {loading?<Card><div style={{textAlign:"center",color:B.teal300,padding:"20px"}}>Loading expenses...</div></Card>:<>

        {tab==="submit"&&<ExpenseForm settings={settings} users={users} userEmail={userEmail} onSubmit={async({fields,expenseId})=>{
          // Fire submit notification
          sendNotificationEmail(fields,"submitted",{
            routing:routing||DEFAULT_ROUTING,settings,users,expenseId:expenseId?.toString()
          }).catch(e=>console.warn("Submit email error:",e));
          await refresh();setTab("my");setToast({message:"Expense submitted!",type:"success"});
        }}/>}

        {tab==="my"&&<ExpenseList expenses={expenses} title="My Expenses"
          filter={e=>e.SubmittedBy?.toLowerCase()===userEmail?.toLowerCase()}
          userRole={userRole} userEmail={userEmail} onView={setViewExpense}/>}

        {tab==="queue"&&isAdmin&&<>
          <ExpenseList expenses={expenses} title="Pending Approval" filter={e=>e.Status==="Submitted"}
            userRole={userRole} userEmail={userEmail} onAction={handleAction} onView={setViewExpense} actionLoading={actionLoading}/>
          <ExpenseList expenses={expenses} title="Approved ‚Äî Awaiting Processing" filter={e=>e.Status==="Approved"}
            userRole={userRole} userEmail={userEmail} onAction={handleAction} onView={setViewExpense} actionLoading={actionLoading}/>
          <ExpenseList expenses={expenses} title="Pending Payment" filter={e=>e.Status==="Pending Payment"}
            userRole={userRole} userEmail={userEmail} onAction={handleAction} onView={setViewExpense} actionLoading={actionLoading}/>
          <ExpenseList expenses={expenses} title="Recently Completed" filter={e=>["Processed","Paid","Rejected"].includes(e.Status)}
            userRole={userRole} userEmail={userEmail} onView={setViewExpense}/>
        </>}

        {tab==="queue"&&isAccounting&&<>
          <ExpenseList expenses={expenses} title="Ready to Process" filter={e=>e.Status==="Approved"}
            userRole={userRole} userEmail={userEmail} onAction={handleAction} onView={setViewExpense} actionLoading={actionLoading}/>
          <ExpenseList expenses={expenses} title="Pending Payment" filter={e=>e.Status==="Pending Payment"}
            userRole={userRole} userEmail={userEmail} onView={setViewExpense}/>
          <ExpenseList expenses={expenses} title="Completed" filter={e=>["Processed","Paid"].includes(e.Status)}
            userRole={userRole} userEmail={userEmail} onView={setViewExpense}/>
        </>}

        {tab==="dashboard"&&<Dashboard expenses={expenses}/>}

        {tab==="admin"&&isAdmin&&<AdminPanel settings={settings} users={users} routing={routing} onSave={handleAdminSave} saving={adminSaving}/>}
      </>}
    </div>

    <div style={{position:"fixed",bottom:"8px",right:"12px",fontSize:"9px",color:B.teal500}} className="no-print">v{CONFIG.version}</div>
  </div>;
}

// Load Google Maps API
const gmScript=document.createElement("script");
gmScript.src=`https://maps.googleapis.com/maps/api/js?key=${CONFIG.googleMapsKey}&libraries=places`;
gmScript.async=true;
document.head.appendChild(gmScript);

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(ExpenseManager));
</script>
</body>
</html>
