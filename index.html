<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NewShire AMI Verification Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700;800;900&family=Source+Code+Pro:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Source Sans 3', 'Segoe UI', sans-serif; background: #F7F8F7; }
  #root { min-height: 100vh; }
  .hist-row:hover { background: #EDF4F7 !important; cursor: pointer; }
  .file-drop { border: 2px dashed #D0D8DC; border-radius: 6px; padding: 16px; text-align: center; transition: all 0.2s; cursor: pointer; }
  .file-drop:hover, .file-drop.dragover { border-color: #CDA04B; background: rgba(205,160,75,0.06); }
  .queue-card { border-left: 3px solid #CDA04B; transition: border-color 0.2s; }
  .queue-card:hover { border-left-color: #B8922E; }
</style>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script crossorigin src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
const { useState, useEffect, useCallback, useRef } = React;

const APP_VERSION = "4.0.0"; // Light theme reskin + history property filter // Admin corrections send emails, remove fake attachment icons from emails
console.log(`[AMI] v${APP_VERSION} loaded`);
const CONFIG = {
  clientId: "32e75ffa-747a-4cf0-8209-6a19150c4547",
  tenantId: "33575d04-ca7b-4396-8011-9eaea4030b46",
  siteId: "vanrockre.sharepoint.com,a02c1cd8-9f1f-4827-8286-7b6b7ce74232,01202419-6625-4499-b0d5-8ceb1cffdba3",
  listName: "AMI Verification Log",
  configListName: "AMI Calculator Config",
  docLibName: "AMI Verification Documents",
  isConfigured: true,
  seedAdmins: ["bturner@newshirepm.com","cmunson@newshirepm.com","jwhite@vanrockre.com"],
};
const GRAPH = "https://graph.microsoft.com/v1.0";

// ROLES: multi-role array per user. leaser=fill form+submit to manager, manager=review leaser subs+submit own+forward to approver, approver=review+approve/deny, admin=override+config+manage users
const ROLES = { ADMIN:"admin", APPROVER:"approver", MANAGER:"manager", LEASER:"leaser" };
const ROLE_LABELS = { admin:"Admin", approver:"Approver", manager:"Manager", leaser:"Leaser" };

// Workflow statuses
const WF = { SUBMITTED:"Submitted", UNDER_REVIEW:"Under Review", APPROVED:"Approved", DENIED:"Denied", REGIONAL_REVIEW:"Regional Review", OVERRIDE_APPROVED:"Override Approved", FINAL_DENIED:"Final Denied", SENT_BACK:"Sent Back", LEASED:"Leased", TRANSFERRED_ALT:"Transferred to Alt AMI", TRANSFERRED_MARKET:"Transferred to Market", REFUSED:"Refused", CANCELED:"Canceled" };
const WF_COLORS = {
  [WF.SUBMITTED]:{bg:"rgba(205,160,75,0.08)",br:"rgba(205,160,75,0.3)",fg:"#CDA04B"},
  [WF.UNDER_REVIEW]:{bg:"rgba(74,120,176,0.08)",br:"rgba(74,120,176,0.3)",fg:"#4A78B0"},
  [WF.APPROVED]:{bg:"rgba(61,160,107,0.08)",br:"rgba(61,160,107,0.3)",fg:"#3DA06B"},
  [WF.DENIED]:{bg:"rgba(211,91,75,0.08)",br:"rgba(211,91,75,0.3)",fg:"#D35B4B"},
  [WF.REGIONAL_REVIEW]:{bg:"rgba(122,94,167,0.08)",br:"rgba(122,94,167,0.3)",fg:"#7A5EA7"},
  [WF.OVERRIDE_APPROVED]:{bg:"rgba(100,140,200,0.08)",br:"rgba(100,140,200,0.3)",fg:"#6A8EC8"},
  [WF.FINAL_DENIED]:{bg:"rgba(211,91,75,0.08)",br:"rgba(211,91,75,0.3)",fg:"#D35B4B"},
  [WF.SENT_BACK]:{bg:"rgba(230,140,50,0.08)",br:"rgba(230,140,50,0.3)",fg:"#E68C32"},
  [WF.LEASED]:{bg:"rgba(61,160,107,0.12)",br:"rgba(61,160,107,0.4)",fg:"#2D8A5B"},
  [WF.TRANSFERRED_ALT]:{bg:"rgba(74,120,176,0.12)",br:"rgba(74,120,176,0.4)",fg:"#4A78B0"},
  [WF.TRANSFERRED_MARKET]:{bg:"rgba(150,150,150,0.08)",br:"rgba(150,150,150,0.3)",fg:"#888"},
  [WF.CANCELED]:{bg:"rgba(211,91,75,0.06)",br:"rgba(211,91,75,0.2)",fg:"#B04040"},
  [WF.REFUSED]:{bg:"rgba(230,140,50,0.08)",br:"rgba(230,140,50,0.3)",fg:"#C47A20"},
};

// Send-back reasons (predefined)
const SEND_BACK_REASONS = ["Missing Income Documentation","Missing Verification Worksheet","Incomplete Verification Worksheet","Other"];

const DEFAULT_USERS = [
  { email:"bturner@newshirepm.com", name:"Brandy Turner", roles:["approver","admin"] },
  { email:"cmunson@newshirepm.com", name:"C. Munson", roles:["admin"] },
  { email:"jwhite@vanrockre.com", name:"J. White", roles:["admin"] },
];
// Migrate old single-role user to multi-role
function migrateUser(u){const m=Array.isArray(u.roles)?u:{...u,roles:u.role?[u.role]:["manager"]};return m}
function migrateUsers(users){return(users||[]).map(migrateUser)}

const DEFAULT_COUNTIES = {
  "Spartanburg County, SC": {
    fiscalYears:[{
      fy:"FY 2025", medianIncome:82400,
      tiers:[0.3,0.5,0.6,0.8,1.0], personCounts:[1,2,3,4,5,6,7,8],
      limits:[
        [17300,19750,22200,24650,26650,28600,30600,32550],
        [28750,32850,36950,41050,44350,47650,50950,54200],
        [34500,39420,44340,49260,53220,57180,61140,65040],
        [46000,52600,59150,65700,71000,76250,81500,86750],
        [57700,65950,74200,82400,89000,95600,102200,108800],
      ],
    }],
  },
};
// Helper: get active (most recent) FY for a county â€” always fiscalYears[0]
function getActiveFY(county){return county?.fiscalYears?.[0]||null}
// Helper: migrate old flat county format â†’ fiscalYears format
function migrateCounty(c){
  if(c.fiscalYears)return c; // already new format
  return{fiscalYears:[{fy:c.label||"FY 2025",medianIncome:c.medianIncome||0,tiers:c.tiers||[0.3,0.5,0.6,0.8,1.0],personCounts:c.personCounts||[1,2,3,4,5,6,7,8],limits:c.limits||[]}]};
}
function migrateAllCounties(counties){
  const out={};
  for(const[name,c]of Object.entries(counties))out[name]=migrateCounty(c);
  return out;
}
const DEFAULT_PROPERTIES = [
  {name:"701 East Main Condos",county:"Spartanburg County, SC",units:[
    {bedrooms:0,ami:0.6,maxRent:860,marketRent:860,count:5},{bedrooms:0,ami:0.8,maxRent:1150,marketRent:960,count:6},{bedrooms:1,ami:0.6,maxRent:920,marketRent:920,count:1}]},
  {name:"City View",county:"Spartanburg County, SC",units:[
    {bedrooms:1,ami:0.6,maxRent:920,marketRent:895,count:7},{bedrooms:1,ami:0.8,maxRent:1230,marketRent:955,count:11},{bedrooms:2,ami:0.6,maxRent:1105,marketRent:1095,count:7},{bedrooms:2,ami:0.8,maxRent:1475,marketRent:1195,count:3}]},
  {name:"Fusion Pointe",county:"Spartanburg County, SC",units:[
    {bedrooms:1,ami:0.6,maxRent:920,marketRent:600,count:14},{bedrooms:3,ami:0.6,maxRent:1280,marketRent:1280,count:9},{bedrooms:3,ami:0.8,maxRent:1705,marketRent:1285,count:15},{bedrooms:4,ami:0.6,maxRent:1430,marketRent:1375,count:11},{bedrooms:4,ami:0.8,maxRent:1905,marketRent:1375,count:13}]},
  {name:"Liberty Square",county:"Spartanburg County, SC",units:[
    {bedrooms:1,ami:0.5,maxRent:770,marketRent:770,count:4},{bedrooms:2,ami:0.5,maxRent:900,marketRent:900,count:4},{bedrooms:2,ami:0.8,maxRent:1400,marketRent:1064,count:19},{bedrooms:3,ami:0.8,maxRent:1608,marketRent:1375,count:3}]},
  {name:"Townes at Converse",county:"Spartanburg County, SC",units:[
    {bedrooms:3,ami:0.5,maxRent:1067,marketRent:1067,count:16},{bedrooms:3,ami:0.8,maxRent:1708,marketRent:1708,count:43}]},
];

function localToday(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`}
const PAY_FREQ=[{label:"Weekly",m:52},{label:"BiWeekly",m:26},{label:"Semi Monthly",m:24},{label:"Monthly",m:12}];
const OTH_FREQ=[...PAY_FREQ,{label:"Bi Monthly",m:6},{label:"Quarterly",m:4},{label:"Semi Annually",m:2},{label:"Annually",m:1}];
const OTH_TYPES=["Child Support","SSI/SSDI","Pension","VA Benefits","Unemployment","Self Employment","Interest/Dividends","W2 Verified Employment","Other"];

const B={teal900:"#1C3740",teal800:"#FFFFFF",teal700:"#28434C",teal600:"#D0D8DC",teal500:"#3A6577",teal400:"#7A8585",teal300:"#28434C",teal200:"#A3C5CF",teal100:"#D6E7EC",teal50:"#EDF4F7",gold700:"#9E7B2F",gold600:"#B8922E",gold500:"#CDA04B",gold400:"#9E7B2F",gold300:"#E0C680",gold200:"#EDDAAC",gold100:"#F8F0DB",gold50:"#FFFBF0",white:"#28434C",offWhite:"#F7F8F7",gray100:"#E8EAEA",gray200:"#D0D4D4",gray300:"#5A6666",gray400:"#7A8585",gray500:"#A8B0B0",gray600:"#3E4A4A",dark:"#1A2A30",ok:"#2D8A5A",okBg:"rgba(45,138,90,0.08)",okBr:"rgba(45,138,90,0.3)",no:"#C44B3B",noBg:"rgba(196,75,59,0.06)",noBr:"rgba(196,75,59,0.25)",wBg:"rgba(205,160,75,0.08)",wBr:"rgba(205,160,75,0.3)",ov:"#4A78B0",ovBg:"rgba(74,120,176,0.08)",ovBr:"rgba(74,120,176,0.3)",purple:"#7A5EA7",purpleBg:"rgba(122,94,167,0.08)",purpleBr:"rgba(122,94,167,0.3)"};
const fb="'Source Sans 3','Segoe UI',sans-serif", fm="'Source Code Pro','Fira Code',monospace";

// CALC ENGINE
function anchorP(br){return br===0?1:Math.ceil(br*1.5)}
function effP(br,occ){return Math.max(occ||anchorP(br),anchorP(br))}
function getLimit(tier,persons,lim){const ti=lim.tiers.indexOf(tier),pi=lim.personCounts.indexOf(persons);return ti===-1||pi===-1?null:lim.limits[ti][pi]}
function calcPS(stubs,freq){const v=stubs.filter(s=>s!==""&&!isNaN(+s));if(!v.length)return 0;const f=PAY_FREQ.find(x=>x.label===freq);return(v.reduce((a,b)=>a+ +b,0)/v.length)*(f?f.m:0)}
function calcOL(hr,hpw,sal){if(sal&&+sal>0)return+sal;return hr&&hpw?+hr*+hpw*52:0}
function calcBK(deps){const v=deps.filter(d=>d!==""&&!isNaN(+d));return v.length?(v.reduce((a,b)=>a+ +b,0)/v.length)*12:0}
function calcOth(items){return items.reduce((t,i)=>{if(!i.amount||!i.frequency)return t;const f=OTH_FREQ.find(x=>x.label===i.frequency);return t+ +i.amount*(f?f.m:0)},0)}
function verify({tier,br,occ,income,rent,lim}){
  const eff=effP(br,occ),limit=getLimit(tier,eff,lim);
  if(!limit)return{result:"ERROR",reason:"Limit not found",variance:0,limit:0,eff,anchor:anchorP(br),minMo:0,mo:0,tier};
  const minMo=rent*2.5,mo=income/12,anchor=anchorP(br);
  if(income>limit)return{result:"DENIED",reason:"Income Exceeds AMI Limit",variance:income-limit,limit,eff,anchor,minMo,mo,tier};
  if(mo<minMo)return{result:"DENIED",reason:"Below Minimum Income (2.5x Rent)",variance:(minMo-mo)*12,limit,eff,anchor,minMo,mo,tier};
  return{result:"APPROVED",reason:null,variance:0,limit,eff,anchor,minMo,mo,tier};
}

// MSAL
function useMsal(){
  const[state,setState]=useState({status:"idle",user:null,error:null});
  const ref=useRef(null);
  const getToken=useCallback(async()=>{
    if(!CONFIG.isConfigured)return null;
    try{
      if(!window.msal){console.error("MSAL not loaded");return null}
      if(!ref.current){ref.current=new window.msal.PublicClientApplication({auth:{clientId:CONFIG.clientId,authority:`https://login.microsoftonline.com/${CONFIG.tenantId}`,redirectUri:window.location.origin},cache:{cacheLocation:"sessionStorage"}});await ref.current.initialize()}
      const accts=ref.current.getAllAccounts(),scopes=["Sites.ReadWrite.All","Mail.Send"];
      if(accts.length){try{const r=await ref.current.acquireTokenSilent({scopes,account:accts[0]});setState({status:"ok",user:accts[0],error:null});return r.accessToken}catch{}}
      const r=await ref.current.acquireTokenPopup({scopes});setState({status:"ok",user:r.account,error:null});return r.accessToken;
    }catch(e){console.error("Auth:",e);setState({status:"error",user:null,error:e.message});return null}
  },[]);
  return{...state,getToken};
}

// SHAREPOINT API
async function getListId(tok,name){const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists?$filter=displayName eq '${name}'`,{headers:{Authorization:`Bearer ${tok}`}});const d=await r.json();return d.value?.[0]?.id||null}
async function spWrite(tok,rec){const lid=await getListId(tok,CONFIG.listName);if(!lid)throw new Error("List not found");const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items`,{method:"POST",headers:{Authorization:`Bearer ${tok}`,"Content-Type":"application/json"},body:JSON.stringify({fields:rec})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e?.error?.message||`Error ${r.status}`)}return r.json()}
async function spUpdate(tok,itemId,fields){const lid=await getListId(tok,CONFIG.listName);if(!lid)throw new Error("List not found");const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items/${itemId}`,{method:"PATCH",headers:{Authorization:`Bearer ${tok}`,"Content-Type":"application/json"},body:JSON.stringify({fields})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e?.error?.message||`Error ${r.status}`)}return r.json()}
async function spDelete(tok,itemId){const lid=await getListId(tok,CONFIG.listName);if(!lid)throw new Error("List not found");const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items/${itemId}`,{method:"DELETE",headers:{Authorization:`Bearer ${tok}`}});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e?.error?.message||`Error ${r.status}`)}}
async function spHistory(tok,n=200){const lid=await getListId(tok,CONFIG.listName);if(!lid)return[];const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items?$expand=fields&$top=${n}`,{headers:{Authorization:`Bearer ${tok}`}});if(!r.ok)return[];const d=await r.json();return(d.value||[]).map(i=>({...i.fields,_itemId:i.id})).sort((a,b)=>new Date(b.DateCompleted||0)-new Date(a.DateCompleted||0))}
async function cfgLoad(tok){const lid=await getListId(tok,CONFIG.configListName);if(!lid)return null;const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items?$expand=fields&$top=10&$orderby=fields/Modified desc`,{headers:{Authorization:`Bearer ${tok}`}});if(!r.ok)return null;const d=await r.json();if(!d.value?.length)return null;const f=d.value[0].fields;try{const counties=JSON.parse(f.IncomeLimitsJSON),properties=JSON.parse(f.PropertiesJSON);let users=null;try{users=JSON.parse(f.ModifiedByName.includes("[")?f.ModifiedByName:"{}")}catch{}if(!users&&f.Title?.startsWith("Config")){}return{itemId:d.value[0].id,counties,properties,users,lastModified:f.Modified}}catch{return null}}
async function cfgSave(tok,counties,properties,users,modBy){const lid=await getListId(tok,CONFIG.configListName);if(!lid)throw new Error("Config list not found");const fields={Title:`Config ${localToday()}`,IncomeLimitsJSON:JSON.stringify({counties,users}),PropertiesJSON:JSON.stringify(properties),ModifiedByName:modBy};const existing=await cfgLoad(tok);if(existing?.itemId){const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items/${existing.itemId}`,{method:"PATCH",headers:{Authorization:`Bearer ${tok}`,"Content-Type":"application/json"},body:JSON.stringify({fields})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e?.error?.message||`Error ${r.status}`)}return}const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items`,{method:"POST",headers:{Authorization:`Bearer ${tok}`,"Content-Type":"application/json"},body:JSON.stringify({fields})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e?.error?.message||`Error ${r.status}`)}}

// Document library â€” upload files to submission folders
async function getDriveId(tok){const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/drives`,{headers:{Authorization:`Bearer ${tok}`}});if(!r.ok)return null;const d=await r.json();return d.value?.find(dr=>dr.name===CONFIG.docLibName)?.id||null}
async function uploadFile(tok,driveId,folderName,file){const url=`${GRAPH}/drives/${driveId}/root:/${encodeURIComponent(folderName)}/${encodeURIComponent(file.name)}:/content`;const r=await fetch(url,{method:"PUT",headers:{Authorization:`Bearer ${tok}`,"Content-Type":file.type||"application/octet-stream"},body:file});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e?.error?.message||`Upload failed: ${r.status}`)}const d=await r.json();return{name:file.name,url:d.webUrl,size:d.size}}
async function uploadFiles(tok,folderName,files){const driveId=await getDriveId(tok);if(!driveId)throw new Error("Document library not found. Run the PowerShell setup script.");const results=[];for(const f of files){results.push(await uploadFile(tok,driveId,folderName,f))}return results}

// Fallback: look up attachments from document library when AttachmentURLs field is empty
async function lookupAttachmentsFromDrive(tok,rec){
  try{
    const driveId=await getDriveId(tok);if(!driveId)return[];
    // Reconstruct the folder name pattern from record fields
    const property=(rec.Property||"").replace(/[^a-zA-Z0-9_-]/g,"_");
    const unit=(rec.UnitAddress||"unit").replace(/[^a-zA-Z0-9_-]/g,"_");
    const date=rec.DateCompleted?rec.DateCompleted.slice(0,10):"";
    // Try applicant name from record
    const applicant=(rec.ApplicantName?.split(",")[0]||"applicant").replace(/[^a-zA-Z0-9_-]/g,"_");
    const folderName=`${property}_${unit}_${applicant}_${date}`;
    // List files in the folder
    const url=`${GRAPH}/drives/${driveId}/root:/${encodeURIComponent(folderName)}:/children?$select=name,webUrl,size`;
    const r=await fetch(url,{headers:{Authorization:`Bearer ${tok}`}});
    if(!r.ok)return[];
    const d=await r.json();
    return(d.value||[]).map(f=>({name:f.name,url:f.webUrl,size:f.size}));
  }catch(e){console.warn("[AMI] Drive attachment lookup failed:",e);return[]}
}

// ============================================================
// EMAIL NOTIFICATION SYSTEM
// ============================================================
// Rent-to-Income Ratio: Monthly Income Ã· Monthly Rent
// â‰¥3.0 = Green (#3DA06B), 2.5-3.0 = Gold (#CDA04B), <2.5 = Red (#D35B4B)
function calcRentToIncomeRatio(totalAnnualIncome, monthlyRent){
  if(!monthlyRent||monthlyRent<=0||!totalAnnualIncome)return{ratio:0,color:"#D35B4B",monthly:0};
  const monthly=totalAnnualIncome/12;
  const ratio=monthly/monthlyRent;
  const color=ratio>=3?"#3DA06B":ratio>=2.5?"#CDA04B":"#D35B4B";
  return{ratio,color,monthly};
}

function buildEmailRow(label,value,valueStyle){
  return`<tr><td style="padding:4px 0;color:#666;font-size:13px;width:160px">${label}</td><td style="padding:4px 0;font-size:13px;font-weight:600">${valueStyle?`<span style="${valueStyle}">${value}</span>`:value}</td></tr>`;
}

function buildEmailHTML({headerTitle, headerColor, statusLine, statusColor, actorLabel, actorName, record, notes, showAttachmentNote, attachmentName, ratioInfo}){
  const resultColor=record.calcResult?.includes("Approved")?"#3DA06B":record.calcResult?.includes("Override")?"#6A8EC8":"#D35B4B";
  const ratioDisplay=ratioInfo?`${ratioInfo.ratio.toFixed(2)}Ã—`:"â€”";
  const ratioMath=ratioInfo?` <span style="font-size:10px;color:#888">($${Math.round(ratioInfo.monthly).toLocaleString()}/mo Ã· $${Number(record.monthlyRent).toLocaleString()})</span>`:"";
  return`<div style="font-family:'Segoe UI',sans-serif;max-width:600px;margin:0 auto">
<div style="background:#1C3740;padding:16px 24px;border-radius:6px 6px 0 0">
<span style="color:#CDA04B;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase">NEWSHIRE PROPERTY MANAGEMENT</span><br/>
<span style="color:#F1F3F2;font-size:18px;font-weight:800">${headerTitle}</span>
</div>
<div style="background:#f8f9fa;padding:20px 24px;border:1px solid #e0e0e0;border-top:none;border-radius:0 0 6px 6px">
<p style="font-size:14px;color:${statusColor};font-weight:700">${statusLine}</p>
<p style="font-size:13px;color:#666">${actorLabel}: <strong>${actorName}</strong></p>
<table style="width:100%;border-collapse:collapse;margin:12px 0">
${buildEmailRow("Property",record.property)}
${buildEmailRow("Unit",record.unit||"â€”")}
${buildEmailRow("Applicant",record.applicant)}
${buildEmailRow("AMI Tier",record.amiTier)}
${buildEmailRow("Household Size",record.householdSize)}
${buildEmailRow("Effective Household Size",record.effectiveHouseholdSize)}
${buildEmailRow("Total Income","$"+Number(record.totalIncome).toLocaleString())}
${buildEmailRow("Income Limit","$"+Number(record.incomeLimit).toLocaleString())}
${buildEmailRow("Monthly Rent","$"+Number(record.monthlyRent).toLocaleString())}
${buildEmailRow("Rent-to-Income Ratio",ratioDisplay+ratioMath,`color:${ratioInfo?.color||"#888"};font-weight:700`)}
${buildEmailRow("Calc Result",record.calcResult,`color:${resultColor};font-weight:700`)}
</table>
${notes?`<p style="font-size:13px;color:#666"><strong>${record.notesLabel||"Notes"}:</strong> ${notes}</p>`:""}
${showAttachmentNote?`<p style="font-size:11px;color:#888;margin-top:12px">ðŸ“Ž ${attachmentName||"Notice"} attached.</p>`:""}
<div style="margin-top:16px;padding-top:12px;border-top:1px solid #ddd;font-size:11px;color:#888">
<a href="https://newshirepm.github.io/ami-calc/" style="color:#CDA04B;font-weight:600">Open AMI Verification</a> to ${statusLine.includes("submitted")?"take action":"view details"}.
</div>
</div>
</div>`;
}

// Build email record from a SharePoint history row + form data
function buildEmailRecord(rec, pr, fd, total, rent, countyLimits){
  const ami=rec?.AMITier||fd?.amiTier||0;
  const occ=rec?.Occupants||fd?.occupants||0;
  const eff=rec?.EffectivePersons||pr?.eff||occ;
  return{
    property:rec?.Property||fd?.propertyName||"",
    unit:rec?.UnitAddress||fd?.unitNumber||"",
    applicant:rec?.ApplicantName||fd?.allApplicantNames||"",
    amiTier:ami?`${(+ami*100).toFixed(0)}%`:"â€”",
    householdSize:String(occ),
    effectiveHouseholdSize:String(eff),
    totalIncome:rec?.TotalIncome||total||0,
    incomeLimit:rec?.IncomeLimit||pr?.limit||0,
    monthlyRent:rec?.MonthlyRent||rent||0,
    calcResult:rec?.Result||((pr?.result==="APPROVED")?"Approved":`Denied - ${pr?.reason||""}`),
  };
}

async function sendNotificationEmail(tok, {from, to, cc, subject, htmlBody, importance}){
  const toRecipients=(to||[]).map(e=>({emailAddress:{address:e}}));
  const ccRecipients=(cc||[]).map(e=>({emailAddress:{address:e}}));
  const msg={message:{subject,body:{contentType:"HTML",content:htmlBody},toRecipients,ccRecipients,importance:importance||"normal"},saveToSentItems:true};
  try{
    const r=await fetch(`${GRAPH}/me/sendMail`,{method:"POST",headers:{Authorization:`Bearer ${tok}`,"Content-Type":"application/json"},body:JSON.stringify(msg)});
    if(!r.ok){const e=await r.json().catch(()=>({}));console.error("Email send failed:",e?.error?.message||r.status)}
    return r.ok;
  }catch(e){console.error("Email send error:",e);return false}
}

// Get all approver/admin emails from user list
function getApproverEmails(users){return(users||[]).filter(u=>(u.roles||[]).some(r=>r==="approver"||r==="admin")).map(u=>u.email)}
function getAdminEmails(users){return(users||[]).filter(u=>(u.roles||[]).includes("admin")).map(u=>u.email)}
// Get managers assigned to a specific property (reads from property.managers array)
function getPropertyManagerEmails(users,properties,propertyName){
  const prop=(properties||[]).find(p=>p.name===propertyName);
  return(prop?.managers||[]).filter(Boolean);
}
// Get list of property names assigned to a manager by email
function getManagerProperties(users,properties,email){
  if(!email)return[];
  const e=email.toLowerCase();
  return(properties||[]).filter(p=>(p.managers||[]).some(m=>m.toLowerCase()===e)).map(p=>p.name);
}

// Send workflow notification â€” called after status changes
async function sendWorkflowEmail(tok, action, record, ratioInfo, users, properties, actorName, actorEmail, reviewNotes){
  // Skip emails for records submitted before workflow cutoff (backlog processing)
  const EMAIL_CUTOFF="2026-02-25T00:00:00Z";
  const recDate=record?.DateCompleted||record?.dateCompleted||record?._vDate||"";
  if(recDate&&new Date(recDate)<new Date(EMAIL_CUTOFF)){console.log("[AMI] Skipping email â€” pre-cutoff record");return}
  const approverEmails=getApproverEmails(users);
  const adminEmails=getAdminEmails(users);
  const submitterEmail=record._submittedBy||"";
  const subjectBase=`${record.property} #${record.unit} â€” ${record.applicant}`;

  // Helper: remove actor from CC list, remove duplicates with To
  const buildCC=(toList)=>{
    const toSet=new Set([...(toList||[]),actorEmail].map(e=>e.toLowerCase()));
    return approverEmails.filter(e=>!toSet.has(e.toLowerCase()));
  };

  let emailConfig=null;
  if(action==="submit"||action==="update"){
    // Email 1/1b: Submits/Updates â†’ Property managers + All approvers
    const isUpdate=action==="update";
    const propertyManagers=getPropertyManagerEmails(users,properties,record.property);
    const allRecipients=[...new Set([...propertyManagers,...approverEmails])].filter(e=>e.toLowerCase()!==actorEmail.toLowerCase());
    emailConfig={
      to:allRecipients,
      cc:[],
      subject:isUpdate?`AMI Verification Updated â€” Re-Review Needed: ${subjectBase}`:`AMI Verification Submitted: ${subjectBase}`,
      headerTitle:isUpdate?"Submission Updated â€” Review Required":"New Submission for Review",
      statusLine:isUpdate?"âš  A previously submitted AMI verification has been updated and requires your review. Please review the changes carefully.":"A new AMI verification has been submitted and requires your review.",
      statusColor:isUpdate?"#E68C32":"#333",
      actorLabel:isUpdate?"Updated by":"Submitted by",
      showAttachmentNote:false,
    };
  }else if(action==="approve"){
    // Email 2: Approver approves â†’ Submitter, CC all approvers
    const toList=[submitterEmail].filter(Boolean);
    emailConfig={
      to:toList,
      cc:buildCC(toList),
      subject:`AMI Verification Approved: ${subjectBase}`,
      headerTitle:"Verification Approved",
      statusLine:"âœ“ This verification has been approved.",
      statusColor:"#3DA06B",
      actorLabel:"Reviewed by",
      showAttachmentNote:false,
      notesLabel:"Notes",
    };
  }else if(action==="deny"){
    // Email 3: Approver denies â†’ All admins, CC submitter + all approvers
    const toList=adminEmails.filter(e=>e.toLowerCase()!==actorEmail.toLowerCase());
    emailConfig={
      to:toList.length?toList:approverEmails,
      cc:[submitterEmail,...buildCC(toList)].filter(Boolean),
      subject:`AMI Verification Denied â€” Regional Review Needed: ${subjectBase}`,
      headerTitle:"Denial â€” Regional Review Needed",
      statusLine:"âœ— This verification was denied and requires regional review.",
      statusColor:"#D35B4B",
      actorLabel:"Denied by",
      showAttachmentNote:false,
      notesLabel:"Denial Notes",
    };
  }else if(action==="override_approve"){
    // Email 4A: Regional override approves â†’ Submitter + original approver, CC all other admins
    const reviewedBy=record._reviewedBy||"";
    const toList=[submitterEmail,reviewedBy].filter(Boolean);
    emailConfig={
      to:toList,
      cc:buildCC(toList),
      subject:`AMI Verification Override Approved: ${subjectBase}`,
      headerTitle:"Override Approved",
      statusLine:"âš– Regional has overridden the denial and approved this verification.",
      statusColor:"#6A8EC8",
      actorLabel:"Regional reviewer",
      showAttachmentNote:false,
      notesLabel:"Regional Notes",
    };
    // Override the calc result display
    record.calcResult="Override Approved";
  }else if(action==="final_deny"){
    // Email 4B: Regional confirms final denial â†’ Submitter + original approver, CC all other admins
    const reviewedBy=record._reviewedBy||"";
    const toList=[submitterEmail,reviewedBy].filter(Boolean);
    emailConfig={
      to:toList,
      cc:buildCC(toList),
      subject:`AMI Verification Final Denied: ${subjectBase}`,
      headerTitle:"Final Denial Confirmed",
      statusLine:"âœ— Regional has confirmed the final denial.",
      statusColor:"#D35B4B",
      actorLabel:"Regional reviewer",
      showAttachmentNote:false,
      notesLabel:"Regional Notes",
    };
  }else if(action==="send_back"){
    // Email 5: Send Back â†’ Original submitter, CC all approvers + property managers
    const propertyManagers=getPropertyManagerEmails(users,properties,record.property);
    const toList=[submitterEmail].filter(Boolean);
    const ccList=[...new Set([...propertyManagers,...buildCC(toList)])];
    emailConfig={
      to:toList,
      cc:ccList,
      subject:`AMI Verification Sent Back for Correction: ${subjectBase}`,
      headerTitle:"Sent Back for Correction",
      statusLine:"â†© This verification has been sent back and requires corrections before review can continue.",
      statusColor:"#E68C32",
      actorLabel:"Returned by",
      showAttachmentNote:false,
      notesLabel:"Reason for Return",
    };
  }else if(action==="admin_correction"){
    // Email: Admin correction â†’ Submitter + all approvers, CC admins
    const toList=[submitterEmail,...approverEmails].filter(Boolean);
    emailConfig={
      to:toList,
      cc:buildCC(toList),
      subject:`AMI Verification Corrected: ${subjectBase}`,
      headerTitle:"Admin Correction Applied",
      statusLine:`ðŸ”§ An admin has corrected this verification. Decision: ${reviewNotes||"Updated"}. Please review and reprint if needed.`,
      statusColor:"#7B5EA7",
      actorLabel:"Corrected by",
      showAttachmentNote:false,
      notesLabel:"Correction Notes",
    };
  }

  if(!emailConfig)return;

  // Dedupe To and CC, remove empty strings
  emailConfig.to=[...new Set(emailConfig.to.filter(Boolean).map(e=>e.toLowerCase()))];
  emailConfig.cc=[...new Set(emailConfig.cc.filter(Boolean).map(e=>e.toLowerCase()))].filter(e=>!emailConfig.to.includes(e));

  const htmlBody=buildEmailHTML({
    headerTitle:emailConfig.headerTitle,
    headerColor:"#1C3740",
    statusLine:emailConfig.statusLine,
    statusColor:emailConfig.statusColor,
    actorLabel:emailConfig.actorLabel,
    actorName,
    record:{...record,notesLabel:emailConfig.notesLabel},
    notes:reviewNotes||"",
    showAttachmentNote:emailConfig.showAttachmentNote,
    attachmentName:emailConfig.attachmentName,
    ratioInfo,
  });

  await sendNotificationEmail(tok,{
    to:emailConfig.to,
    cc:emailConfig.cc,
    subject:emailConfig.subject,
    htmlBody,
    importance:action==="deny"||action==="final_deny"||action==="send_back"?"high":"normal",
  });
}

// ============================================================
// UI COMPONENTS
// ============================================================
const iCss={background:"#FFFFFF",border:`1px solid ${B.teal600}`,borderRadius:"4px",color:B.teal700,padding:"7px 9px",fontSize:"12.5px",outline:"none",width:"100%",boxSizing:"border-box",transition:"border-color 0.2s, box-shadow 0.2s",fontFamily:fm};
const lCss={display:"block",fontSize:"10px",fontWeight:700,color:B.teal700,marginBottom:"3px",textTransform:"uppercase",letterSpacing:"0.6px",fontFamily:fb};
const sCss={fontSize:"11px",fontWeight:800,color:B.gold500,textTransform:"uppercase",letterSpacing:"1.2px",marginBottom:"10px",fontFamily:fb,borderBottom:`1px solid ${B.teal600}`,paddingBottom:"7px"};

function F({label,children,style}){return<div style={{marginBottom:"8px",...style}}><label style={lCss}>{label}</label>{children}</div>}
function I({value,onChange,placeholder,type="text",style,disabled}){return<input type={type} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} disabled={disabled} style={{...iCss,opacity:disabled?0.5:1,...style}} onFocus={e=>{e.target.style.borderColor=B.gold500;e.target.style.boxShadow="0 0 0 3px rgba(205,160,75,0.15)"}} onBlur={e=>{e.target.style.borderColor=B.teal600;e.target.style.boxShadow="none"}}/>}
function Sel({value,onChange,options,placeholder,style}){return<select value={value} onChange={e=>onChange(e.target.value)} style={{...iCss,cursor:"pointer",...style}}>{placeholder&&<option value="">{placeholder}</option>}{options.map(o=><option key={typeof o==="string"?o:o.value} value={typeof o==="string"?o:o.value}>{typeof o==="string"?o:o.label}</option>)}</select>}
function Card({children,style,...rest}){return<div style={{background:"#FFFFFF",border:`1px solid ${B.teal600}`,borderRadius:"6px",padding:"14px",boxShadow:"0 1px 3px rgba(28,55,64,0.06)",...style}} {...rest}>{children}</div>}
function Mon({amount,style}){if(amount==null||isNaN(amount))return<span style={style}>â€”</span>;return<span style={style}>${Number(amount).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})}</span>}
function Btn({children,onClick,v="primary",style,disabled}){
  const S={primary:{background:B.teal900,color:"#FFFFFF",border:"none",fontWeight:800},secondary:{background:"#FFFFFF",color:B.teal500,border:`1px solid ${B.teal600}`},success:{background:B.ok,color:"#FFFFFF",border:"none"},danger:{background:B.noBg,color:B.no,border:`1px solid ${B.noBr}`},small:{background:B.gold50,color:B.gold700,border:`1px solid ${B.gold500}44`},override:{background:B.ovBg,color:B.ov,border:`1px solid ${B.ovBr}`},purple:{background:B.purpleBg,color:B.purple,border:`1px solid ${B.purpleBr}`},sendback:{background:"rgba(230,140,50,0.08)",color:"#E68C32",border:"1px solid rgba(230,140,50,0.3)"},neutral:{background:"rgba(150,150,150,0.1)",color:"#aaa",border:"1px solid rgba(150,150,150,0.3)"}};
  return<button onClick={onClick} disabled={disabled} style={{...S[v],borderRadius:"4px",padding:"7px 14px",fontSize:"11px",fontWeight:700,cursor:disabled?"not-allowed":"pointer",fontFamily:fb,opacity:disabled?0.5:1,transition:"all 0.15s",letterSpacing:"0.3px",...style}}>{children}</button>;
}
function StatusBadge({status}){const wf=WF_COLORS[status]||WF_COLORS[WF.SUBMITTED];return<span style={{display:"inline-block",padding:"2px 8px",borderRadius:"9999px",fontSize:"10px",fontWeight:700,background:wf.bg,color:wf.fg,border:`1px solid ${wf.br}`,whiteSpace:"nowrap"}}>{status||"â€”"}</span>}
function ResultBadge({result,reason,variance,tier,overrideStatus,overrideBy,overrideNotes}){
  const ok=result==="APPROVED",ovr=overrideStatus==="OVERRIDE_APPROVED";
  const bg=ovr?B.ovBg:ok?B.okBg:B.noBg,br=ovr?B.ovBr:ok?B.okBr:B.noBr,clr=ovr?B.ov:ok?B.ok:B.no;
  return(
    <div style={{background:bg,border:`1px solid ${br}`,borderRadius:"6px",padding:"10px 14px",marginBottom:"7px"}}>
      <div style={{display:"flex",alignItems:"center",gap:"7px",marginBottom:(reason&&!ovr)||ovr?"4px":0}}>
        <span style={{fontSize:"15px"}}>{ovr?"âš–":ok?"âœ“":"âœ—"}</span>
        <span style={{fontSize:"14px",fontWeight:800,color:clr,fontFamily:fb}}>{ovr?"OVERRIDE APPROVED":result} at {(tier*100).toFixed(0)}% AMI</span>
      </div>
      {reason&&!ovr&&<div style={{fontSize:"11px",color:B.gray300,marginLeft:"22px",fontFamily:fb}}>{reason}{variance>0&&<span style={{color:B.no,fontWeight:700}}> â€” Variance: <Mon amount={variance}/>{reason.includes("Exceeds")?" over limit":" annual shortfall"}</span>}</div>}
      {ovr&&<div style={{fontSize:"11px",color:B.gray300,marginLeft:"22px",fontFamily:fb}}>Override by: <b>{overrideBy}</b> â€” {overrideNotes}</div>}
    </div>
  );
}

// INCOME SECTIONS
function PaystubSec({idx,data,onChange}){
  const stubs=data.paystubs||["","","",""],freq=data.paystubFrequency||"",annual=calcPS(stubs,freq);
  return(<Card style={{marginBottom:"8px"}}><div style={sCss}>Paystubs â€” Applicant {idx+1}{data.name&&<span style={{color:B.white,textTransform:"none",fontWeight:400,marginLeft:"6px",fontSize:"11px"}}>({data.name})</span>}</div>
    <F label="Applicant Name"><I value={data.name||""} onChange={v=>onChange({...data,name:v})} placeholder="Full name"/></F>
    <F label="Pay Frequency"><Sel value={freq} onChange={v=>onChange({...data,paystubFrequency:v})} options={PAY_FREQ.map(f=>f.label)} placeholder="Select frequency"/></F>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:"5px"}}>{stubs.map((s,i)=><F key={i} label={`Stub ${i+1}`}><I type="number" value={s} onChange={v=>{const n=[...stubs];n[i]=v;onChange({...data,paystubs:n})}} placeholder="0.00"/></F>)}</div>
    <div style={{textAlign:"right",fontSize:"11px",color:B.teal300,fontFamily:fb}}>Annualized: <Mon amount={annual} style={{color:B.gold400,fontWeight:700}}/></div></Card>);
}
function OfferSec({idx,data,onChange}){
  const annual=calcOL(data.hourly,data.hoursPerWeek,data.salary);
  return(<Card style={{marginBottom:"8px"}}><div style={sCss}>Offer Letter â€” Applicant {idx+1}{data.name&&<span style={{color:B.white,textTransform:"none",fontWeight:400,marginLeft:"6px",fontSize:"11px"}}>({data.name})</span>}</div>
    <F label="Applicant Name"><I value={data.name||""} onChange={v=>onChange({...data,name:v})} placeholder="Full name"/></F>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"6px"}}>
      <F label="Hourly Pay"><I type="number" value={data.hourly||""} onChange={v=>onChange({...data,hourly:v})} placeholder="0.00"/></F>
      <F label="Hours/Week"><I type="number" value={data.hoursPerWeek||""} onChange={v=>onChange({...data,hoursPerWeek:v})} placeholder="40"/></F>
      <F label="Annual Salary (if salaried)"><I type="number" value={data.salary||""} onChange={v=>onChange({...data,salary:v})} placeholder="0"/></F>
    </div>
    <div style={{textAlign:"right",fontSize:"11px",color:B.teal300,fontFamily:fb}}>Annualized: <Mon amount={annual} style={{color:B.gold400,fontWeight:700}}/></div></Card>);
}
function BankSec({idx,data,onChange}){
  const deps=data.deposits||["","",""],annual=calcBK(deps);
  return(<Card style={{marginBottom:"8px"}}><div style={sCss}>Bank Statements â€” Applicant {idx+1}{data.name&&<span style={{color:B.white,textTransform:"none",fontWeight:400,marginLeft:"6px",fontSize:"11px"}}>({data.name})</span>}</div>
    <F label="Applicant Name"><I value={data.name||""} onChange={v=>onChange({...data,name:v})} placeholder="Full name"/></F>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"6px"}}>{deps.map((d,i)=><F key={i} label={`Statement ${i+1} Deposits`}><I type="number" value={d} onChange={v=>{const n=[...deps];n[i]=v;onChange({...data,deposits:n})}} placeholder="0.00"/></F>)}</div>
    <div style={{textAlign:"right",fontSize:"11px",color:B.teal300,fontFamily:fb}}>Annualized: <Mon amount={annual} style={{color:B.gold400,fontWeight:700}}/></div></Card>);
}
function OtherSec({items,onChange}){
  const annual=calcOth(items);
  return(<Card style={{marginBottom:"8px"}}>
    <div style={{...sCss,display:"flex",justifyContent:"space-between",alignItems:"center"}}><span>Other Income Sources</span><Btn v="small" onClick={()=>onChange([...items,{type:"",receiver:"",amount:"",frequency:"",notes:""}])} style={{padding:"2px 8px",fontSize:"10px"}}>+ Add</Btn></div>
    {items.map((item,i)=>(<div key={i} style={{display:"grid",gridTemplateColumns:"130px 1fr 90px 110px 1fr 24px",gap:"5px",alignItems:"end",marginBottom:"5px"}}>
      <F label={i===0?"Type":""}><Sel value={item.type} onChange={v=>{const n=[...items];n[i]={...n[i],type:v};onChange(n)}} options={OTH_TYPES} placeholder="â€”"/></F>
      <F label={i===0?"Receiver":""}><I value={item.receiver} onChange={v=>{const n=[...items];n[i]={...n[i],receiver:v};onChange(n)}} placeholder="Name"/></F>
      <F label={i===0?"Amount":""}><I type="number" value={item.amount} onChange={v=>{const n=[...items];n[i]={...n[i],amount:v};onChange(n)}} placeholder="0"/></F>
      <F label={i===0?"Frequency":""}><Sel value={item.frequency} onChange={v=>{const n=[...items];n[i]={...n[i],frequency:v};onChange(n)}} options={OTH_FREQ.map(f=>f.label)} placeholder="â€”"/></F>
      <F label={i===0?"Notes":""}><I value={item.notes} onChange={v=>{const n=[...items];n[i]={...n[i],notes:v};onChange(n)}} placeholder="Optional"/></F>
      <button onClick={()=>onChange(items.filter((_,idx)=>idx!==i))} style={{background:"transparent",border:"none",color:B.no,cursor:"pointer",fontSize:"15px",padding:"7px 2px",marginBottom:"8px"}}>Ã—</button>
    </div>))}
    <div style={{textAlign:"right",fontSize:"11px",color:B.teal300,fontFamily:fb}}>Annualized: <Mon amount={annual} style={{color:B.gold400,fontWeight:700}}/></div></Card>);
}

// FILE UPLOAD COMPONENT
function FileUploadZone({files,setFiles,disabled}){
  const inputRef=useRef(null);
  const[dragOver,setDragOver]=useState(false);
  const handleFiles=(fl)=>{const nf=[...files];for(let i=0;i<fl.length&&nf.length<5;i++){if(fl[i].size>10*1024*1024){alert(`${fl[i].name} exceeds 10MB`);continue}nf.push(fl[i])}setFiles(nf)};
  return(
    <Card style={{marginBottom:"12px"}}>
      <div style={sCss}>Income Verification Documents ({files.length}/5)</div>
      <div style={{fontSize:"10px",color:B.teal300,marginBottom:"8px"}}>Attach paystubs, W-2s, offer letters, bank statements. Max 5 files, 10MB each.</div>
      {!disabled&&files.length<5&&(
        <div className={`file-drop${dragOver?" dragover":""}`} onClick={()=>inputRef.current?.click()}
          onDragOver={e=>{e.preventDefault();setDragOver(true)}} onDragLeave={()=>setDragOver(false)}
          onDrop={e=>{e.preventDefault();setDragOver(false);handleFiles(e.dataTransfer.files)}}>
          <input ref={inputRef} type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx" style={{display:"none"}} onChange={e=>{handleFiles(e.target.files);e.target.value=""}}/>
          <div style={{fontSize:"12px",color:B.gold500,fontWeight:700,marginBottom:"4px"}}>ðŸ“Ž Click or drag files here</div>
          <div style={{fontSize:"10px",color:B.gray400}}>PDF, images, Word, Excel â€” up to 10MB each</div>
        </div>
      )}
      {files.length>0&&<div style={{marginTop:"8px"}}>{files.map((f,i)=>(
        <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 8px",background:B.teal50,borderRadius:"3px",marginBottom:"4px",border:`1px solid ${B.teal600}`}}>
          <span style={{fontSize:"11px",color:B.white}}>{f.name?.endsWith(".pdf")?"ðŸ“„":"ðŸ“Ž"} {f.name} <span style={{fontSize:"9px",color:B.gray400}}>({(f.size/1024).toFixed(0)}KB)</span></span>
          {!disabled&&<button onClick={()=>setFiles(files.filter((_,idx)=>idx!==i))} style={{background:"transparent",border:"none",color:B.no,cursor:"pointer",fontSize:"14px"}}>Ã—</button>}
        </div>
      ))}</div>}
    </Card>
  );
}
function AttachmentList({attachments}){
  if(!attachments?.length)return null;
  return(<div style={{marginTop:"6px"}}><div style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:"4px"}}>Attached Documents ({attachments.length})</div>
    {attachments.map((a,i)=>(<a key={i} href={a.url} target="_blank" rel="noopener noreferrer" style={{display:"flex",alignItems:"center",gap:"6px",padding:"3px 8px",background:B.teal50,borderRadius:"3px",marginBottom:"3px",border:`1px solid ${B.teal600}`,textDecoration:"none",fontSize:"11px",color:B.gold400}}>{a.name?.endsWith(".pdf")?"ðŸ“„":"ðŸ“Ž"} {a.name} <span style={{fontSize:"9px",color:B.gray400,marginLeft:"auto"}}>Open â†—</span></a>))}
  </div>);
}

// REVIEW QUEUE â€” Approvers see pending, Admins see denied for regional review, Submitters see sent-back items
function ReviewQueue({history,loading,onAction,onLeaseOutcome,onResetOutcome,onReviewSelect,userRoles,userEmail,users,properties}){
  const[selected,setSelected]=useState(null);
  const[showCompleted,setShowCompleted]=useState(false);
  const[acting,setActing]=useState(false);
  const isApprover=userRoles.includes("approver")||userRoles.includes("admin");
  const isAdmin=userRoles.includes("admin");
  const isManagerRole=userRoles.includes("manager");
  const pendingApprover=history.filter(r=>r.Status===WF.SUBMITTED||r.Status===WF.UNDER_REVIEW);
  const pendingRegional=history.filter(r=>r.Status===WF.DENIED||r.Status===WF.REGIONAL_REVIEW);
  const sentBackToMe=history.filter(r=>r.Status===WF.SENT_BACK&&r.SubmittedBy?.toLowerCase()===userEmail?.toLowerCase());
  // Lease outcomes: managers see only their properties, admins/approvers see all
  const managerProps=isManagerRole&&!isAdmin&&!isApprover?getManagerProperties(users,properties,userEmail):null;
  // Lease outcomes: include Approved, Override Approved, AND any record where AltResult=Approved
  // that has completed the workflow (not still in active review)
  const ACTIVE_REVIEW_STATUSES=[WF.SUBMITTED,WF.UNDER_REVIEW,WF.SENT_BACK,WF.REGIONAL_REVIEW];
  const LEASE_OUTCOME_STATUSES=[WF.LEASED,WF.TRANSFERRED_ALT,WF.TRANSFERRED_MARKET,WF.REFUSED,WF.CANCELED];
  const pendingLeaseOutcome=history.filter(r=>{
    // Already has a lease outcome â€” skip
    if(LEASE_OUTCOME_STATUSES.includes(r.Status))return false;
    // Still in active review â€” skip
    if(ACTIVE_REVIEW_STATUSES.includes(r.Status))return false;
    // Directly approved or override approved
    const isApprovedRecord=r.Status===WF.APPROVED||r.Status===WF.OVERRIDE_APPROVED;
    // Denied at original but approved at alt AMI
    const isAltApproved=r.AltResult==="Approved"&&(r.Status===WF.DENIED||r.Status===WF.FINAL_DENIED||r.Status===WF.APPROVED||r.Status===WF.OVERRIDE_APPROVED);
    // Final denied with no alt approval â€” flat denial, may convert to market
    const isFlatDenial=r.Status===WF.FINAL_DENIED&&r.AltResult!=="Approved";
    if(!isApprovedRecord&&!isAltApproved&&!isFlatDenial)return false;
    // Role check
    if(!isManagerRole&&!isAdmin&&!isApprover)return false;
    if(managerProps)return managerProps.includes(r.Property);
    return true;
  });
  if(loading)return<Card><div style={{textAlign:"center",color:B.teal300,padding:"20px",fontSize:"12px"}}>Loading review queue...</div></Card>;
  const renderItem=(r,isRegional,isSentBack,isLeaseOutcomeItem)=>{
    const isSel=selected===r._itemId;const wf=WF_COLORS[r.Status]||WF_COLORS[WF.SUBMITTED];
    let attachments=[];try{attachments=JSON.parse(r.AttachmentURLs||"[]")}catch{}
    // Review items (pending approver, regional, sent back) â†’ click to open in form
    // Lease outcome items â†’ click to expand inline
    const handleCardClick=()=>{
      if(isLeaseOutcomeItem){setSelected(isSel?null:r._itemId)}
      else{onReviewSelect(r,isRegional?"regional":"approver")}
    };
    return(
      <Card key={r._itemId} className="queue-card" style={{marginBottom:"10px",borderLeftColor:wf.fg,cursor:"pointer"}} onClick={handleCardClick}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
          <div style={{flex:1}}>
            <div style={{display:"flex",alignItems:"center",gap:"8px",marginBottom:"4px"}}>
              <StatusBadge status={r.Status}/>
              <span style={{fontSize:"13px",fontWeight:700,color:B.white}}>{r.ApplicantName||"Unknown"}</span>
              <span style={{fontSize:"11px",color:B.teal300}}>{r.Property} {r.UnitAddress&&`#${r.UnitAddress}`}</span>
            </div>
            <div style={{display:"flex",gap:"16px",fontSize:"10px",color:B.gray400,flexWrap:"wrap"}}>
              <span>Submitted: {r.DateCompleted?new Date(r.DateCompleted).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"â€”"}</span>
              <span>By: {r.SubmittedByName||r.Reviewer||"â€”"}</span>
              <span>AMI: {r.AMITier?`${(+r.AMITier*100).toFixed(0)}%`:"â€”"}</span>
              <span>Occ: {r.Occupants||"â€”"}{r.EffectivePersons&&r.EffectivePersons!==r.Occupants?` (Eff: ${r.EffectivePersons})`:""}</span>
              <span>Income: ${(+r.TotalIncome||0).toLocaleString()}</span>
              <span>Limit: ${(+r.IncomeLimit||0).toLocaleString()}</span>
              <span>Calc: <b style={{color:r.Result?.includes("Approved")?B.ok:r.Result?.includes("Override")?B.ov:B.no}}>{r.Result?.replace("Denied - ","")?.substring(0,30)||"â€”"}</b>
                {r.AltResult==="Approved"&&<span style={{color:"#4A78B0",fontWeight:700,marginLeft:"4px"}}>| Alt {r.AltAMITier?`${(+r.AltAMITier*100).toFixed(0)}%`:"80%"} âœ“</span>}
              </span>
              {attachments.length>0&&<span>ðŸ“Ž {attachments.length}</span>}
            </div>
          </div>
          <span style={{color:B.gray400,fontSize:"14px"}}>{isLeaseOutcomeItem?(isSel?"â–¼":"â–¶"):"â†’"}</span>
        </div>
        {isSel&&isLeaseOutcomeItem&&(()=>{
          let occDetails=[];try{const snap=JSON.parse(r.FormDataJSON||"{}");occDetails=snap.occupantDetails||[]}catch{}
          return(<div style={{marginTop:"12px",borderTop:`1px solid ${B.teal600}`,paddingTop:"12px"}} onClick={e=>e.stopPropagation()}>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px",marginBottom:"12px"}}>
            <div><div style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",marginBottom:"6px"}}>Verification Details</div>
              <div style={{fontSize:"11px",color:B.gray300,lineHeight:"1.8"}}>
                <div>Property: <b style={{color:B.white}}>{r.Property}</b></div>
                <div>Unit: <b style={{color:B.white}}>{r.UnitAddress||"â€”"}</b> | BR: <b style={{color:B.white}}>{r.Bedrooms}</b> | Occ: <b style={{color:B.white}}>{r.Occupants||"â€”"}</b> | Eff: <b style={{color:B.gold400}}>{r.EffectivePersons||r.Occupants||"â€”"}</b></div>
                <div>AMI: <b style={{color:B.gold400}}>{r.AMITier?`${(+r.AMITier*100).toFixed(0)}%`:"â€”"}</b> | Rent: <b style={{color:B.white}}>${(+r.MonthlyRent||0).toLocaleString()}</b></div>
                {r.FiscalYear&&<div>FY: <b style={{color:B.teal300}}>{r.FiscalYear}</b></div>}
                {r.VerificationNotes&&<div style={{marginTop:"4px"}}>Notes: <i style={{color:B.gray400}}>{r.VerificationNotes}</i></div>}
              </div></div>
            <div><div style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",marginBottom:"6px"}}>Income Breakdown</div>
              <div style={{fontSize:"11px",lineHeight:"1.8"}}>
                <div style={{color:B.gray300}}>Paystubs: <b style={{color:B.white}}>${(+r.PaystubIncome||0).toLocaleString()}</b></div>
                <div style={{color:B.gray300}}>Offer Letters: <b style={{color:B.white}}>${(+r.OfferLetterIncome||0).toLocaleString()}</b></div>
                <div style={{color:B.gray300}}>Bank Statements: <b style={{color:B.white}}>${(+r.BankStatementIncome||0).toLocaleString()}</b></div>
                <div style={{color:B.gray300}}>Other: <b style={{color:B.white}}>${(+r.OtherIncome||0).toLocaleString()}</b></div>
                <div style={{borderTop:`1px solid ${B.teal600}`,paddingTop:"4px",marginTop:"4px",color:B.gold400,fontWeight:700}}>Total: ${(+r.TotalIncome||0).toLocaleString()}</div>
                <div style={{color:B.gray400,fontSize:"10px"}}>Limit: ${(+r.IncomeLimit||0).toLocaleString()} | Variance: ${Math.abs(+r.Variance||0).toLocaleString()}</div>
              </div></div>
          </div>
          {/* OCCUPANT DETAILS TABLE */}
          {occDetails.length>0&&<div style={{marginBottom:"12px"}}>
            <div style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",marginBottom:"6px"}}>Household Occupants ({occDetails.length})</div>
            <table style={{width:"100%",fontSize:"11px",borderCollapse:"collapse"}}>
              <thead><tr style={{borderBottom:`1px solid ${B.teal600}`}}>
                <th style={{padding:"4px 8px",textAlign:"left",color:B.gray400,fontWeight:600,fontSize:"10px",width:"30px"}}>#</th>
                <th style={{padding:"4px 8px",textAlign:"left",color:B.gray400,fontWeight:600,fontSize:"10px"}}>Name</th>
                <th style={{padding:"4px 8px",textAlign:"left",color:B.gray400,fontWeight:600,fontSize:"10px",width:"100px"}}>DOB</th>
                <th style={{padding:"4px 8px",textAlign:"left",color:B.gray400,fontWeight:600,fontSize:"10px",width:"50px"}}>Age</th>
                <th style={{padding:"4px 8px",textAlign:"left",color:B.gray400,fontWeight:600,fontSize:"10px",width:"100px"}}>Relationship</th>
              </tr></thead>
              <tbody>{occDetails.map((o,i)=>{
                const age=o.dob?Math.floor((new Date()-new Date(o.dob+"T12:00:00"))/(365.25*86400000)):"â€”";
                return<tr key={i} style={{borderBottom:`1px solid ${B.teal700}`}}>
                  <td style={{padding:"3px 8px",color:B.gray500}}>{i+1}</td>
                  <td style={{padding:"3px 8px",color:B.white,fontWeight:600}}>{o.name||"â€”"}</td>
                  <td style={{padding:"3px 8px",color:B.gray300}}>{o.dob?new Date(o.dob+"T12:00:00").toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}):"â€”"}</td>
                  <td style={{padding:"3px 8px",color:typeof age==="number"&&age<18?B.gold400:B.gray300,fontWeight:typeof age==="number"&&age<18?700:400}}>{age}{typeof age==="number"&&age<18?" â˜…":""}</td>
                  <td style={{padding:"3px 8px",color:B.gray300}}>{o.relationship||"â€”"}</td>
                </tr>})}</tbody>
            </table>
          </div>}
          <AttachmentList attachments={attachments}/>
          {r.AltResult&&<div style={{background:B.wBg,border:`1px solid ${B.wBr}`,borderRadius:"4px",padding:"6px 10px",marginTop:"8px",fontSize:"11px"}}><span style={{color:B.gold500,fontWeight:700}}>Alt AMI (80%): </span><span style={{color:r.AltResult==="Approved"?B.ok:B.no,fontWeight:600}}>{r.AltResult}</span></div>}
          {r.ReviewedByName&&<div style={{background:B.teal50,borderRadius:"4px",padding:"8px 10px",marginTop:"8px",fontSize:"11px",border:`1px solid ${B.teal600}`}}><div style={{color:B.teal300,fontWeight:700,fontSize:"10px",textTransform:"uppercase",marginBottom:"4px"}}>Approver Review</div><div style={{color:B.gray300}}>By: <b style={{color:B.white}}>{r.ReviewedByName}</b> on {r.ReviewDate?new Date(r.ReviewDate).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"â€”"}</div>{r.ReviewNotes&&<div style={{color:B.gray400,fontStyle:"italic",marginTop:"2px"}}>{r.ReviewNotes}</div>}</div>}
          {/* SENT BACK INFO â€” show reason if this was sent back */}
          {r.SentBackReason&&<div style={{background:"rgba(230,140,50,0.08)",border:"1px solid rgba(230,140,50,0.3)",borderRadius:"4px",padding:"8px 10px",marginTop:"8px",fontSize:"11px"}}><div style={{color:"#E68C32",fontWeight:700,fontSize:"10px",textTransform:"uppercase",marginBottom:"4px"}}>â†© Sent Back</div><div style={{color:B.gray300}}>By: <b style={{color:B.white}}>{r.SentBackByName||"â€”"}</b> on {r.SentBackDate?new Date(r.SentBackDate).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"â€”"}</div><div style={{color:"#E68C32",fontWeight:600,marginTop:"2px"}}>Reason: {r.SentBackReason}</div></div>}
          {/* ACTION HINT â€” review items open in form */}
          {!isLeaseOutcomeItem&&!isSentBack&&(r.Status===WF.SUBMITTED||r.Status===WF.UNDER_REVIEW||r.Status===WF.DENIED||r.Status===WF.REGIONAL_REVIEW)&&(
            <div style={{marginTop:"8px",textAlign:"center",fontSize:"11px",color:B.gold400,fontWeight:600}}>Click to open in calculator for full review â†’</div>
          )}
          {/* SENT BACK â€” submitter can reload to edit and resubmit */}
          {isSentBack&&(
            <div style={{marginTop:"12px",borderTop:`1px solid ${B.teal600}`,paddingTop:"12px",textAlign:"center"}}>
              <div style={{fontSize:"11px",color:"#E68C32",marginBottom:"8px",fontWeight:600}}>Click to load into calculator, make corrections, and resubmit.</div>
            </div>)}
          {/* LEASE OUTCOME â€” managers set final disposition on approved/denied records */}
          {(isManagerRole||isAdmin||isApprover)&&(r.Status===WF.APPROVED||r.Status===WF.OVERRIDE_APPROVED||(r.AltResult==="Approved"&&(r.Status===WF.DENIED||r.Status===WF.FINAL_DENIED))||(r.Status===WF.FINAL_DENIED&&r.AltResult!=="Approved"))&&(
            <div style={{marginTop:"12px",borderTop:`1px solid ${B.teal600}`,paddingTop:"12px"}}>
              {/* APPROVAL STATUS BANNER */}
              {(()=>{
                const isDirectApproved=r.Status===WF.APPROVED;
                const isOverride=r.Status===WF.OVERRIDE_APPROVED;
                const isDeniedOriginal=r.Status===WF.DENIED||r.Status===WF.FINAL_DENIED;
                const isAltApproved=r.AltResult==="Approved";
                const isFlatDenial=r.Status===WF.FINAL_DENIED&&!isAltApproved;
                return(<div style={{display:"flex",gap:"8px",marginBottom:"10px",flexWrap:"wrap"}}>
                  {isDirectApproved&&<div style={{background:"rgba(61,160,107,0.12)",border:"1px solid rgba(61,160,107,0.4)",borderRadius:"4px",padding:"6px 10px",fontSize:"11px"}}>
                    <span style={{fontWeight:700,color:B.ok}}>âœ“ Approved</span>
                    <span style={{color:B.gray300,marginLeft:"6px"}}>at {r.AMITier?`${(+r.AMITier*100).toFixed(0)}%`:"â€”"} AMI</span>
                  </div>}
                  {isOverride&&<div style={{background:"rgba(106,142,200,0.12)",border:"1px solid rgba(106,142,200,0.4)",borderRadius:"4px",padding:"6px 10px",fontSize:"11px"}}>
                    <span style={{fontWeight:700,color:B.ov}}>âš– Override Approved</span>
                    <span style={{color:B.gray300,marginLeft:"6px"}}>at {r.AMITier?`${(+r.AMITier*100).toFixed(0)}%`:"â€”"} AMI</span>
                  </div>}
                  {isDeniedOriginal&&<div style={{background:"rgba(211,91,75,0.08)",border:"1px solid rgba(211,91,75,0.3)",borderRadius:"4px",padding:"6px 10px",fontSize:"11px"}}>
                    <span style={{fontWeight:700,color:B.no}}>âœ— {isFlatDenial?"Final Denied":"Denied"} at {r.AMITier?`${(+r.AMITier*100).toFixed(0)}%`:"â€”"} AMI</span>
                  </div>}
                  {isAltApproved&&<div style={{background:"rgba(74,120,176,0.15)",border:"1px solid rgba(74,120,176,0.5)",borderRadius:"4px",padding:"6px 10px",fontSize:"11px"}}>
                    <span style={{fontWeight:700,color:"#4A78B0"}}>âœ“ Approved at Alt AMI</span>
                    <span style={{color:B.gray300,marginLeft:"6px"}}>{r.AltAMITier?`${(+r.AltAMITier*100).toFixed(0)}%`:"80%"}</span>
                  </div>}
                  {r.AltResult&&!isAltApproved&&<div style={{background:"rgba(211,91,75,0.06)",border:"1px solid rgba(211,91,75,0.2)",borderRadius:"4px",padding:"6px 10px",fontSize:"11px"}}>
                    <span style={{fontWeight:700,color:B.no}}>âœ— Denied at Alt AMI</span>
                    <span style={{color:B.gray400,marginLeft:"6px"}}>{r.AltAMITier?`${(+r.AltAMITier*100).toFixed(0)}%`:"80%"}</span>
                  </div>}
                </div>);
              })()}
              <div style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",marginBottom:"8px"}}>Lease Outcome</div>
              {(()=>{
                const deniedOriginal=r.Status===WF.DENIED||r.Status===WF.FINAL_DENIED;
                const altApproved=r.AltResult==="Approved";
                const isFlatDenial=r.Status===WF.FINAL_DENIED&&!altApproved;
                const origTier=r.AMITier?`${(+r.AMITier*100).toFixed(0)}%`:"â€”";
                const altTier=r.AltAMITier?`${(+r.AltAMITier*100).toFixed(0)}%`:"80%";
                return(<div style={{display:"flex",gap:"6px",flexWrap:"wrap"}}>
                  {/* Approved at original â€” can lease at original tier */}
                  {!deniedOriginal&&<Btn v="success" onClick={()=>onLeaseOutcome(r._itemId,WF.LEASED,origTier)} disabled={acting}>âœ“ Leased at {origTier} AMI</Btn>}
                  {/* Alt approved â€” can lease at alt tier */}
                  {altApproved&&<Btn v={deniedOriginal?"success":"primary"} onClick={()=>onLeaseOutcome(r._itemId,deniedOriginal?WF.LEASED:WF.TRANSFERRED_ALT,altTier)} disabled={acting}>{deniedOriginal?"âœ“":"â†—"} Leased at {altTier} AMI</Btn>}
                  {/* Everyone gets market/refused/canceled */}
                  <Btn v="neutral" onClick={()=>onLeaseOutcome(r._itemId,WF.TRANSFERRED_MARKET,"")} disabled={acting}>â†— Transferred to Market</Btn>
                  <Btn v="sendback" onClick={()=>onLeaseOutcome(r._itemId,WF.REFUSED,"")} disabled={acting}>âœ‹ Refused</Btn>
                  <Btn v="danger" onClick={()=>onLeaseOutcome(r._itemId,WF.CANCELED,"")} disabled={acting}>âœ— Canceled</Btn>
                </div>);
              })()}
            </div>)}
        </div>)})()}
      </Card>);
  };
  return(<div>
    {/* SENT BACK TO ME */}
    {sentBackToMe.length>0&&<><div style={{...sCss,color:"#E68C32",fontSize:"12px",marginBottom:"8px",borderBottomColor:"#E68C32"}}>â†© Sent Back to You ({sentBackToMe.length})</div>
      {sentBackToMe.map(r=>renderItem(r,false,true,false))}</>}
    {isApprover&&<><div style={{...sCss,color:B.gold500,fontSize:"12px",marginBottom:"8px",marginTop:sentBackToMe.length>0?"16px":"0"}}>Pending Approver Review ({pendingApprover.length})</div>
      {pendingApprover.length===0?<Card style={{marginBottom:"16px"}}><div style={{textAlign:"center",color:B.gray400,padding:"12px",fontSize:"12px"}}>No submissions awaiting review.</div></Card>
      :pendingApprover.map(r=>renderItem(r,false,false,false))}</>}
    {isAdmin&&<><div style={{...sCss,color:B.purple,fontSize:"12px",marginTop:"16px",marginBottom:"8px",borderBottomColor:B.purple}}>Pending Regional Review ({pendingRegional.length})</div>
      {pendingRegional.length===0?<Card><div style={{textAlign:"center",color:B.gray400,padding:"12px",fontSize:"12px"}}>No denied submissions awaiting regional review.</div></Card>
      :pendingRegional.map(r=>renderItem(r,true,false,false))}</>}
    {!isApprover&&!isAdmin&&!isManagerRole&&sentBackToMe.length===0&&<Card><div style={{textAlign:"center",color:B.gray400,padding:"20px",fontSize:"12px"}}>No items in your review queue.</div></Card>}
    {/* PENDING LEASE OUTCOME â€” managers set final disposition */}
    {(isManagerRole||isAdmin)&&<><div style={{...sCss,color:"#2D8A5B",fontSize:"12px",marginTop:"16px",marginBottom:"8px",borderBottomColor:"#2D8A5B"}}>Pending Lease Outcome ({pendingLeaseOutcome.length})</div>
      {pendingLeaseOutcome.length===0?<Card><div style={{textAlign:"center",color:B.gray400,padding:"12px",fontSize:"12px"}}>No submissions awaiting lease outcome.</div></Card>
      :pendingLeaseOutcome.map(r=>renderItem(r,false,false,true))}</>}
    {/* COMPLETED LEASE OUTCOMES â€” admin can reset if marked incorrectly */}
    {isAdmin&&(()=>{
      const completed=history.filter(r=>LEASE_OUTCOME_STATUSES.includes(r.Status));
      if(completed.length===0)return null;
      return<><div style={{...sCss,color:B.gray400,fontSize:"12px",marginTop:"16px",marginBottom:"8px",borderBottomColor:B.gray500,cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center"}} onClick={()=>setShowCompleted(!showCompleted)}>
        <span>{showCompleted?"â–¼":"â–¶"} Completed Lease Outcomes ({completed.length})</span>
        <span style={{fontSize:"10px",color:B.gray500,fontWeight:400}}>{showCompleted?"click to collapse":"click to expand"}</span>
      </div>
      {showCompleted&&completed.map(r=>{const wf=WF_COLORS[r.Status]||WF_COLORS[WF.SUBMITTED];
        return<Card key={r._itemId} style={{marginBottom:"8px",opacity:0.85}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div style={{flex:1}}>
              <div style={{display:"flex",alignItems:"center",gap:"8px",marginBottom:"4px"}}>
                <span style={{fontSize:"13px",fontWeight:700,color:B.white}}>{r.ApplicantName||"â€”"}</span>
                <span style={{fontSize:"10px",padding:"2px 6px",borderRadius:"3px",background:wf.bg,border:`1px solid ${wf.br}`,color:wf.fg,fontWeight:600}}>{r.Status}</span>
                {r.LeaseOutcomeTier&&<span style={{fontSize:"10px",color:B.gold400,fontWeight:600}}>{r.LeaseOutcomeTier} AMI</span>}
              </div>
              <div style={{fontSize:"11px",color:B.gray400}}>
                {r.Property} #{r.UnitAddress||"â€”"} | Set by {r.LeaseOutcomeByName||"â€”"} on {r.LeaseOutcomeDate?new Date(r.LeaseOutcomeDate).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"-"}
              </div>
            </div>
            <Btn v="neutral" onClick={()=>onResetOutcome(r._itemId,r)} disabled={acting} style={{padding:"4px 10px",fontSize:"10px"}}>â†© Reset</Btn>
          </div>
        </Card>})}</>
    })()}
  </div>);
}

// HISTORY PANEL â€” clickable rows
function HistoryPanel({history,loading,onSelect,userRoles,isAdmin,onDelete,properties}){
  const[filter,setFilter]=useState("all");
  const[propFilter,setPropFilter]=useState("all");
  if(loading)return<Card><div style={{textAlign:"center",color:B.teal300,padding:"20px",fontSize:"12px"}}>Loading history...</div></Card>;
  if(!history?.length)return<Card><div style={{textAlign:"center",color:B.gray400,padding:"20px",fontSize:"12px"}}>No verifications submitted yet.</div></Card>;
  const propNames=(properties||[]).map(p=>p.name).sort();
  const filtered=history.filter(r=>(filter==="all"||r.Status===filter)&&(propFilter==="all"||r.Property===propFilter));
  return(
    <Card style={{maxHeight:"600px",overflowY:"auto"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px",flexWrap:"wrap",gap:"6px"}}>
        <div style={{display:"flex",alignItems:"center",gap:"10px",flexWrap:"wrap"}}>
          <div style={sCss}>Verification History ({filtered.length})<span style={{fontWeight:400,textTransform:"none",fontSize:"10px",color:B.teal300,marginLeft:"8px"}}>Click a row to reload</span></div>
          <select value={propFilter} onChange={e=>setPropFilter(e.target.value)} style={{background:"#FFFFFF",border:`1px solid ${B.teal600}`,borderRadius:"4px",color:B.teal700,padding:"4px 8px",fontSize:"10px",fontWeight:600,fontFamily:fb,cursor:"pointer",minWidth:"160px"}}><option value="all">All Properties</option>{propNames.map(p=><option key={p} value={p}>{p}</option>)}</select>
        </div>
        <div style={{display:"flex",gap:"3px",flexWrap:"wrap"}}>{["all",...Object.values(WF)].map(s=><button key={s} onClick={()=>setFilter(s)} style={{background:filter===s?`${B.gold500}18`:"transparent",border:`1px solid ${filter===s?B.gold500:B.teal600}`,color:filter===s?B.gold500:B.gray400,padding:"2px 6px",fontSize:"9px",fontWeight:700,cursor:"pointer",borderRadius:"3px",fontFamily:fb}}>{s==="all"?"All":s}</button>)}</div>
      </div>
      <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}>
        <thead><tr style={{borderBottom:`1px solid ${B.teal600}`}}>
          {["Date","Submitter","Property","Unit","Applicant","AMI","Income","Status","Result",isAdmin?"":""].filter(Boolean).map(h=><th key={h} style={{padding:"5px 4px",textAlign:"left",color:B.teal300,fontWeight:700,fontSize:"9px",textTransform:"uppercase",letterSpacing:"0.5px"}}>{h}</th>)}
        </tr></thead>
        <tbody>{filtered.map((r,i)=>{
          return(<tr key={i} className="hist-row" onClick={()=>onSelect(r)} style={{borderBottom:`1px solid ${B.teal600}22`,background:i%2===0?"transparent":`${B.teal700}66`}}>
            <td style={{padding:"5px 4px",color:B.teal300,fontFamily:fm,fontSize:"10px"}}>{r.DateCompleted?new Date(r.DateCompleted).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"â€”"}</td>
            <td style={{padding:"5px 4px",color:B.white,fontSize:"10px"}}>{r.SubmittedByName||r.Reviewer||"â€”"}</td>
            <td style={{padding:"5px 4px",color:B.white}}>{r.Property||"â€”"}</td>
            <td style={{padding:"5px 4px",color:B.teal300,fontFamily:fm}}>{r.UnitAddress||"â€”"}</td>
            <td style={{padding:"5px 4px",color:B.white}}>{r.ApplicantName||"â€”"}</td>
            <td style={{padding:"5px 4px",color:B.teal300,textAlign:"center"}}>{r.AMITier?`${(+r.AMITier*100).toFixed(0)}%`:"â€”"}</td>
            <td style={{padding:"5px 4px",fontFamily:fm,textAlign:"right",color:B.white}}>{r.TotalIncome?`$${(+r.TotalIncome).toLocaleString()}`:"â€”"}</td>
            <td style={{padding:"5px 4px"}}><StatusBadge status={r.Status||"Approved"}/></td>
            <td style={{padding:"5px 4px",fontSize:"10px",color:r.Result?.includes("Approved")?B.ok:r.Result?.includes("Denied")?B.no:B.gray400}}>{r.Result?.substring(0,25)||"â€”"}</td>
            {isAdmin&&<td style={{padding:"5px 4px",textAlign:"center"}}><button onClick={e=>{e.stopPropagation();onDelete(r._itemId,`${r.Property} - ${r.ApplicantName} (${r.DateCompleted?.slice(0,10)||"no date"})`)}} style={{background:"transparent",border:"none",color:B.no,cursor:"pointer",fontSize:"12px",opacity:0.5}} title="Delete record">ðŸ—‘</button></td>}
          </tr>);
        })}</tbody>
      </table>
    </Card>
  );
}


// ============================================================
// DASHBOARD â€” Performance metrics computed from history data
// ============================================================
function Dashboard({history,properties}){
  if(!history?.length)return<Card><div style={{textAlign:"center",color:B.gray400,padding:"20px",fontSize:"12px"}}>No verification data available for dashboard. Submit verifications to see metrics.</div></Card>;

  // Compute metrics
  const total=history.length;
  const approvedInit=history.filter(r=>r.Result==="Approved").length;
  const deniedInit=history.filter(r=>r.Result&&r.Result.startsWith("Denied")).length;
  const overrides=history.filter(r=>r.Result?.includes("Override")).length;
  const approvalRateInit=total?approvedInit/total:0;
  const recoveredAlt=history.filter(r=>r.AltResult==="Approved").length;
  const finalApproved=approvedInit+recoveredAlt+overrides;
  const finalRate=total?finalApproved/total:0;
  const deniedOver=history.filter(r=>r.DenialReason?.includes("Exceeds")).length;
  const deniedBelow=history.filter(r=>r.DenialReason?.includes("Below")).length;

  // By property
  const propNames=[...new Set(history.map(r=>r.Property).filter(Boolean))];
  const byProp=propNames.map(name=>{
    const recs=history.filter(r=>r.Property===name);
    const app=recs.filter(r=>r.Result==="Approved").length;
    const recov=recs.filter(r=>r.AltResult==="Approved").length;
    const ovr=recs.filter(r=>r.Result?.includes("Override")).length;
    const fin=app+recov+ovr;
    return{name,total:recs.length,approved:app,recovered:recov,overrides:ovr,denied:recs.length-fin,rate:recs.length?fin/recs.length:0};
  }).sort((a,b)=>b.total-a.total);

  // By AMI tier
  const tiers=[...new Set(history.map(r=>r.AMITier).filter(Boolean))].sort();
  const byTier=tiers.map(tier=>{
    const recs=history.filter(r=>r.AMITier===tier||+r.AMITier===+tier);
    const app=recs.filter(r=>r.Result==="Approved").length;
    const over=recs.filter(r=>r.DenialReason?.includes("Exceeds")).length;
    const below=recs.filter(r=>r.DenialReason?.includes("Below")).length;
    return{tier:+tier,total:recs.length,approved:app,rate:recs.length?app/recs.length:0,overIncome:over,belowMin:below};
  });

  // Alt AMI recovery
  const sentToAlt=history.filter(r=>r.AltAMITier||r.AltResult).length;
  const stillDenied=sentToAlt-recoveredAlt;

  // By county (via propertyâ†’county lookup)
  const propCountyMap={};
  properties.forEach(p=>{if(p.county)propCountyMap[p.name]=p.county});
  const countyNames=[...new Set(history.map(r=>propCountyMap[r.Property]).filter(Boolean))];
  const byCounty=countyNames.map(county=>{
    const recs=history.filter(r=>propCountyMap[r.Property]===county);
    const app=recs.filter(r=>r.Result==="Approved").length;
    const recov=recs.filter(r=>r.AltResult==="Approved").length;
    const ovr=recs.filter(r=>r.Result?.includes("Override")).length;
    const fin=app+recov+ovr;
    return{county,total:recs.length,approved:app,recovered:recov,overrides:ovr,denied:recs.length-fin,rate:recs.length?fin/recs.length:0};
  }).sort((a,b)=>b.total-a.total);

  const pct=(v)=>`${(v*100).toFixed(1)}%`;
  const kpiBox=(label,value,sub,clr)=>(<div style={{background:"#FFFFFF",border:`1px solid ${B.teal600}`,borderRadius:"6px",padding:"12px 14px",textAlign:"center",flex:1,minWidth:"120px",boxShadow:"0 1px 3px rgba(28,55,64,0.06)"}}>
    <div style={{fontSize:"22px",fontWeight:900,color:clr||B.gold400,fontFamily:fm}}>{value}</div>
    <div style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px",marginTop:"2px"}}>{label}</div>
    {sub&&<div style={{fontSize:"9px",color:B.gray400,marginTop:"2px"}}>{sub}</div>}
  </div>);
  const tblHd=(text)=>({padding:"6px 8px",textAlign:"left",color:B.gold500,fontWeight:700,fontSize:"10px",fontFamily:fb,textTransform:"uppercase",borderBottom:`2px solid ${B.gold500}`});
  const tblTd=(align)=>({padding:"5px 8px",borderBottom:`1px solid ${B.teal600}22`,fontSize:"11px",textAlign:align||"left"});

  return(
    <div>
      {/* KPI ROW */}
      <div style={{display:"flex",gap:"8px",marginBottom:"12px",flexWrap:"wrap"}}>
        {kpiBox("Total Verifications",total)}
        {kpiBox("Approved (Initial)",approvedInit,pct(approvalRateInit),B.ok)}
        {kpiBox("Denied (Initial)",deniedInit,null,B.no)}
        {kpiBox("Recovered at Alt AMI",recoveredAlt)}
        {kpiBox("Overrides",overrides,null,B.ov)}
        {kpiBox("Final Approval Rate",pct(finalRate),`${finalApproved} of ${total}`,finalRate>=0.6?B.ok:B.no)}
        {kpiBox("Denied: Over Income",deniedOver,null,B.no)}
        {kpiBox("Denied: Below Min",deniedBelow,null,B.no)}
      </div>
      {/* LEASE OUTCOME STATS */}
      {(()=>{
        const OUTCOME_STATUSES=[WF.LEASED,WF.TRANSFERRED_ALT,WF.TRANSFERRED_MARKET,WF.REFUSED,WF.CANCELED];
        const leased=history.filter(r=>r.Status===WF.LEASED).length;
        const transAlt=history.filter(r=>r.Status===WF.TRANSFERRED_ALT).length;
        const transMkt=history.filter(r=>r.Status===WF.TRANSFERRED_MARKET).length;
        const refused=history.filter(r=>r.Status===WF.REFUSED).length;
        const canceled=history.filter(r=>r.Status===WF.CANCELED).length;
        const totalOutcomes=leased+transAlt+transMkt+refused+canceled;
        // Pending includes approved, override approved, alt-approved denials, AND flat final denials
        const pendingOutcome=history.filter(r=>{
          if(OUTCOME_STATUSES.includes(r.Status))return false;
          if([WF.SUBMITTED,WF.UNDER_REVIEW,WF.SENT_BACK,WF.REGIONAL_REVIEW].includes(r.Status))return false;
          return r.Status===WF.APPROVED||r.Status===WF.OVERRIDE_APPROVED||(r.AltResult==="Approved"&&(r.Status===WF.DENIED||r.Status===WF.FINAL_DENIED))||(r.Status===WF.FINAL_DENIED&&r.AltResult!=="Approved");
        }).length;
        if(totalOutcomes===0&&pendingOutcome===0)return null;
        return(<>
        <div style={{...sCss,marginTop:"16px"}}>Lease Outcomes</div>
        <div style={{display:"flex",gap:"10px",flexWrap:"wrap",marginBottom:"14px"}}>
          {kpiBox("Leased at AMI",leased,totalOutcomes?pct(leased/totalOutcomes):"â€”","#2D8A5B")}
          {kpiBox("Transferred Alt AMI",transAlt,totalOutcomes?pct(transAlt/totalOutcomes):"â€”","#4A78B0")}
          {kpiBox("Transferred Market",transMkt,totalOutcomes?pct(transMkt/totalOutcomes):"â€”","#888")}
          {kpiBox("Refused",refused,totalOutcomes?pct(refused/totalOutcomes):"â€”","#C47A20")}
          {kpiBox("Canceled",canceled,totalOutcomes?pct(canceled/totalOutcomes):"â€”",B.no)}
          {kpiBox("Pending Outcome",pendingOutcome,null,B.gold500)}
        </div>
        {totalOutcomes>0&&<div style={{marginBottom:"14px"}}>
          <div style={{display:"flex",height:"20px",borderRadius:"4px",overflow:"hidden",border:`1px solid ${B.teal600}`}}>
            {leased>0&&<div style={{width:pct(leased/totalOutcomes),background:"#2D8A5B",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"9px",fontWeight:700,color:"#fff"}}>{leased}</div>}
            {transAlt>0&&<div style={{width:pct(transAlt/totalOutcomes),background:"#4A78B0",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"9px",fontWeight:700,color:"#fff"}}>{transAlt}</div>}
            {transMkt>0&&<div style={{width:pct(transMkt/totalOutcomes),background:"#888",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"9px",fontWeight:700,color:"#fff"}}>{transMkt}</div>}
            {refused>0&&<div style={{width:pct(refused/totalOutcomes),background:"#C47A20",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"9px",fontWeight:700,color:"#fff"}}>{refused}</div>}
            {canceled>0&&<div style={{width:pct(canceled/totalOutcomes),background:B.no,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"9px",fontWeight:700,color:"#fff"}}>{canceled}</div>}
          </div>
          <div style={{display:"flex",gap:"12px",marginTop:"4px",fontSize:"9px",color:B.gray400}}>
            <span><span style={{display:"inline-block",width:"8px",height:"8px",borderRadius:"2px",background:"#2D8A5B",marginRight:"3px",verticalAlign:"middle"}}/> Leased</span>
            <span><span style={{display:"inline-block",width:"8px",height:"8px",borderRadius:"2px",background:"#4A78B0",marginRight:"3px",verticalAlign:"middle"}}/> Alt AMI</span>
            <span><span style={{display:"inline-block",width:"8px",height:"8px",borderRadius:"2px",background:"#888",marginRight:"3px",verticalAlign:"middle"}}/> Market</span>
            <span><span style={{display:"inline-block",width:"8px",height:"8px",borderRadius:"2px",background:"#C47A20",marginRight:"3px",verticalAlign:"middle"}}/> Refused</span>
            <span><span style={{display:"inline-block",width:"8px",height:"8px",borderRadius:"2px",background:B.no,marginRight:"3px",verticalAlign:"middle"}}/> Canceled</span>
          </div>
        </div>}
        {/* APPROVAL STATUS â†’ CONVERSION TABLE */}
        {(()=>{
          // Categorize each record with a lease outcome by its approval path
          const withOutcome=history.filter(r=>OUTCOME_STATUSES.includes(r.Status));
          if(withOutcome.length===0)return null;
          const cats=[
            {label:"Approved",color:B.ok,filter:r=>!r.OverrideBy&&r.Result&&!r.Result.startsWith("Denied")},
            {label:"Override Approved",color:B.ov,filter:r=>!!r.OverrideBy},
            {label:"Alt AMI Approved",color:"#4A78B0",filter:r=>r.AltResult==="Approved"&&r.Result?.startsWith("Denied")&&!r.OverrideBy},
            {label:"Final Denied",color:B.no,filter:r=>r.AltResult!=="Approved"&&!r.OverrideBy&&r.Result?.startsWith("Denied")},
          ];
          const rows=cats.map(c=>{
            const recs=withOutcome.filter(c.filter);
            return{...c,total:recs.length,
              leased:recs.filter(r=>r.Status===WF.LEASED).length,
              transAlt:recs.filter(r=>r.Status===WF.TRANSFERRED_ALT).length,
              transMkt:recs.filter(r=>r.Status===WF.TRANSFERRED_MARKET).length,
              refused:recs.filter(r=>r.Status===WF.REFUSED).length,
              canceled:recs.filter(r=>r.Status===WF.CANCELED).length,
            };
          }).filter(r=>r.total>0);
          if(rows.length===0)return null;
          const hd={padding:"6px 8px",textAlign:"center",color:B.gold500,fontWeight:700,fontSize:"10px",fontFamily:fb,textTransform:"uppercase",borderBottom:`2px solid ${B.gold500}`};
          const td=(align)=>({padding:"5px 8px",borderBottom:`1px solid ${B.teal600}22`,fontSize:"11px",textAlign:align||"center",fontFamily:fm});
          return<div style={{marginBottom:"14px"}}>
            <div style={{...sCss,marginBottom:"8px"}}>Approval Status â†’ Conversion</div>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}><thead><tr>
              <th style={{...hd,textAlign:"left"}}>Status</th>
              <th style={hd}>Total</th>
              <th style={hd}>Leased</th>
              <th style={hd}>Alt AMI</th>
              <th style={hd}>Market</th>
              <th style={hd}>Refused</th>
              <th style={hd}>Canceled</th>
              <th style={hd}>Conversion</th>
            </tr></thead><tbody>
              {rows.map((row,i)=>{
                const converted=row.leased+row.transAlt;
                const rate=row.total>0?converted/row.total:0;
                return<tr key={i}>
                  <td style={{...td("left"),fontWeight:700,color:row.color}}>{row.label}</td>
                  <td style={td()}>{row.total}</td>
                  <td style={{...td(),color:"#2D8A5B",fontWeight:row.leased?700:400}}>{row.leased||"â€”"}</td>
                  <td style={{...td(),color:"#4A78B0",fontWeight:row.transAlt?700:400}}>{row.transAlt||"â€”"}</td>
                  <td style={{...td(),color:"#888",fontWeight:row.transMkt?700:400}}>{row.transMkt||"â€”"}</td>
                  <td style={{...td(),color:"#C47A20",fontWeight:row.refused?700:400}}>{row.refused||"â€”"}</td>
                  <td style={{...td(),color:B.no,fontWeight:row.canceled?700:400}}>{row.canceled||"â€”"}</td>
                  <td style={{...td(),fontWeight:700,color:rate>=0.5?B.ok:rate>0?B.gold400:B.gray500}}>{row.total>0?pct(rate):"â€”"}</td>
                </tr>})}
              {rows.length>1&&(()=>{
                const totR={total:rows.reduce((s,r)=>s+r.total,0),leased:rows.reduce((s,r)=>s+r.leased,0),transAlt:rows.reduce((s,r)=>s+r.transAlt,0),transMkt:rows.reduce((s,r)=>s+r.transMkt,0),refused:rows.reduce((s,r)=>s+r.refused,0),canceled:rows.reduce((s,r)=>s+r.canceled,0)};
                const totConv=(totR.leased+totR.transAlt)/totR.total;
                return<tr style={{borderTop:`2px solid ${B.gold500}`}}>
                  <td style={{...td("left"),fontWeight:800,color:B.gold400}}>Total</td>
                  <td style={{...td(),fontWeight:800}}>{totR.total}</td>
                  <td style={{...td(),fontWeight:800,color:"#2D8A5B"}}>{totR.leased||"â€”"}</td>
                  <td style={{...td(),fontWeight:800,color:"#4A78B0"}}>{totR.transAlt||"â€”"}</td>
                  <td style={{...td(),fontWeight:800,color:"#888"}}>{totR.transMkt||"â€”"}</td>
                  <td style={{...td(),fontWeight:800,color:"#C47A20"}}>{totR.refused||"â€”"}</td>
                  <td style={{...td(),fontWeight:800,color:B.no}}>{totR.canceled||"â€”"}</td>
                  <td style={{...td(),fontWeight:800,color:totConv>=0.5?B.ok:B.gold400}}>{pct(totConv)}</td>
                </tr>})()}
            </tbody></table>
            <div style={{fontSize:"9px",color:B.gray500,marginTop:"4px",fontStyle:"italic"}}>Conversion = Leased at AMI + Transferred to Alt AMI</div>
          </div>;
        })()}
        </>);
      })()}

      {/* BY COUNTY â€” only show if more than 1 county */}
      {byCounty.length>0&&<Card style={{marginBottom:"12px"}}>
        <div style={sCss}>Performance by County</div>
        <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}><thead><tr>
          {["County","Total","Approved","Recovered","Override","Denied","Rate"].map((h,i)=><th key={i} style={tblHd(h)}>{h}</th>)}
        </tr></thead><tbody>
          {byCounty.map((c,i)=><tr key={i}>
            <td style={tblTd()}><span style={{color:B.white,fontWeight:600}}>{c.county}</span></td>
            <td style={tblTd("center")}><span style={{fontFamily:fm}}>{c.total}</span></td>
            <td style={tblTd("center")}><span style={{color:B.ok,fontFamily:fm}}>{c.approved}</span></td>
            <td style={tblTd("center")}><span style={{color:B.gold400,fontFamily:fm}}>{c.recovered}</span></td>
            <td style={tblTd("center")}><span style={{color:B.ov,fontFamily:fm}}>{c.overrides}</span></td>
            <td style={tblTd("center")}><span style={{color:B.no,fontFamily:fm}}>{c.denied}</span></td>
            <td style={tblTd("center")}><span style={{fontWeight:700,color:c.rate>=0.6?B.ok:B.no,fontFamily:fm}}>{pct(c.rate)}</span></td>
          </tr>)}
          {byCounty.length>1&&<tr style={{borderTop:`2px solid ${B.gold500}`}}>
            <td style={{...tblTd(),fontWeight:800,color:B.gold400}}>Total</td>
            <td style={{...tblTd("center"),fontWeight:800,fontFamily:fm}}>{total}</td>
            <td style={{...tblTd("center"),fontWeight:800,color:B.ok,fontFamily:fm}}>{approvedInit}</td>
            <td style={{...tblTd("center"),fontWeight:800,color:B.gold400,fontFamily:fm}}>{recoveredAlt}</td>
            <td style={{...tblTd("center"),fontWeight:800,color:B.ov,fontFamily:fm}}>{overrides}</td>
            <td style={{...tblTd("center"),fontWeight:800,color:B.no,fontFamily:fm}}>{total-finalApproved}</td>
            <td style={{...tblTd("center"),fontWeight:800,color:finalRate>=0.6?B.ok:B.no,fontFamily:fm}}>{pct(finalRate)}</td>
          </tr>}
        </tbody></table>
      </Card>}

      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px",marginBottom:"12px"}}>
        {/* BY PROPERTY */}
        <Card>
          <div style={sCss}>Performance by Property</div>
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}><thead><tr>
            {["Property","Total","Approved","Recovered","Override","Denied","Rate"].map((h,i)=><th key={i} style={tblHd(h)}>{h}</th>)}
          </tr></thead><tbody>
            {byProp.map((p,i)=><tr key={i}>
              <td style={tblTd()}><span style={{color:B.white,fontWeight:600}}>{p.name}</span></td>
              <td style={tblTd("center")}><span style={{fontFamily:fm}}>{p.total}</span></td>
              <td style={tblTd("center")}><span style={{color:B.ok,fontFamily:fm}}>{p.approved}</span></td>
              <td style={tblTd("center")}><span style={{color:B.gold400,fontFamily:fm}}>{p.recovered}</span></td>
              <td style={tblTd("center")}><span style={{color:B.ov,fontFamily:fm}}>{p.overrides}</span></td>
              <td style={tblTd("center")}><span style={{color:B.no,fontFamily:fm}}>{p.denied}</span></td>
              <td style={tblTd("center")}><span style={{fontWeight:700,color:p.rate>=0.6?B.ok:B.no,fontFamily:fm}}>{pct(p.rate)}</span></td>
            </tr>)}
            <tr style={{borderTop:`2px solid ${B.gold500}`}}>
              <td style={{...tblTd(),fontWeight:800,color:B.gold400}}>Total</td>
              <td style={{...tblTd("center"),fontWeight:800,fontFamily:fm}}>{total}</td>
              <td style={{...tblTd("center"),fontWeight:800,color:B.ok,fontFamily:fm}}>{approvedInit}</td>
              <td style={{...tblTd("center"),fontWeight:800,color:B.gold400,fontFamily:fm}}>{recoveredAlt}</td>
              <td style={{...tblTd("center"),fontWeight:800,color:B.ov,fontFamily:fm}}>{overrides}</td>
              <td style={{...tblTd("center"),fontWeight:800,color:B.no,fontFamily:fm}}>{total-finalApproved}</td>
              <td style={{...tblTd("center"),fontWeight:800,color:finalRate>=0.6?B.ok:B.no,fontFamily:fm}}>{pct(finalRate)}</td>
            </tr>
          </tbody></table>
        </Card>

        {/* BY AMI TIER */}
        <Card>
          <div style={sCss}>Performance by AMI Tier</div>
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}><thead><tr>
            {["AMI Tier","Total","Approved","Rate","Over Income","Below Min"].map((h,i)=><th key={i} style={tblHd(h)}>{h}</th>)}
          </tr></thead><tbody>
            {byTier.map((t,i)=><tr key={i}>
              <td style={tblTd()}><span style={{color:B.gold400,fontWeight:700,fontFamily:fm}}>{(t.tier*100).toFixed(0)}%</span></td>
              <td style={tblTd("center")}><span style={{fontFamily:fm}}>{t.total}</span></td>
              <td style={tblTd("center")}><span style={{color:B.ok,fontFamily:fm}}>{t.approved}</span></td>
              <td style={tblTd("center")}><span style={{fontWeight:700,color:t.rate>=0.5?B.ok:B.no,fontFamily:fm}}>{pct(t.rate)}</span></td>
              <td style={tblTd("center")}><span style={{color:B.no,fontFamily:fm}}>{t.overIncome}</span></td>
              <td style={tblTd("center")}><span style={{color:B.no,fontFamily:fm}}>{t.belowMin}</span></td>
            </tr>)}
          </tbody></table>

          {/* ALT AMI RECOVERY */}
          <div style={{...sCss,marginTop:"16px"}}>Alt AMI (80%) Recovery</div>
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}><tbody>
            <tr><td style={tblTd()}>Sent to Alt AMI Review</td><td style={{...tblTd("center"),fontFamily:fm,fontWeight:700}}>{sentToAlt}</td><td style={{...tblTd("right"),color:B.gray400,fontSize:"10px"}}>{total?pct(sentToAlt/total):"-"} of all applicants</td></tr>
            <tr><td style={tblTd()}>Recovered (Approved at 80%)</td><td style={{...tblTd("center"),fontFamily:fm,fontWeight:700,color:B.ok}}>{recoveredAlt}</td><td style={{...tblTd("right"),color:B.gray400,fontSize:"10px"}}>{sentToAlt?pct(recoveredAlt/sentToAlt):"-"} recovery rate</td></tr>
            <tr><td style={tblTd()}>Still Denied at Alt AMI</td><td style={{...tblTd("center"),fontFamily:fm,fontWeight:700,color:B.no}}>{stillDenied}</td><td style={{...tblTd("right"),color:B.gray400,fontSize:"10px"}}>Denied at both tiers</td></tr>
            <tr style={{borderTop:`2px solid ${B.gold500}`}}><td style={{...tblTd(),fontWeight:800,color:B.gold400}}>Final Approval Rate</td><td style={{...tblTd("center"),fontFamily:fm,fontWeight:800,color:finalRate>=0.6?B.ok:B.no}}>{pct(finalRate)}</td><td style={{...tblTd("right"),color:B.gray400,fontSize:"10px"}}>{finalApproved} of {total} applicants</td></tr>
          </tbody></table>
        </Card>
      </div>

      {/* APPROVAL FUNNEL */}
      <Card>
        <div style={sCss}>Approval Funnel</div>
        <div style={{display:"flex",gap:"20px",alignItems:"center",flexWrap:"wrap"}}>
          {[
            {label:"Total Applicants",count:total,color:B.white},
            {label:"â†’ Approved (Initial)",count:approvedInit,color:B.ok},
            {label:"â†’ Recovered at 80%",count:recoveredAlt,color:B.gold400},
            {label:"â†’ Override Approved",count:overrides,color:B.ov},
            {label:"â†’ Final Denied",count:total-finalApproved,color:B.no},
          ].map((s,i)=>(
            <div key={i} style={{textAlign:"center",minWidth:"100px"}}>
              <div style={{fontSize:"24px",fontWeight:900,color:s.color,fontFamily:fm}}>{s.count}</div>
              <div style={{fontSize:"10px",color:B.teal300,fontWeight:600}}>{s.label}</div>
            </div>
          ))}
          <div style={{flex:1,minWidth:"200px"}}>
            <div style={{height:"24px",borderRadius:"4px",overflow:"hidden",display:"flex",background:B.gray100,border:`1px solid ${B.teal600}`}}>
              {total>0&&<><div style={{width:`${approvedInit/total*100}%`,background:B.ok,transition:"width 0.3s"}} title={`Approved: ${approvedInit}`}/>
              <div style={{width:`${recoveredAlt/total*100}%`,background:B.gold500,transition:"width 0.3s"}} title={`Recovered: ${recoveredAlt}`}/>
              <div style={{width:`${overrides/total*100}%`,background:B.ov,transition:"width 0.3s"}} title={`Override: ${overrides}`}/>
              <div style={{width:`${(total-finalApproved)/total*100}%`,background:B.no,transition:"width 0.3s"}} title={`Denied: ${total-finalApproved}`}/></>}
            </div>
            <div style={{display:"flex",gap:"12px",marginTop:"4px",fontSize:"9px"}}>
              <span style={{color:B.ok}}>â–  Approved</span>
              <span style={{color:B.gold500}}>â–  Recovered</span>
              <span style={{color:B.ov}}>â–  Override</span>
              <span style={{color:B.no}}>â–  Denied</span>
            </div>
          </div>
        </div>
      </Card>
    </div>
  );
}

// ============================================================
// ADMIN PANEL â€” Tabs: Income Limits (per county), Properties, Users
// ============================================================
function AdminPanel({counties,properties,users,onSave,saving,lastSaved,isAdmin}){
  const[aTab,setATab]=useState("limits");
  const[cEdit,setCEdit]=useState(JSON.parse(JSON.stringify(counties)));
  const[pEdit,setPEdit]=useState(JSON.parse(JSON.stringify(properties)));
  const[uEdit,setUEdit]=useState(JSON.parse(JSON.stringify(users)));
  const[dirty,setDirty]=useState(false);
  const[selCounty,setSelCounty]=useState(Object.keys(counties)[0]||"");
  const[selFYIdx,setSelFYIdx]=useState(0); // 0 = most recent (active)
  const[newCounty,setNewCounty]=useState("");
  const[newUserEmail,setNewUserEmail]=useState("");
  const[newUserName,setNewUserName]=useState("");
  const[newUserRoles,setNewUserRoles]=useState(["leaser"]);

  useEffect(()=>{setCEdit(JSON.parse(JSON.stringify(counties)))},[counties]);
  useEffect(()=>{setPEdit(JSON.parse(JSON.stringify(properties)))},[properties]);
  useEffect(()=>{setUEdit(JSON.parse(JSON.stringify(users)))},[users]);

  const mk=()=>setDirty(true);
  const save=()=>{onSave(cEdit,pEdit,uEdit);setDirty(false)};
  const countyNames=Object.keys(cEdit);

  // FY-aware county editors
  const curCounty=cEdit[selCounty];
  const curFYs=curCounty?.fiscalYears||[];
  const curFY=curFYs[selFYIdx]||null;
  const isActiveFY=selFYIdx===0; // only the most recent FY is editable

  const updateFYField=(field,val)=>{const next=JSON.parse(JSON.stringify(cEdit));next[selCounty].fiscalYears[selFYIdx][field]=val;setCEdit(next);mk()};
  const updateLim=(ti,pi,val)=>{const next=JSON.parse(JSON.stringify(cEdit));next[selCounty].fiscalYears[selFYIdx].limits[ti][pi]=val===""?0:+val;setCEdit(next);mk()};

  const addFiscalYear=()=>{
    const next=JSON.parse(JSON.stringify(cEdit));
    const fys=next[selCounty].fiscalYears;
    const prev=fys[0]; // copy from most recent
    const currentYear=new Date().getFullYear();
    const newFY={fy:`FY ${currentYear+1}`,medianIncome:prev?.medianIncome||0,tiers:prev?.tiers||[0.3,0.5,0.6,0.8,1.0],personCounts:prev?.personCounts||[1,2,3,4,5,6,7,8],limits:prev?.limits?.map(r=>[...r])||[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]]};
    fys.unshift(newFY); // insert at front (most recent)
    setCEdit(next);setSelFYIdx(0);mk();
  };

  const addCounty=()=>{if(!newCounty.trim()||cEdit[newCounty])return;const tmpl={fiscalYears:[{fy:"FY 2025",medianIncome:0,tiers:[0.3,0.5,0.6,0.8,1.0],personCounts:[1,2,3,4,5,6,7,8],limits:[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]]}]};setCEdit({...cEdit,[newCounty]:tmpl});setSelCounty(newCounty);setSelFYIdx(0);setNewCounty("");mk()};
  const removeCounty=(name)=>{if(!confirm(`Remove "${name}" county limits? All fiscal years will be deleted.`))return;const next={...cEdit};delete next[name];setCEdit(next);if(selCounty===name){setSelCounty(Object.keys(next)[0]||"");setSelFYIdx(0)}mk()};

  // Property editors
  const updatePropName=(pi,name)=>{const n=[...pEdit];n[pi]={...n[pi],name};setPEdit(n);mk()};
  const updatePropCounty=(pi,county)=>{const n=[...pEdit];n[pi]={...n[pi],county};setPEdit(n);mk()};
  const updateUnit=(pi,ui,field,val)=>{const n=JSON.parse(JSON.stringify(pEdit));n[pi].units[ui][field]=val===""?0:+val;setPEdit(n);mk()};
  const updateUnitAmi=(pi,ui,val)=>{const n=JSON.parse(JSON.stringify(pEdit));n[pi].units[ui].ami=val===""?0:+val;setPEdit(n);mk()};
  const addUnit=(pi)=>{const n=JSON.parse(JSON.stringify(pEdit));n[pi].units.push({bedrooms:1,ami:0.6,maxRent:0,marketRent:0,count:1});setPEdit(n);mk()};
  const removeUnit=(pi,ui)=>{const n=JSON.parse(JSON.stringify(pEdit));n[pi].units=n[pi].units.filter((_,i)=>i!==ui);setPEdit(n);mk()};
  const addProp=()=>{setPEdit([...pEdit,{name:"New Property",county:countyNames[0]||"",managers:[],units:[{bedrooms:1,ami:0.6,maxRent:0,marketRent:0,count:1}]}]);mk()};
  const removeProp=(pi)=>{if(!confirm(`Remove "${pEdit[pi].name}"?`))return;setPEdit(pEdit.filter((_,i)=>i!==pi));mk()};

  // User editors â€” multi-role
  const toggleUserRole=(idx,role)=>{const n=JSON.parse(JSON.stringify(uEdit));const roles=n[idx].roles||[];if(roles.includes(role)){n[idx].roles=roles.filter(r=>r!==role);if(!n[idx].roles.length)n[idx].roles=["leaser"]}else{n[idx].roles=[...roles,role]};setUEdit(n);mk()};
  const addUser=()=>{if(!newUserEmail.trim())return;if(uEdit.find(u=>u.email.toLowerCase()===newUserEmail.toLowerCase()))return alert("User already exists");setUEdit([...uEdit,{email:newUserEmail.toLowerCase().trim(),name:newUserName.trim()||newUserEmail.split("@")[0],roles:[...newUserRoles]}]);setNewUserEmail("");setNewUserName("");setNewUserRoles(["manager"]);mk()};
  const removeUser=(idx)=>{if(!confirm(`Remove ${uEdit[idx].name}?`))return;setUEdit(uEdit.filter((_,i)=>i!==idx));mk()};
  const toggleNewRole=(role)=>{setNewUserRoles(prev=>prev.includes(role)?prev.filter(r=>r!==role):[...prev,role])};

  return(
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"}}>
        <div style={{display:"flex",background:B.teal50,borderRadius:"4px",border:`1px solid ${B.teal600}`}}>
          {[{key:"limits",label:"Income Limits"},{key:"properties",label:"Properties & Units"},{key:"users",label:"Users & Roles"}].map(t=>
            <button key={t.key} onClick={()=>setATab(t.key)} style={{background:aTab===t.key?`${B.gold500}18`:"transparent",border:"none",color:aTab===t.key?B.gold500:B.teal300,padding:"6px 14px",fontSize:"11px",fontWeight:700,cursor:"pointer",borderRadius:"3px",fontFamily:fb,textTransform:"uppercase",letterSpacing:"0.5px"}}>{t.label}</button>
          )}
        </div>
        <div style={{display:"flex",gap:"8px",alignItems:"center"}}>
          {lastSaved&&<span style={{fontSize:"10px",color:B.teal300}}>Last saved: {lastSaved}</span>}
          {dirty&&<span style={{fontSize:"10px",color:B.gold500,fontWeight:700}}>â— Unsaved</span>}
          {isAdmin&&<Btn onClick={save} disabled={!dirty||saving} style={{padding:"6px 16px"}}>{saving?"Saving...":"Save Changes"}</Btn>}
        </div>
      </div>

      {/* INCOME LIMITS â€” per county with fiscal year history */}
      {aTab==="limits"&&(
        <Card>
          {/* County tabs */}
          <div style={{display:"flex",gap:"4px",marginBottom:"10px",flexWrap:"wrap",alignItems:"center"}}>
            {countyNames.map(c=><button key={c} onClick={()=>{setSelCounty(c);setSelFYIdx(0)}} style={{background:selCounty===c?`${B.gold500}22`:"transparent",border:`1px solid ${selCounty===c?B.gold500:B.teal600}`,color:selCounty===c?B.gold500:B.teal300,padding:"4px 10px",fontSize:"10px",fontWeight:700,cursor:"pointer",borderRadius:"3px",fontFamily:fb}}>{c}{isAdmin&&countyNames.length>1&&<span onClick={e=>{e.stopPropagation();removeCounty(c)}} style={{marginLeft:"6px",color:B.no,cursor:"pointer"}}>Ã—</span>}</button>)}
            {isAdmin&&<div style={{display:"flex",gap:"4px",marginLeft:"8px"}}><I value={newCounty} onChange={setNewCounty} placeholder="New county name..." style={{width:"180px",fontSize:"10px",padding:"4px 6px"}}/><Btn v="small" onClick={addCounty} style={{padding:"3px 8px",fontSize:"9px"}}>+ County</Btn></div>}
          </div>

          {/* Fiscal Year selector */}
          {curFYs.length>0&&<div style={{display:"flex",gap:"4px",marginBottom:"12px",alignItems:"center",flexWrap:"wrap"}}>
            <span style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px",marginRight:"4px"}}>Fiscal Year:</span>
            {curFYs.map((fy,i)=><button key={i} onClick={()=>setSelFYIdx(i)} style={{background:selFYIdx===i?(i===0?`${B.ok}22`:`${B.teal300}22`):"transparent",border:`1px solid ${selFYIdx===i?(i===0?B.ok:B.teal300):B.teal600}`,color:selFYIdx===i?(i===0?B.ok:B.teal300):B.gray400,padding:"3px 10px",fontSize:"10px",fontWeight:700,cursor:"pointer",borderRadius:"3px",fontFamily:fb}}>{fy.fy}{i===0&&<span style={{marginLeft:"4px",fontSize:"8px",opacity:0.7}}>â— ACTIVE</span>}</button>)}
            {isAdmin&&<Btn v="small" onClick={addFiscalYear} style={{padding:"3px 10px",fontSize:"9px",marginLeft:"8px"}}>+ New Fiscal Year</Btn>}
          </div>}

          {/* Read-only notice for historical FYs */}
          {!isActiveFY&&curFY&&<div style={{background:B.wBg,border:`1px solid ${B.wBr}`,borderRadius:"4px",padding:"6px 10px",marginBottom:"10px",fontSize:"10px",color:B.gold500,fontWeight:600}}>ðŸ“‹ Historical record â€” {curFY.fy} limits are read-only for audit reference. Only the active fiscal year can be edited.</div>}

          {curFY&&<>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 120px",gap:"8px",marginBottom:"14px"}}>
              <F label="Fiscal Year Label"><I value={curFY.fy} onChange={v=>updateFYField("fy",v)} disabled={!isAdmin||!isActiveFY} placeholder="FY 2025"/></F>
              <F label="Area Median Income"><I type="number" value={curFY.medianIncome} onChange={v=>updateFYField("medianIncome",v===""?0:+v)} disabled={!isAdmin||!isActiveFY} placeholder="82400"/></F>
              <div/>
            </div>
            <div style={{overflowX:"auto"}}>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}>
                <thead><tr style={{borderBottom:`2px solid ${B.gold500}`}}>
                  <th style={{padding:"6px 8px",textAlign:"left",color:B.gold500,fontWeight:700,fontSize:"10px",fontFamily:fb}}>AMI Tier</th>
                  {curFY.personCounts.map(p=><th key={p} style={{padding:"6px 4px",textAlign:"center",color:B.teal300,fontWeight:700,fontSize:"10px",fontFamily:fb}}>{p} Person{p>1?"s":""}</th>)}
                </tr></thead>
                <tbody>{curFY.tiers.map((tier,ti)=>
                  <tr key={ti} style={{borderBottom:`1px solid ${B.teal600}33`}}>
                    <td style={{padding:"4px 8px",color:B.gold400,fontWeight:700,fontFamily:fm,fontSize:"12px"}}>{(tier*100).toFixed(0)}%</td>
                    {curFY.personCounts.map((_,pi)=><td key={pi} style={{padding:"2px 3px"}}>
                      {isAdmin&&isActiveFY?<input type="number" value={curFY.limits[ti][pi]} onChange={e=>updateLim(ti,pi,e.target.value)} style={{...iCss,width:"80px",textAlign:"right",fontSize:"11px",padding:"4px 6px"}}/>
                      :<span style={{fontFamily:fm,fontSize:"11px",color:isActiveFY?B.white:B.gray400}}>${curFY.limits[ti][pi].toLocaleString()}</span>}
                    </td>)}
                  </tr>
                )}</tbody>
              </table>
            </div>
            <div style={{marginTop:"10px",fontSize:"10px",color:B.teal300}}>{isActiveFY?"Update when HUD publishes new limits (usually June each year). Click \"+ New Fiscal Year\" to start a new year â€” previous limits are preserved for audit.":"This fiscal year is preserved for audit reference."}</div>
          </>}
        </Card>
      )}

      {/* PROPERTIES & UNITS */}
      {aTab==="properties"&&(
        <div>
          {pEdit.map((prop,pi)=>{
            const managerUsers=uEdit.filter(u=>(u.roles||[]).includes("manager"));
            const propManagers=prop.managers||[];
            return(
            <Card key={pi} style={{marginBottom:"10px"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"}}>
                <div style={{display:"flex",gap:"8px",flex:1,marginRight:"10px",alignItems:"center"}}>
                  {isAdmin?<I value={prop.name} onChange={v=>updatePropName(pi,v)} style={{fontSize:"14px",fontWeight:700,fontFamily:fb,flex:1}}/>:<span style={{fontSize:"14px",fontWeight:700,color:B.white}}>{prop.name}</span>}
                  {isAdmin?<Sel value={prop.county||""} onChange={v=>updatePropCounty(pi,v)} options={countyNames} placeholder="County" style={{width:"200px",fontSize:"11px"}}/>:<span style={{fontSize:"11px",color:B.teal300,marginLeft:"8px"}}>{prop.county}</span>}
                </div>
                {isAdmin&&<div style={{display:"flex",gap:"4px"}}><Btn v="small" onClick={()=>addUnit(pi)} style={{padding:"3px 8px",fontSize:"10px"}}>+ Unit</Btn><Btn v="danger" onClick={()=>removeProp(pi)} style={{padding:"3px 8px",fontSize:"10px"}}>Remove</Btn></div>}
              </div>
              {/* PROPERTY MANAGERS */}
              <div style={{marginBottom:"10px",padding:"8px 10px",background:B.teal50,borderRadius:"4px",border:`1px solid ${B.teal600}`}}>
                <div style={{fontSize:"9px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:"6px"}}>Assigned Managers</div>
                {isAdmin?<div style={{display:"flex",gap:"8px",flexWrap:"wrap"}}>
                  {managerUsers.map(u=>{
                    const checked=propManagers.includes(u.email);
                    return<label key={u.email} style={{display:"flex",alignItems:"center",gap:"4px",fontSize:"11px",color:checked?B.gold400:B.gray400,cursor:"pointer"}}>
                      <input type="checkbox" checked={checked} onChange={()=>{
                        const n=JSON.parse(JSON.stringify(pEdit));
                        const mgrs=n[pi].managers||[];
                        n[pi].managers=checked?mgrs.filter(e=>e!==u.email):[...mgrs,u.email];
                        setPEdit(n);mk();
                      }} style={{accentColor:B.gold500,width:"13px",height:"13px"}}/>
                      {u.name} <span style={{fontSize:"9px",color:B.gray600}}>({u.email})</span>
                    </label>;
                  })}
                  {managerUsers.length===0&&<span style={{fontSize:"10px",color:B.gray600}}>No users with Manager role â€” add one in Users & Roles tab</span>}
                </div>:<div style={{fontSize:"11px",color:B.gray300}}>{propManagers.length?propManagers.map(e=>{const u=uEdit.find(u=>u.email===e);return u?u.name:e}).join(", "):<span style={{color:B.gray600}}>None assigned</span>}</div>}
              </div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}>
                <thead><tr style={{borderBottom:`1px solid ${B.teal600}`}}>{["BR","AMI %","Max AMI Rent","Market Rent","Unit Count",isAdmin?"":""].filter(Boolean).map((h,i)=><th key={i} style={{padding:"4px 6px",textAlign:i>1?"center":"left",color:B.teal300,fontWeight:700,fontSize:"9px",textTransform:"uppercase"}}>{h}</th>)}</tr></thead>
                <tbody>{prop.units.map((unit,ui)=>
                  <tr key={ui} style={{borderBottom:`1px solid ${B.teal600}22`}}>
                    <td style={{padding:"3px 4px",width:"60px"}}>{isAdmin?<input type="number" value={unit.bedrooms} onChange={e=>updateUnit(pi,ui,"bedrooms",e.target.value)} style={{...iCss,width:"50px",textAlign:"center",padding:"4px",fontSize:"11px"}}/>:<span style={{fontFamily:fm}}>{unit.bedrooms}</span>}</td>
                    <td style={{padding:"3px 4px",width:"80px"}}>{isAdmin?<select value={unit.ami} onChange={e=>updateUnitAmi(pi,ui,e.target.value)} style={{...iCss,width:"70px",padding:"4px",fontSize:"11px"}}>{[0.3,0.5,0.6,0.8,1.0].map(t=><option key={t} value={t}>{(t*100).toFixed(0)}%</option>)}</select>:<span style={{fontFamily:fm}}>{(unit.ami*100).toFixed(0)}%</span>}</td>
                    <td style={{padding:"3px 4px",width:"100px"}}>{isAdmin?<input type="number" value={unit.maxRent} onChange={e=>updateUnit(pi,ui,"maxRent",e.target.value)} style={{...iCss,width:"90px",textAlign:"right",padding:"4px 6px",fontSize:"11px"}}/>:<span style={{fontFamily:fm}}>${unit.maxRent}</span>}</td>
                    <td style={{padding:"3px 4px",width:"100px"}}>{isAdmin?<input type="number" value={unit.marketRent} onChange={e=>updateUnit(pi,ui,"marketRent",e.target.value)} style={{...iCss,width:"90px",textAlign:"right",padding:"4px 6px",fontSize:"11px"}}/>:<span style={{fontFamily:fm}}>${unit.marketRent}</span>}</td>
                    <td style={{padding:"3px 4px",width:"70px"}}>{isAdmin?<input type="number" value={unit.count} onChange={e=>updateUnit(pi,ui,"count",e.target.value)} style={{...iCss,width:"55px",textAlign:"center",padding:"4px",fontSize:"11px"}}/>:<span style={{fontFamily:fm}}>{unit.count}</span>}</td>
                    {isAdmin&&<td style={{padding:"3px 4px",width:"30px",textAlign:"center"}}><button onClick={()=>removeUnit(pi,ui)} style={{background:"transparent",border:"none",color:B.no,cursor:"pointer",fontSize:"14px"}}>Ã—</button></td>}
                  </tr>
                )}</tbody>
              </table>
            </Card>);
          })}
          {isAdmin&&<Btn v="small" onClick={addProp} style={{marginTop:"4px"}}>+ Add Property</Btn>}
        </div>
      )}

      {/* USERS & ROLES */}
      {aTab==="users"&&(
        <Card>
          <div style={sCss}>Users & Roles</div>
          <div style={{fontSize:"10px",color:B.teal300,marginBottom:"12px"}}>
            Users can have <b>multiple roles</b>. <b>Leaser</b> â€” fill form & submit for review | <b>Manager</b> â€” reviews leaser submissions, submits own (assign to properties in Properties tab) | <b>Approver</b> â€” review & approve/deny/send back | <b>Admin</b> â€” override denials, edit config, manage users
          </div>
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px",marginBottom:"12px"}}>
            <thead><tr style={{borderBottom:`2px solid ${B.gold500}`}}>
              {["Email","Name","Leaser","Manager","Approver","Admin",isAdmin?"":""].filter(Boolean).map((h,i)=><th key={i} style={{padding:"6px 8px",textAlign:i>1?"center":"left",color:B.gold500,fontWeight:700,fontSize:"10px",fontFamily:fb,textTransform:"uppercase",whiteSpace:"nowrap"}}>{h}</th>)}
            </tr></thead>
            <tbody>{uEdit.map((u,i)=>{
              const roles=u.roles||[u.role||"leaser"];
              return(<tr key={i} style={{borderBottom:`1px solid ${B.teal600}33`}}>
                <td style={{padding:"5px 8px",color:B.white,fontFamily:fm,fontSize:"11px"}}>{u.email}</td>
                <td style={{padding:"5px 8px",color:B.white}}>{u.name}</td>
                {["leaser","manager","approver","admin"].map(role=>(
                  <td key={role} style={{padding:"5px 8px",textAlign:"center"}}>
                    {isAdmin?<input type="checkbox" checked={roles.includes(role)} onChange={()=>toggleUserRole(i,role)} style={{cursor:"pointer",accentColor:B.gold500}}/>
                    :<span style={{color:roles.includes(role)?B.ok:B.gray600,fontSize:"14px"}}>{roles.includes(role)?"âœ“":"â€”"}</span>}
                  </td>))}
                {isAdmin&&<td style={{padding:"5px 8px",textAlign:"center"}}><button onClick={()=>removeUser(i)} style={{background:"transparent",border:"none",color:B.no,cursor:"pointer",fontSize:"13px"}}>Ã—</button></td>}
              </tr>);
            })}</tbody>
          </table>
          {isAdmin&&<div style={{display:"grid",gridTemplateColumns:"1fr 1fr auto auto",gap:"6px",alignItems:"end"}}>
            <F label="Email"><I value={newUserEmail} onChange={setNewUserEmail} placeholder="user@company.com"/></F>
            <F label="Display Name"><I value={newUserName} onChange={setNewUserName} placeholder="Full name"/></F>
            <F label="Roles"><div style={{display:"flex",gap:"6px",padding:"7px 0"}}>{["leaser","manager","approver","admin"].map(r=>(<label key={r} style={{display:"flex",alignItems:"center",gap:"3px",fontSize:"11px",color:newUserRoles.includes(r)?B.gold400:B.gray400,cursor:"pointer"}}><input type="checkbox" checked={newUserRoles.includes(r)} onChange={()=>toggleNewRole(r)} style={{accentColor:B.gold500}}/>{ROLE_LABELS[r]}</label>))}</div></F>
            <Btn onClick={addUser} style={{marginBottom:"8px"}}>Add User</Btn>
          </div>}
        </Card>
      )}
    </div>
  );
}

// ============================================================
// HOUSE ICON
// ============================================================
function HouseIcon(){return(<svg viewBox="0 0 28 28" width="32" height="32" style={{marginRight:"10px"}}><path d="M14 2L2 12h3v12h7v-7h4v7h7V12h3L14 2z" fill={B.gold500} opacity="0.9"/><rect x="11" y="12" width="6" height="5" rx="0.5" fill={B.teal800}/><circle cx="15.5" cy="14.5" r="0.6" fill={B.gold500}/><line x1="1" y1="13" x2="8" y2="13" stroke={B.gold500} strokeWidth="1.2"/><line x1="20" y1="13" x2="27" y2="13" stroke={B.gold500} strokeWidth="1.2"/></svg>)}

// ============================================================
// PRINT RESULT â€” includes override info
// ============================================================
function PrintResult({fd,pr,ar,total,breakdown,reviewer,limitsLabel,overrideStatus,overrideBy,overrideNotes,vDate,auditTrail}){
  const isOvr=overrideStatus==="OVERRIDE_APPROVED";
  const finalResult=isOvr?"OVERRIDE APPROVED":pr.result;
  const finalColor=isOvr?"#6A8EC8":pr.result==="APPROVED"?"#3DA06B":"#D35B4B";
  const occupants=fd.occupantDetails||[];
  const au=auditTrail||{};
  const sigLine={borderBottom:"1px solid #333",minWidth:"160px",display:"inline-block",height:"20px",verticalAlign:"bottom"};
  const tblR=(label,val)=><tr><td style={{padding:"3px 0",color:"#666",width:"120px"}}>{label}</td><td style={{fontWeight:700}}>{val}</td></tr>;
  return(
    <div id="printable-result" style={{background:"#fff",borderRadius:"6px",padding:"28px 32px",margin:"12px 0",color:"#1a1a1a",fontFamily:fb,fontSize:"12px"}}>
      {/* HEADER */}
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",borderBottom:"2px solid #28434C",paddingBottom:"12px",marginBottom:"16px"}}>
        <div><div style={{fontSize:"9px",fontWeight:700,color:"#CDA04B",textTransform:"uppercase",letterSpacing:"2px"}}>NewShire Property Management</div><div style={{fontSize:"18px",fontWeight:900,color:"#28434C"}}>AMI Income Verification</div><div style={{fontSize:"10px",color:"#666",marginTop:"2px"}}>{limitsLabel}</div></div>
        <div style={{textAlign:"right"}}><div style={{fontSize:"10px",color:"#666"}}>Date: {new Date(vDate+"T12:00:00").toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}</div><div style={{fontSize:"10px",color:"#666"}}>Reviewer: {reviewer}</div></div>
      </div>
      {/* PROPERTY & INCOME SUMMARY */}
      <div style={{display:"flex",gap:"12px",marginBottom:"16px"}}>
        <div style={{flex:1}}>
          <div style={{fontSize:"10px",fontWeight:700,color:"#28434C",textTransform:"uppercase",letterSpacing:"1px",marginBottom:"6px",borderBottom:"1px solid #ddd",paddingBottom:"3px"}}>Applicant & Property</div>
          <table style={{width:"100%",fontSize:"11px",borderCollapse:"collapse"}}><tbody>
            {tblR("Applicant",<>{fd.primaryApplicant}{fd.allApplicantNames!==fd.primaryApplicant&&<span style={{fontWeight:400,color:"#666"}}> + {fd.allApplicantNames.split(",").length-1} co-applicant(s)</span>}</>)}
            {tblR("Property",fd.propertyName)}
            {tblR("Unit",fd.unitNumber||"â€”")}
            {tblR("Bedrooms",fd.bedrooms)}
            {tblR("AMI Tier",`${(fd.amiTier*100).toFixed(0)}%`)}
            {tblR("Occupants",fd.occupants)}
            {tblR("Monthly Rent",`$${(+fd.monthlyRent).toLocaleString()}`)}
          </tbody></table>
        </div>
        <div style={{flex:1}}>
          <div style={{fontSize:"10px",fontWeight:700,color:"#28434C",textTransform:"uppercase",letterSpacing:"1px",marginBottom:"6px",borderBottom:"1px solid #ddd",paddingBottom:"3px"}}>Income Summary</div>
          <table style={{width:"100%",fontSize:"11px",borderCollapse:"collapse"}}><tbody>
            {breakdown.filter(b=>b.amount>0).map((b,i)=><tr key={i}><td style={{padding:"3px 0",color:"#666"}}>{b.label}</td><td style={{textAlign:"right"}}>${b.amount.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})}</td></tr>)}
            <tr style={{borderTop:"2px solid #28434C"}}><td style={{padding:"6px 0",fontWeight:800}}>Total Annual Income</td><td style={{textAlign:"right",fontWeight:800,fontSize:"13px"}}>${total.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})}</td></tr>
          </tbody></table>
        </div>
      </div>
      {/* HOUSEHOLD OCCUPANT DETAILS */}
      <div style={{marginBottom:"16px"}}>
        <div style={{fontSize:"10px",fontWeight:700,color:"#28434C",textTransform:"uppercase",letterSpacing:"1px",marginBottom:"6px",borderBottom:"1px solid #ddd",paddingBottom:"3px"}}>Household Occupant Details</div>
        <table style={{width:"100%",fontSize:"11px",borderCollapse:"collapse",border:"1px solid #ddd"}}>
          <thead><tr style={{background:"#f5f5f5"}}>
            <th style={{padding:"4px 8px",textAlign:"left",borderBottom:"1px solid #ddd",fontSize:"10px",fontWeight:700,width:"30px"}}>#</th>
            <th style={{padding:"4px 8px",textAlign:"left",borderBottom:"1px solid #ddd",fontSize:"10px",fontWeight:700}}>Full Name</th>
            <th style={{padding:"4px 8px",textAlign:"left",borderBottom:"1px solid #ddd",fontSize:"10px",fontWeight:700,width:"100px"}}>Date of Birth</th>
            <th style={{padding:"4px 8px",textAlign:"left",borderBottom:"1px solid #ddd",fontSize:"10px",fontWeight:700,width:"100px"}}>Relationship</th>
          </tr></thead>
          <tbody>
            {Array.from({length:8}).map((_,i)=>{
              const o=occupants[i];
              return<tr key={i} style={{borderBottom:"1px solid #eee"}}>
                <td style={{padding:"4px 8px",color:"#999"}}>{i+1}</td>
                <td style={{padding:"4px 8px"}}>{o?.name||""}</td>
                <td style={{padding:"4px 8px"}}>{o?.dob?new Date(o.dob+"T12:00:00").toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}):""}</td>
                <td style={{padding:"4px 8px"}}>{o?.relationship||""}</td>
              </tr>;
            })}
          </tbody>
        </table>
      </div>
      {/* VERIFICATION DECISION */}
      <div style={{background:isOvr?"#f0f4fa":pr.result==="APPROVED"?"#f0faf5":"#fdf5f4",border:`2px solid ${finalColor}`,borderRadius:"6px",padding:"14px 18px",marginBottom:"14px"}}>
        <div style={{fontSize:"16px",fontWeight:900,color:finalColor,marginBottom:"4px"}}>{isOvr?"âš– ":pr.result==="APPROVED"?"âœ“ ":"âœ— "}{finalResult}</div>
        {pr.result==="DENIED"&&!isOvr&&<div style={{fontSize:"11px",color:"#666"}}>Reason: {pr.reason} â€” Variance: ${Math.round(pr.variance).toLocaleString()}</div>}
        {pr.result==="DENIED"&&isOvr&&<div style={{fontSize:"11px",color:"#666",marginTop:"4px"}}>
          <div>Original Decision: DENIED â€” {pr.reason}</div>
          <div style={{marginTop:"4px",fontWeight:700,color:"#6A8EC8"}}>Override Authorized By: {overrideBy}</div>
          <div>Override Reason: {overrideNotes}</div>
        </div>}
        <div style={{fontSize:"10px",color:"#999",marginTop:"6px"}}>
          Income Limit: ${pr.limit?.toLocaleString()} | Effective Persons: {pr.eff} (Anchor: {pr.anchor}) | Min Monthly: ${Math.round(pr.minMo).toLocaleString()} | Actual Monthly: ${Math.round(pr.mo).toLocaleString()}
        </div>
      </div>
      {ar&&!isOvr&&<div style={{background:"#fffbf0",border:"1px solid #e0c680",borderRadius:"6px",padding:"10px 14px",marginBottom:"14px"}}>
        <div style={{fontSize:"12px",fontWeight:700,color:ar.result==="APPROVED"?"#3DA06B":"#D35B4B"}}>Alt Tier Review (80% AMI): {ar.result}</div>
        {ar.reason&&<div style={{fontSize:"11px",color:"#666"}}>{ar.reason} â€” Variance: ${Math.round(ar.variance).toLocaleString()}</div>}
        <div style={{fontSize:"10px",color:"#999"}}>Limit: ${ar.limit?.toLocaleString()} | Eff. Persons: {ar.eff}</div>
      </div>}
      {/* AUDIT LOG â€” full chronological event history */}
      {(()=>{
        const events=au.events&&au.events.length>0?au.events:[];
        // Fallback: if no events array, build from flat fields (legacy records)
        const fallbackRows=events.length===0?[
          {action:"Submitted",by:au.submittedByName||au.submittedBy||reviewer||"â€”",date:au.submittedDate||(vDate?vDate+"T12:00:00":""),notes:"Initial submission"},
          ...(au.reviewedBy?[{action:pr.result==="APPROVED"?"Approved":"Reviewed",by:au.reviewedByName||au.reviewedBy,date:au.reviewDate,notes:au.reviewNotes||"â€”"}]:[]),
          ...((isOvr||au.overrideBy)?[{action:"Override Approved",by:au.overrideBy||overrideBy||"â€”",date:au.overrideDate,notes:au.overrideNotes||overrideNotes||"â€”"}]:[]),
        ]:null;
        const rows=fallbackRows||events;
        const actionColors={"Submitted":"#333","Updated":"#E68C32","Approved":"#3DA06B","Denied â†’ Regional":"#D35B4B","Override Approved":"#6A8EC8","Final Denied":"#D35B4B","Sent Back":"#E68C32","Reviewed":"#4A78B0"};
        return(
        <div style={{marginBottom:"16px"}}>
          <div style={{fontSize:"10px",fontWeight:700,color:"#28434C",textTransform:"uppercase",letterSpacing:"1px",marginBottom:"6px",borderBottom:"1px solid #ddd",paddingBottom:"3px"}}>Audit Log</div>
          <table style={{width:"100%",fontSize:"11px",borderCollapse:"collapse",border:"1px solid #ddd"}}>
            <thead><tr style={{background:"#f5f5f5"}}>
              <th style={{padding:"4px 8px",textAlign:"left",borderBottom:"1px solid #ddd",fontSize:"10px",fontWeight:700,width:"30px"}}>#</th>
              <th style={{padding:"4px 8px",textAlign:"left",borderBottom:"1px solid #ddd",fontSize:"10px",fontWeight:700}}>Action</th>
              <th style={{padding:"4px 8px",textAlign:"left",borderBottom:"1px solid #ddd",fontSize:"10px",fontWeight:700}}>By</th>
              <th style={{padding:"4px 8px",textAlign:"left",borderBottom:"1px solid #ddd",fontSize:"10px",fontWeight:700,width:"140px"}}>Date / Time</th>
              <th style={{padding:"4px 8px",textAlign:"left",borderBottom:"1px solid #ddd",fontSize:"10px",fontWeight:700}}>Notes</th>
            </tr></thead>
            <tbody>
              {rows.map((ev,i)=>(
                <tr key={i} style={{borderBottom:"1px solid #eee"}}>
                  <td style={{padding:"4px 8px",color:"#999"}}>{i+1}</td>
                  <td style={{padding:"4px 8px",fontWeight:600,color:actionColors[ev.action]||"#333"}}>{ev.action}</td>
                  <td style={{padding:"4px 8px"}}>{ev.by||"â€”"}</td>
                  <td style={{padding:"4px 8px"}}>{ev.date?new Date(ev.date).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}):"â€”"}</td>
                  <td style={{padding:"4px 8px",color:"#666"}}>{ev.notes||"â€”"}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>);
      })()}
      {/* APPLICANT SIGNATURES â€” auto-generated for adults (18+) from occupant details */}
      {(()=>{
        const adults=occupants.filter(o=>{
          if(!o.name)return false;
          if(!o.dob)return true; // no DOB = assume adult
          return((new Date()-new Date(o.dob+"T12:00:00"))/(365.25*86400000))>=18;
        });
        const sigRows=adults.length>0?adults:occupants.filter(o=>o.name).length>0?occupants.filter(o=>o.name):[{name:""}];
        return(
        <div style={{marginBottom:"16px"}}>
          <div style={{fontSize:"10px",fontWeight:700,color:"#28434C",textTransform:"uppercase",letterSpacing:"1px",marginBottom:"6px",borderBottom:"1px solid #ddd",paddingBottom:"3px"}}>Applicant Certification & Signatures</div>
          <div style={{fontSize:"10px",color:"#666",marginBottom:"12px",lineHeight:"1.5"}}>
            I/We certify that the information provided in this application is true and complete to the best of my/our knowledge. I/We understand that providing false information may result in denial of tenancy or termination of the lease agreement. I/We authorize NewShire Property Management to verify any information provided herein.
          </div>
          <table style={{width:"100%",borderCollapse:"collapse"}}>
            <thead><tr>
              <th style={{padding:"4px 8px",textAlign:"left",fontSize:"10px",fontWeight:700,color:"#28434C",borderBottom:"1px solid #ddd",width:"24px"}}>#</th>
              <th style={{padding:"4px 8px",textAlign:"left",fontSize:"10px",fontWeight:700,color:"#28434C",borderBottom:"1px solid #ddd",width:"35%"}}>Printed Name</th>
              <th style={{padding:"4px 8px",textAlign:"left",fontSize:"10px",fontWeight:700,color:"#28434C",borderBottom:"1px solid #ddd"}}>Signature</th>
              <th style={{padding:"4px 8px",textAlign:"left",fontSize:"10px",fontWeight:700,color:"#28434C",borderBottom:"1px solid #ddd",width:"100px"}}>Date</th>
            </tr></thead>
            <tbody>
              {sigRows.map((o,i)=>(
                <tr key={i}><td style={{padding:"12px 8px",borderBottom:"1px solid #eee",color:"#999",fontSize:"10px"}}>{i+1}</td>
                  <td style={{padding:"12px 8px",borderBottom:"1px solid #eee",fontWeight:o.name?700:400,fontSize:"11px",whiteSpace:"nowrap"}}>{o.name||<div style={sigLine}/>}</td>
                  <td style={{padding:"12px 8px",borderBottom:"1px solid #eee"}}><div style={sigLine}/></td>
                  <td style={{padding:"12px 8px",borderBottom:"1px solid #eee"}}><div style={sigLine}/></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>);
      })()}
      {/* FOOTER */}
      <div style={{borderTop:"1px solid #ddd",paddingTop:"10px",display:"flex",justifyContent:"space-between",fontSize:"9px",color:"#999"}}>
        <span>NewShire Property Management â€” AMI Verification Calculator v{APP_VERSION}</span><span>Generated {new Date().toLocaleString()}</span>
      </div>
    </div>
  );
}

// ============================================================
// MAIN COMPONENT
// ============================================================
window.AMICalculator = function AMICalculator(){
  const[tab,setTab]=useState("calculator");
  const auth=useMsal();

  // Config state â€” multi-county
  const[counties,setCounties]=useState(DEFAULT_COUNTIES);
  const[properties,setProperties]=useState(DEFAULT_PROPERTIES);
  const[users,setUsers]=useState(DEFAULT_USERS);
  const[cfgDone,setCfgDone]=useState(!CONFIG.isConfigured);
  const[cfgSaved,setCfgSaved]=useState("");
  const[adminSaving,setAdminSaving]=useState(false);

  // Multi-role user resolution
  const userEmail=auth.user?.username?.toLowerCase()||"";
  const userRecord=users.find(u=>u.email.toLowerCase()===userEmail);
  const userRoles=userRecord?.roles||(userRecord?.role?[userRecord.role]:[]);
  const effectiveRoles=userRoles.length>0?userRoles:(CONFIG.seedAdmins.includes(userEmail)?["admin","approver","manager"]:[]);
  const hasRole=(r)=>effectiveRoles.includes(r);
  const isAdmin=hasRole("admin");
  const isApprover=hasRole("approver")||isAdmin;
  const isManager=hasRole("manager")||isApprover;
  const isLeaser=hasRole("leaser");
  const canSubmit=isManager||isLeaser; // leasers and managers can both submit
  const hasAnyRole=effectiveRoles.length>0;
  if(auth.user&&!hasAnyRole)console.warn("[AMI] No roles for",userEmail,"| userRecord:",userRecord,"| users count:",users.length,"| users:",users.map(u=>u.email));

  // Load config â€” runs once after first successful auth
  const cfgLoadedRef=useRef(false);
  useEffect(()=>{
    if(!CONFIG.isConfigured){setCfgDone(true);return}
    if(cfgLoadedRef.current)return;
    if(!auth.user)return; // wait for sign-in
    cfgLoadedRef.current=true;
    (async()=>{try{
      const tok=await auth.getToken();
      if(tok){const cfg=await cfgLoad(tok);if(cfg){
        if(cfg.counties?.counties){setCounties(migrateAllCounties(cfg.counties.counties));if(cfg.counties.users)setUsers(migrateUsers(cfg.counties.users))}
        else if(cfg.counties&&!cfg.counties.counties){setCounties(migrateAllCounties({"Spartanburg County, SC":cfg.counties}));if(cfg.counties.users)setUsers(migrateUsers(cfg.counties.users))}
        if(cfg.properties)setProperties(cfg.properties);
        setCfgSaved(`${new Date(cfg.lastModified).toLocaleDateString("en-US",{month:"short",day:"numeric"})}`);
        console.log("[AMI] Config loaded. Users:",cfg.counties?.users?.length||0,"Props:",cfg.properties?.length||0);
      }else{console.warn("[AMI] No config found in SharePoint â€” using defaults")}}
    }catch(e){console.error("Cfg load:",e)}setCfgDone(true)})();
  },[auth.user]);

  // Admin save
  const handleAdminSave=async(newC,newP,newU)=>{
    if(!CONFIG.isConfigured){setCounties(newC);setProperties(newP);setUsers(newU);return}
    setAdminSaving(true);
    try{const tok=await auth.getToken();if(!tok)throw new Error("Auth failed");
      await cfgSave(tok,newC,newP,newU,auth.user?.name||userEmail||"Unknown");
      setCounties(newC);setProperties(newP);setUsers(newU);setCfgSaved("Just now");
    }catch(e){alert(`Save failed: ${e.message}`)}
    setAdminSaving(false);
  };

  // Calculator form state
  const[reviewer,setReviewer]=useState("");
  // Default reviewer to current user on fresh forms
  useEffect(()=>{if(auth.user?.name&&!reviewer&&!lastSubmittedId)setReviewer(auth.user.name)},[auth.user,lastSubmittedId]);
  const[vDate,setVDate]=useState(localToday());
  const[primaryApplicantName,setPAN]=useState("");
  const[propIdx,setPropIdx]=useState("");
  const[unitCfg,setUnitCfg]=useState(null);
  const[unitNum,setUnitNum]=useState("");
  const[occ,setOcc]=useState("");
  const[rent,setRent]=useState("");
  const[occupantDetails,setOccupantDetails]=useState([]);
  const[applicants,setApplicants]=useState([{name:"",paystubs:["","","",""],paystubFrequency:""}]);
  const[offers,setOffers]=useState([{name:"",hourly:"",hoursPerWeek:"",salary:""}]);
  const[banks,setBanks]=useState([{name:"",deposits:["","",""]}]);
  const[other,setOther]=useState([]);
  const[notes,setNotes]=useState("");
  const[attachmentFiles,setAttachmentFiles]=useState([]);
  const[savedAttachments,setSavedAttachments]=useState([]);
  const[submitSt,setSubmitSt]=useState("idle");
  const[submitErr,setSubmitErr]=useState("");
  const[history,setHistory]=useState([]);
  const[histLoad,setHistLoad]=useState(false);
  // Override state (for history restore)
  const[overrideStatus,setOverrideStatus]=useState(null);
  const[overrideBy,setOverrideBy]=useState("");
  const[overrideNotesDisplay,setOverrideNotesDisplay]=useState("");
  const[lastSubmittedId,setLastSubmittedId]=useState(null);
  // Admin edit state â€” for correcting decisions on completed records
  const[adminEditFields,setAdminEditFields]=useState(null); // null=not editing, object=editable fields
  // Audit trail state (for print form) â€” events[] holds the full chronological log
  const[auditTrail,setAuditTrail]=useState({submittedBy:"",submittedByName:"",submittedDate:"",reviewedBy:"",reviewedByName:"",reviewDate:"",reviewNotes:"",overrideBy:"",overrideDate:"",overrideNotes:"",events:[]});
  // Review mode â€” when a reviewer opens a record from the queue into the form
  // {type:"approver"|"regional"|null, itemId:string, record:object}
  const[reviewMode,setReviewMode]=useState(null);
  const[reviewNotes,setReviewNotes]=useState("");
  const[sendBackReason,setSendBackReason]=useState("");
  const[sendBackOther,setSendBackOther]=useState("");
  const[reviewActing,setReviewActing]=useState(false);

  // Derived
  const prop=propIdx!==""?properties[propIdx]:null;
  const countyObj=prop&&counties[prop.county]?counties[prop.county]:counties[Object.keys(counties)[0]];
  const countyLimits=getActiveFY(countyObj);
  const countyFY=countyLimits?.fy||"";
  const units=prop?[...new Map(prop.units.map(u=>[`${u.bedrooms}-${u.ami}`,u])).values()]:[];
  const br=unitCfg?.bedrooms??0,ami=unitCfg?.ami??0;
  const pAnn=applicants.reduce((s,a)=>s+calcPS(a.paystubs||[],a.paystubFrequency||""),0);
  const oAnn=offers.reduce((s,o)=>s+calcOL(o.hourly,o.hoursPerWeek,o.salary),0);
  const bAnn=banks.reduce((s,b)=>s+calcBK(b.deposits||[]),0);
  const otAnn=calcOth(other);
  const total=pAnn+oAnn+bAnn+otAnn;
  const breakdown=[{label:"Paystub Income",amount:pAnn},{label:"Offer Letter",amount:oAnn},{label:"Bank Statements",amount:bAnn},{label:"Other Income",amount:otAnn}];

  const canRun=unitCfg&&total>0&&rent&&countyLimits;
  let pr=null,ar=null;
  if(canRun){
    const eff=occ?+occ:anchorP(br);
    pr=verify({tier:ami,br,occ:eff,income:total,rent:+rent,lim:countyLimits});
    if(pr.result==="DENIED"&&ami<0.8){const au=prop.units.find(u=>u.bedrooms===br&&u.ami===0.8);ar=verify({tier:0.8,br,occ:eff,income:total,rent:au?au.marketRent:+rent,lim:countyLimits})}
  }

  // History load â€” reload when switching to history or dashboard tab
  const[histKey,setHistKey]=useState(0);
  useEffect(()=>{
    if(tab!=="history"&&tab!=="dashboard"&&tab!=="review"||!CONFIG.isConfigured||!auth.user)return;
    let cancelled=false;
    (async()=>{setHistLoad(true);try{const t=await auth.getToken();if(t&&!cancelled){const h=await spHistory(t);if(!cancelled)setHistory(h)}}catch(e){console.error("History:",e)}if(!cancelled)setHistLoad(false)})();
    return()=>{cancelled=true};
  },[histKey]);
  useEffect(()=>{if((tab==="history"||tab==="dashboard"||tab==="review")&&auth.user)setHistKey(k=>k+1)},[tab]);

  // Load history record into form
  const loadFromHistory=(rec)=>{
    setReviewMode(null);setReviewNotes("");setSendBackReason("");setSendBackOther("");
    // Try full form restore from FormDataJSON
    if(rec.FormDataJSON){
      try{
        const fd=JSON.parse(rec.FormDataJSON);
        if(fd.applicants)setApplicants(fd.applicants);
        if(fd.offers)setOffers(fd.offers);
        if(fd.banks)setBanks(fd.banks);
        if(fd.other)setOther(fd.other);
        setPAN(fd.primaryApplicantName||"");
        setReviewer(fd.reviewer||"");
        setVDate(fd.vDate||localToday());
        if(fd.propIdx!==undefined&&fd.propIdx!=="")setPropIdx(String(fd.propIdx));
        setUnitNum(fd.unitNum||"");
        setOcc(fd.occ||"");
        setRent(fd.rent||"");
        setNotes(fd.notes||"");
        setOccupantDetails(fd.occupantDetails||[]);
        // Restore unit config after property index is set
        setTimeout(()=>{
          const pi=fd.propIdx!==""?+fd.propIdx:-1;
          const p=properties[pi];
          if(p&&fd.unitCfgKey){const[b,a]=fd.unitCfgKey.split("-").map(Number);const u=p.units.find(u=>u.bedrooms===b&&u.ami===a);if(u)setUnitCfg(u)}
        },50);
      }catch(e){console.error("FormData parse error:",e)}
    }else{
      // Fallback: restore from individual fields (legacy records without FormDataJSON)
      const pi=properties.findIndex(p=>p.name===rec.Property);
      if(pi>=0)setPropIdx(String(pi));
      setPAN(rec.ApplicantName?.split(",")[0]||"");
      setReviewer(rec.Reviewer||"");
      setVDate(rec.DateCompleted?rec.DateCompleted.slice(0,10):localToday());
      setUnitNum(rec.UnitAddress||"");
      setOcc(rec.Occupants?String(rec.Occupants):"");
      setRent(rec.MonthlyRent?String(rec.MonthlyRent):"");
      setNotes(rec.VerificationNotes||"");
      setApplicants([{name:"",paystubs:["","","",""],paystubFrequency:""}]);
      setOffers([{name:"",hourly:"",hoursPerWeek:"",salary:""}]);
      setBanks([{name:"",deposits:["","",""]}]);
      setOther([]);
      setTimeout(()=>{
        const p=properties[pi];
        if(p){const u=p.units.find(u=>u.bedrooms===+rec.Bedrooms&&u.ami===+rec.AMITier);if(u)setUnitCfg(u)}
      },50);
    }
    // Restore override state if exists
    if(rec.Result?.includes("Override")){setOverrideStatus("OVERRIDE_APPROVED");setOverrideBy(rec.OverrideBy||rec.RegionalReviewedBy||"");setOverrideNotesDisplay(rec.OverrideNotes||rec.RegionalReviewNotes||"")}
    else{setOverrideStatus(null);setOverrideBy("");setOverrideNotesDisplay("")}
    // Populate audit trail â€” reconstruct events from record fields + any saved events
    let savedEvents=[];
    try{const snap=JSON.parse(rec.FormDataJSON||"{}");savedEvents=snap.auditEvents||[]}catch{}
    // Build current-state events from SP fields (in case events weren't saved in older records)
    const builtEvents=[];
    if(rec.SubmittedBy||rec.DateCompleted)builtEvents.push({action:"Submitted",by:rec.SubmittedByName||rec.SubmittedBy||"",email:rec.SubmittedBy||"",date:rec.DateCompleted||""});
    if(rec.ReviewedBy)builtEvents.push({action:rec.Status==="Approved"?"Approved":"Reviewed",by:rec.ReviewedByName||rec.ReviewedBy||"",email:rec.ReviewedBy||"",date:rec.ReviewDate||"",notes:rec.ReviewNotes||""});
    if(rec.OverrideBy||rec.RegionalReviewedBy){const isOvr=rec.Result?.includes("Override");builtEvents.push({action:isOvr?"Override Approved":"Final Denied",by:rec.OverrideBy||rec.RegionalReviewedBy||"",email:rec.RegionalReviewedBy||"",date:rec.RegionalReviewDate||"",notes:rec.OverrideNotes||rec.RegionalReviewNotes||""})}
    if(rec.SentBackBy)builtEvents.push({action:"Sent Back",by:rec.SentBackByName||rec.SentBackBy||"",email:rec.SentBackBy||"",date:rec.SentBackDate||"",notes:rec.SentBackReason||""});
    // Use saved events if they exist (they're more complete), otherwise use built events
    const events=savedEvents.length>0?savedEvents:builtEvents;
    setAuditTrail({submittedBy:rec.SubmittedBy||"",submittedByName:rec.SubmittedByName||rec.SubmittedBy||"",submittedDate:rec.DateCompleted||"",reviewedBy:rec.ReviewedBy||"",reviewedByName:rec.ReviewedByName||rec.ReviewedBy||"",reviewDate:rec.ReviewDate||"",reviewNotes:rec.ReviewNotes||"",overrideBy:rec.OverrideBy||rec.RegionalReviewedBy||"",overrideDate:rec.RegionalReviewDate||"",overrideNotes:rec.OverrideNotes||rec.RegionalReviewNotes||"",events});
    setAttachmentFiles([]);
    // Admin edit â€” populate editable fields for completed records
    const COMPLETED=[WF.APPROVED,WF.DENIED,WF.OVERRIDE_APPROVED,WF.FINAL_DENIED,WF.LEASED,WF.TRANSFERRED_ALT,WF.TRANSFERRED_MARKET,WF.REFUSED,WF.CANCELED];
    if(isAdmin&&COMPLETED.includes(rec.Status)){
      // Determine display decision for admin edit dropdown
      let editDecision=rec.Status;
      if((rec.Status===WF.DENIED||rec.Status===WF.FINAL_DENIED)&&rec.AltResult==="Approved")editDecision="Alt AMI Approved";
      else if(rec.Status===WF.DENIED||rec.Status===WF.FINAL_DENIED)editDecision=WF.DENIED;
      // For lease outcome statuses, map back to the underlying approval decision
      else if([WF.LEASED,WF.TRANSFERRED_ALT,WF.TRANSFERRED_MARKET,WF.REFUSED,WF.CANCELED].includes(rec.Status)){
        if(rec.OverrideBy)editDecision=WF.OVERRIDE_APPROVED;
        else if(rec.AltResult==="Approved")editDecision="Alt AMI Approved";
        else if(rec.Result?.startsWith("Denied"))editDecision=WF.DENIED;
        else editDecision=WF.APPROVED;
      }
      setAdminEditFields({status:editDecision,reviewNotes:rec.ReviewNotes||"",overrideBy:rec.OverrideBy||rec.RegionalReviewedBy||"",overrideNotes:rec.OverrideNotes||rec.RegionalReviewNotes||"",result:rec.Result||""});
    }else{setAdminEditFields(null)}
    // Load saved attachments â€” try field first, fall back to document library folder lookup
    let parsedAttachments=[];
    try{parsedAttachments=JSON.parse(rec.AttachmentURLs||"[]")}catch{}
    if(parsedAttachments.length>0){setSavedAttachments(parsedAttachments)}
    else{
      setSavedAttachments([]);
      // Async fallback: check document library for matching folder
      (async()=>{try{const tok=await auth.getToken();if(tok){const found=await lookupAttachmentsFromDrive(tok,rec);if(found.length>0)setSavedAttachments(found)}}catch{}})();
    }
    setLastSubmittedId(rec._itemId||null);setSubmitSt("idle");setSubmitErr("");
    setTab("calculator");
  };

  // Load a record into the form for review (approver/regional)
  const loadForReview=(rec,type)=>{
    loadFromHistory(rec);
    // Set review mode AFTER loadFromHistory (which clears it)
    setTimeout(()=>{
      const rType=(type==="regional"||rec.Status===WF.DENIED||rec.Status===WF.REGIONAL_REVIEW)?"regional":"approver";
      setReviewMode({type:rType,itemId:rec._itemId,record:rec});
      setReviewNotes("");setSendBackReason("");setSendBackOther("");
    },60);
  };

  const coNames=[...applicants,...offers,...banks].filter(a=>a.name).map(a=>a.name);
  const primaryApplicant=primaryApplicantName.trim()||coNames[0]||"";
  const allApplicantNames=[...new Set([primaryApplicant,...coNames].filter(Boolean))].join(", ");
  const fd={propertyName:prop?.name||"",unitNumber:unitNum,bedrooms:br,amiTier:ami,occupants:occ||anchorP(br),monthlyRent:rent,primaryApplicant,allApplicantNames,occupantDetails};

  // Build full form snapshot for history reload
  const formSnapshot=()=>JSON.stringify({applicants,offers,banks,other,primaryApplicantName,reviewer,propIdx,unitNum,occ,rent,notes,vDate,occupantDetails,auditEvents:auditTrail.events||[],unitCfgKey:unitCfg?`${unitCfg.bedrooms}-${unitCfg.ami}`:"",countyFY});

  const handleSubmit=async()=>{
    if(!reviewer.trim()){setSubmitErr("Reviewer name required");setSubmitSt("error");return}
    if(!prop){setSubmitErr("Select a property");setSubmitSt("error");return}
    if(!unitCfg){setSubmitErr("Select a unit configuration");setSubmitSt("error");return}
    if(!unitNum.trim()){setSubmitErr("Unit number required");setSubmitSt("error");return}
    if(!primaryApplicantName.trim()&&!primaryApplicant){setSubmitErr("Primary applicant name required");setSubmitSt("error");return}
    if(!rent||+rent<=0){setSubmitErr("Monthly rent required");setSubmitSt("error");return}
    const reqOcc=occ?+occ:anchorP(br);
    if(occupantDetails.length<reqOcc){setSubmitErr(`${reqOcc} occupant detail(s) required â€” you have ${occupantDetails.length}. Add occupants in the Household Occupant Details section.`);setSubmitSt("error");return}
    const incompleteOcc=occupantDetails.slice(0,reqOcc).findIndex(o=>!o.name.trim()||!o.dob||!o.relationship);
    if(incompleteOcc>=0){setSubmitErr(`Occupant #${incompleteOcc+1} is incomplete â€” Name, Date of Birth, and Relationship are all required.`);setSubmitSt("error");return}
    setSubmitSt("submitting");
    try{
      const tok=await auth.getToken();if(!tok)throw new Error("Auth failed");
      // Upload attachments first
      let attachmentURLs=[];
      if(attachmentFiles.length>0){
        const folderName=`${prop.name}_${unitNum||"unit"}_${primaryApplicant||"applicant"}_${vDate}`.replace(/[^a-zA-Z0-9_-]/g,"_");
        try{attachmentURLs=await uploadFiles(tok,folderName,attachmentFiles)}catch(e){console.warn("Attachment upload failed:",e.message)}
      }
      // Append audit event before building FormDataJSON
      const newEvent={action:lastSubmittedId?"Updated":"Submitted",by:auth.user?.name||userEmail,email:userEmail,date:new Date().toISOString()};
      const updatedEvents=[...(auditTrail.events||[]),newEvent];
      setAuditTrail(a=>({...a,submittedBy:a.submittedBy||userEmail,submittedByName:a.submittedByName||auth.user?.name||userEmail,submittedDate:a.submittedDate||new Date().toISOString(),events:updatedEvents}));
      // Build fields with updated audit events baked into FormDataJSON
      const snapshotWithAudit=JSON.stringify({applicants,offers,banks,other,primaryApplicantName,reviewer,propIdx,unitNum,occ,rent,notes,vDate,occupantDetails,auditEvents:updatedEvents,unitCfgKey:unitCfg?`${unitCfg.bedrooms}-${unitCfg.ami}`:"",countyFY});
      const fields={
        Title:`${prop.name} - ${unitNum||"â€”"} - ${primaryApplicant||"Unknown"}`,DateCompleted:new Date(vDate+"T12:00:00").toISOString(),
        Reviewer:reviewer,Property:prop.name,UnitAddress:unitNum,ApplicantName:allApplicantNames,
        Bedrooms:br,AMITier:ami,Occupants:occ?+occ:anchorP(br),
        IncomeLimit:pr.limit,TotalIncome:Math.round(total*100)/100,MonthlyRent:+rent,
        Result:pr.result==="APPROVED"?"Approved":`Denied - ${pr.reason}`,
        Variance:Math.round(pr.variance*100)/100,DenialReason:pr.reason||"",
        AltAMITier:ar?0.8:null,AltIncomeLimit:ar?ar.limit:null,
        AltResult:ar?(ar.result==="APPROVED"?"Approved":`Denied - ${ar.reason}`):"",
        AltVariance:ar?Math.round(ar.variance*100)/100:null,AltDenialReason:ar?(ar.reason||""):"",
        PaystubIncome:Math.round(pAnn*100)/100,OfferLetterIncome:Math.round(oAnn*100)/100,
        BankStatementIncome:Math.round(bAnn*100)/100,OtherIncome:Math.round(otAnn*100)/100,
        EffectivePersons:pr.eff,AnchorPersons:pr.anchor,VerificationNotes:notes,
        FormDataJSON:snapshotWithAudit,FiscalYear:countyFY,
        Status:WF.SUBMITTED,SubmittedBy:userEmail,SubmittedByName:auth.user?.name||userEmail,
        AttachmentURLs:JSON.stringify(attachmentURLs),
      };
      let res;
      // If resubmitting an existing record (from history or sent-back), update instead of creating new
      if(lastSubmittedId){
        // Reset status and clear prior review data so it goes through fresh approval
        fields.ReviewedBy="";fields.ReviewedByName="";fields.ReviewDate="";fields.ReviewNotes="";
        fields.SentBackBy="";fields.SentBackByName="";fields.SentBackDate="";fields.SentBackReason="";
        res=await spUpdate(tok,lastSubmittedId,fields);
      }else{
        res=await spWrite(tok,fields);
      }
      setLastSubmittedId(res?.id||lastSubmittedId||null);
      // Send notification email â€” 'update' if resubmitting existing record, 'submit' if new
      const emailAction=lastSubmittedId?"update":"submit";
      try{
        const emailRec=buildEmailRecord(null,pr,fd,total,+rent,countyLimits);
        emailRec._submittedBy=userEmail;
        emailRec._vDate=vDate?vDate+"T12:00:00":"";
        const ratioInfo=calcRentToIncomeRatio(total,+rent);
        await sendWorkflowEmail(tok,emailAction,emailRec,ratioInfo,users,properties,auth.user?.name||userEmail,userEmail,"");
      }catch(e){console.warn("Notification email failed:",e)}
      setSubmitSt("success");setTimeout(()=>setSubmitSt("idle"),4000);
    }catch(e){setSubmitErr(e.message);setSubmitSt("error")}
  };

  // Review queue actions
  const handleDelete=async(itemId,title)=>{
    if(!isAdmin)return;
    if(!confirm(`Permanently delete this record?\n\n${title}\n\nThis cannot be undone.`))return;
    try{const tok=await auth.getToken();if(!tok)throw new Error("Auth failed");await spDelete(tok,itemId);setHistory(h=>h.filter(r=>r._itemId!==itemId))}catch(e){alert(`Delete failed: ${e.message}`)}
  };

  const handleReviewAction=async(itemId,action,reviewNotesText)=>{
    const tok=await auth.getToken();if(!tok)throw new Error("Auth failed");
    const now=new Date().toISOString();
    const rec=history.find(r=>r._itemId===itemId);
    // Build audit event
    const actionLabels={approve:"Approved",deny:"Denied â†’ Regional",override_approve:"Override Approved",final_deny:"Final Denied",send_back:"Sent Back"};
    const auditEvent={action:actionLabels[action]||action,by:auth.user?.name||userEmail,email:userEmail,date:now,notes:reviewNotesText||""};

    // If in review mode, save current form data back to the record
    let formFields={};
    if(reviewMode&&reviewMode.itemId===itemId&&prop){
      const currentEvents=[...(auditTrail.events||[]),auditEvent];
      const snapWithAudit=JSON.stringify({applicants,offers,banks,other,primaryApplicantName,reviewer,propIdx,unitNum,occ,rent,notes,vDate,occupantDetails,auditEvents:currentEvents,unitCfgKey:unitCfg?`${unitCfg.bedrooms}-${unitCfg.ami}`:"",countyFY});
      formFields={
        Reviewer:reviewer,Property:prop.name,UnitAddress:unitNum,ApplicantName:allApplicantNames,
        Bedrooms:br,AMITier:ami,Occupants:occ?+occ:anchorP(br),MonthlyRent:+rent,
        TotalIncome:Math.round(total*100)/100,
        IncomeLimit:pr?pr.limit:undefined,
        Result:pr?(pr.result==="APPROVED"?"Approved":`Denied - ${pr.reason}`):undefined,
        Variance:pr?Math.round(pr.variance*100)/100:undefined,DenialReason:pr?(pr.reason||""):"",
        PaystubIncome:Math.round(pAnn*100)/100,OfferLetterIncome:Math.round(oAnn*100)/100,
        BankStatementIncome:Math.round(bAnn*100)/100,OtherIncome:Math.round(otAnn*100)/100,
        EffectivePersons:pr?pr.eff:undefined,AnchorPersons:pr?pr.anchor:undefined,
        VerificationNotes:notes,FormDataJSON:snapWithAudit,FiscalYear:countyFY,
        AltAMITier:ar?0.8:null,AltIncomeLimit:ar?ar.limit:null,
        AltResult:ar?(ar.result==="APPROVED"?"Approved":`Denied - ${ar.reason}`):"",
        AltVariance:ar?Math.round(ar.variance*100)/100:null,AltDenialReason:ar?(ar.reason||""):"",
      };
      // Remove undefined values
      Object.keys(formFields).forEach(k=>formFields[k]===undefined&&delete formFields[k]);
    } else {
      // Not in review mode â€” just append audit event to existing FormDataJSON
      if(rec?.FormDataJSON){try{const snap=JSON.parse(rec.FormDataJSON);snap.auditEvents=[...(snap.auditEvents||[]),auditEvent];formFields.FormDataJSON=JSON.stringify(snap)}catch{}}
    }

    if(action==="approve"){await spUpdate(tok,itemId,{Status:WF.APPROVED,ReviewedBy:userEmail,ReviewedByName:auth.user?.name||userEmail,ReviewDate:now,ReviewNotes:reviewNotesText||"",...formFields})}
    else if(action==="deny"){await spUpdate(tok,itemId,{Status:WF.DENIED,ReviewedBy:userEmail,ReviewedByName:auth.user?.name||userEmail,ReviewDate:now,ReviewNotes:reviewNotesText,...formFields})}
    else if(action==="override_approve"){await spUpdate(tok,itemId,{Status:WF.OVERRIDE_APPROVED,Result:"Override Approved",RegionalReviewedBy:userEmail,RegionalReviewDate:now,RegionalReviewNotes:reviewNotesText,OverrideBy:auth.user?.name||userEmail,OverrideNotes:reviewNotesText,...formFields})}
    else if(action==="final_deny"){await spUpdate(tok,itemId,{Status:WF.FINAL_DENIED,RegionalReviewedBy:userEmail,RegionalReviewDate:now,RegionalReviewNotes:reviewNotesText,...formFields})}
    else if(action==="send_back"){await spUpdate(tok,itemId,{Status:WF.SENT_BACK,SentBackBy:userEmail,SentBackByName:auth.user?.name||userEmail,SentBackDate:now,SentBackReason:reviewNotesText,...formFields})}
    // Send workflow notification email
    if(rec){
      try{
        const emailRec={
          property:rec.Property||"",unit:rec.UnitAddress||"",applicant:rec.ApplicantName||"",
          amiTier:rec.AMITier?`${(+rec.AMITier*100).toFixed(0)}%`:"â€”",
          householdSize:String(rec.Occupants||""),effectiveHouseholdSize:String(rec.EffectivePersons||rec.Occupants||""),
          totalIncome:rec.TotalIncome||0,incomeLimit:rec.IncomeLimit||0,monthlyRent:rec.MonthlyRent||0,
          calcResult:rec.Result||"",
          _submittedBy:rec.SubmittedBy||"",_reviewedBy:rec.ReviewedBy||"",
        };
        const ratioInfo=calcRentToIncomeRatio(+rec.TotalIncome,+rec.MonthlyRent);
        await sendWorkflowEmail(tok,action,emailRec,ratioInfo,users,properties,auth.user?.name||userEmail,userEmail,reviewNotesText);
      }catch(e){console.warn("Notification email failed:",e)}
    }
    setHistKey(k=>k+1);
  };

  const reset=()=>{
    setPropIdx("");setUnitCfg(null);setUnitNum("");setOcc("");setRent("");setPAN("");setVDate(localToday());setReviewer("");
    setApplicants([{name:"",paystubs:["","","",""],paystubFrequency:""}]);
    setOffers([{name:"",hourly:"",hoursPerWeek:"",salary:""}]);
    setBanks([{name:"",deposits:["","",""]}]);
    setOther([]);setNotes("");setAttachmentFiles([]);setSavedAttachments([]);setSubmitSt("idle");setSubmitErr("");setOccupantDetails([]);
    setOverrideStatus(null);setOverrideBy("");setOverrideNotesDisplay("");setLastSubmittedId(null);setAdminEditFields(null);
    setAuditTrail({submittedBy:"",submittedByName:"",submittedDate:"",reviewedBy:"",reviewedByName:"",reviewDate:"",reviewNotes:"",overrideBy:"",overrideDate:"",overrideNotes:"",events:[]});
    setReviewMode(null);setReviewNotes("");setSendBackReason("");setSendBackOther("");
  };

  const handleLeaseOutcome=async(itemId,outcome,tierLabel)=>{
    if(!confirm(`Set lease outcome to "${outcome}"${tierLabel?` (${tierLabel})`:""} for this record?`))return;
    try{
      const tok=await auth.getToken();if(!tok)throw new Error("Auth failed");
      const now=new Date().toISOString();
      const rec=history.find(r=>r._itemId===itemId);
      // Build audit event
      const auditEvent={action:`Lease Outcome: ${outcome}`,by:auth.user?.name||userEmail,email:userEmail,date:now,notes:tierLabel?`AMI Tier: ${tierLabel}`:""};
      let updatedJSON="";
      if(rec?.FormDataJSON){try{const snap=JSON.parse(rec.FormDataJSON);snap.auditEvents=[...(snap.auditEvents||[]),auditEvent];updatedJSON=JSON.stringify(snap)}catch{}}
      await spUpdate(tok,itemId,{Status:outcome,LeaseOutcome:outcome,LeaseOutcomeBy:userEmail,LeaseOutcomeByName:auth.user?.name||userEmail,LeaseOutcomeDate:now,LeaseOutcomeTier:tierLabel||"",...(updatedJSON?{FormDataJSON:updatedJSON}:{})});
      setHistKey(k=>k+1);
    }catch(e){alert(`Failed to set lease outcome: ${e.message}`)}
  };

  const handleResetOutcome=async(itemId,rec)=>{
    if(!confirm(`Reset lease outcome for ${rec.ApplicantName||"this record"}? It will return to the Pending Lease Outcome queue.`))return;
    try{
      const tok=await auth.getToken();if(!tok)throw new Error("Auth failed");
      const now=new Date().toISOString();
      // Determine what status to restore based on approval history
      let restoreStatus=WF.APPROVED;
      if(rec.OverrideBy)restoreStatus=WF.OVERRIDE_APPROVED;
      else if(rec.AltResult==="Approved"&&(!rec.ReviewedByName||rec.Result?.startsWith("Denied")))restoreStatus=WF.FINAL_DENIED;
      else if(rec.RegionalReviewedBy&&!rec.OverrideBy)restoreStatus=WF.FINAL_DENIED;
      // Build audit event
      const auditEvent={action:"Lease Outcome Reset",by:auth.user?.name||userEmail,email:userEmail,date:now,notes:`Previous: ${rec.Status}${rec.LeaseOutcomeTier?` (${rec.LeaseOutcomeTier})`:""}`};
      let updatedJSON="";
      if(rec.FormDataJSON){try{const snap=JSON.parse(rec.FormDataJSON);snap.auditEvents=[...(snap.auditEvents||[]),auditEvent];updatedJSON=JSON.stringify(snap)}catch{}}
      await spUpdate(tok,itemId,{Status:restoreStatus,LeaseOutcome:null,LeaseOutcomeBy:null,LeaseOutcomeByName:null,LeaseOutcomeDate:null,LeaseOutcomeTier:null,...(updatedJSON?{FormDataJSON:updatedJSON}:{})});
      setHistKey(k=>k+1);
    }catch(e){alert(`Failed to reset: ${e.message}`)}
  };

  const handleAdminEdit=async()=>{
    if(!adminEditFields||!lastSubmittedId)return;
    if(!confirm("Save admin corrections to this record?"))return;
    try{
      const tok=await auth.getToken();if(!tok)throw new Error("Auth failed");
      const now=new Date().toISOString();
      const updates={};
      const decision=adminEditFields.status;
      // Map decision to SharePoint fields
      if(decision==="Alt AMI Approved"){
        // Alt AMI: main status stays Denied, AltResult set to Approved
        updates.Status=WF.DENIED;
        updates.AltResult="Approved";
        updates.Result="Denied - Over Income";
      }else if(decision===WF.APPROVED){
        updates.Status=WF.APPROVED;
        updates.Result="Approved";
        updates.AltResult=null; // clear alt if previously set
      }else if(decision===WF.OVERRIDE_APPROVED){
        updates.Status=WF.OVERRIDE_APPROVED;
        updates.Result="Override Approved";
      }else if(decision===WF.DENIED){
        updates.Status=WF.DENIED;
        updates.Result=adminEditFields.result||"Denied";
        updates.AltResult=null;
      }
      // Review notes
      updates.ReviewNotes=adminEditFields.reviewNotes||"";
      // Override fields
      if(adminEditFields.overrideBy){updates.OverrideBy=adminEditFields.overrideBy;updates.OverrideNotes=adminEditFields.overrideNotes||""}
      if(adminEditFields.overrideNotes)updates.RegionalReviewNotes=adminEditFields.overrideNotes;
      // Audit event
      const rec=history.find(r=>r._itemId===lastSubmittedId);
      const auditEvent={action:"Admin Correction",by:auth.user?.name||userEmail,email:userEmail,date:now,notes:`Decision: ${decision}`};
      let updatedJSON="";
      if(rec?.FormDataJSON){try{const snap=JSON.parse(rec.FormDataJSON);snap.auditEvents=[...(snap.auditEvents||[]),auditEvent];updatedJSON=JSON.stringify(snap)}catch{}}
      if(updatedJSON)updates.FormDataJSON=updatedJSON;
      await spUpdate(tok,lastSubmittedId,updates);
      // Send correction notification email
      try{
        const emailRec=buildEmailRecord(rec,pr,fd,total,+rent,countyLimits);
        emailRec._submittedBy=rec?.SubmittedBy||"";
        emailRec._reviewedBy=rec?.ReviewedBy||"";
        const ratioInfo=calcRentToIncomeRatio(total,+rent);
        await sendWorkflowEmail(tok,"admin_correction",emailRec,ratioInfo,users,properties,auth.user?.name||userEmail,userEmail,decision);
      }catch(e){console.warn("Correction email failed:",e)}
      setHistKey(k=>k+1);
      alert("Record updated successfully.");
    }catch(e){alert(`Failed to save: ${e.message}`)}
  };

  const handlePrint=()=>{
    const el=document.getElementById("printable-result");if(!el)return;
    const w=window.open("","_blank");
    w.document.write(`<html><head><title>AMI Verification</title><link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700;800&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet"><style>body{margin:0;padding:20px;font-family:'Source Sans 3',sans-serif;}@media print{body{padding:0;}}</style></head><body>${el.outerHTML}</body></html>`);
    w.document.close();setTimeout(()=>w.print(),500);
  };

  // Get first county label for header
  const firstCounty=Object.values(counties)[0];
  const firstFY=getActiveFY(firstCounty);
  const headerLabel=Object.keys(counties).length===1?`${firstFY?.fy||""} HUD Income Limits â€” ${Object.keys(counties)[0]}`:`${Object.keys(counties).length} Coverage Areas`;

  if(!cfgDone&&auth.user)return(<div style={{background:"#1C3740",minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:fb}}><div style={{textAlign:"center",color:"rgba(255,255,255,0.6)"}}><div style={{fontSize:"14px",marginBottom:"6px"}}>Loading configuration...</div><div style={{fontSize:"11px",color:"rgba(255,255,255,0.35)"}}>Connecting to SharePoint</div></div></div>);

  return(
    <div style={{background:"#F7F8F7",minHeight:"100vh",color:B.teal700,fontFamily:fb}}>
      {/* HEADER */}
      <div style={{background:"#1C3740",borderBottom:`2px solid ${B.gold500}`,padding:"12px 20px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        <div style={{display:"flex",alignItems:"center"}}>
          <HouseIcon/>
          <div>
            <div style={{fontSize:"10px",fontWeight:700,color:B.gold500,textTransform:"uppercase",letterSpacing:"2px"}}>NewShire Property Management</div>
            <div style={{fontSize:"18px",fontWeight:900,color:"#FFFFFF",letterSpacing:"-0.2px",lineHeight:"1.1"}}>AMI Verification Calculator</div>
            <div style={{fontSize:"10px",color:"rgba(255,255,255,0.5)",marginTop:"1px"}}>{headerLabel} <span style={{color:"rgba(255,255,255,0.3)",fontSize:"9px",marginLeft:"6px"}}>v{APP_VERSION}</span></div>
          </div>
        </div>
        <div style={{display:"flex",gap:"6px",alignItems:"center"}}>
          <div style={{display:"flex",background:"rgba(255,255,255,0.08)",borderRadius:"4px",border:"1px solid rgba(255,255,255,0.12)",marginRight:"8px"}}>
            {[{key:"calculator",label:"Calculator"},{key:"review",label:"ðŸ“‹ Review Queue"},{key:"dashboard",label:"Dashboard"},{key:"history",label:"History"},{key:"admin",label:"âš™ Admin"}].map(t=>
              <button key={t.key} onClick={()=>setTab(t.key)} style={{background:tab===t.key?"rgba(255,255,255,0.12)":"transparent",border:"none",color:tab===t.key?"#FFFFFF":"rgba(255,255,255,0.55)",padding:"5px 12px",fontSize:"11px",fontWeight:700,cursor:"pointer",borderRadius:"3px",fontFamily:fb,textTransform:"uppercase",letterSpacing:"0.5px",borderBottom:tab===t.key?`2px solid ${B.gold500}`:"2px solid transparent"}}>{t.label}</button>
            )}
          </div>
          {canRun&&pr&&tab==="calculator"&&<Btn onClick={handlePrint}>Print Result</Btn>}
          {tab==="calculator"&&<Btn v="secondary" onClick={reset}>Reset</Btn>}
          {auth.user?(<span style={{fontSize:"10px",color:"rgba(255,255,255,0.5)",marginLeft:"4px",fontFamily:fb}}>âœ“ {auth.user.name||auth.user.username}{effectiveRoles.length>0&&<span style={{marginLeft:"4px",opacity:0.7}}>({effectiveRoles.map(r=>ROLE_LABELS[r]).join(" + ")})</span>}</span>)
          :CONFIG.isConfigured?(<Btn v="small" onClick={async()=>{await auth.getToken()}} style={{marginLeft:"4px",padding:"4px 10px",fontSize:"10px"}}>Sign In</Btn>):null}
        </div>
      </div>

      <div style={{padding:"16px 20px",maxWidth:"1200px"}}>

        {/* Sign-in gate for all tabs */}
        {!auth.user&&CONFIG.isConfigured?(
          <Card><div style={{textAlign:"center",padding:"40px",color:B.teal300}}>
            <div style={{fontSize:"24px",marginBottom:"8px"}}>ðŸ”‘</div>
            <div style={{fontSize:"14px",fontWeight:700,marginBottom:"8px"}}>Sign In Required</div>
            <div style={{fontSize:"12px",color:B.gray400,marginBottom:"14px"}}>Sign in with your Microsoft 365 account to access the calculator.</div>
            <Btn onClick={async()=>{await auth.getToken()}}>Sign In with Microsoft</Btn>
          </div></Card>
        ):auth.user&&!hasAnyRole?(
          <Card><div style={{textAlign:"center",padding:"40px",color:B.teal300}}>
            <div style={{fontSize:"24px",marginBottom:"8px"}}>ðŸš«</div>
            <div style={{fontSize:"14px",fontWeight:700,marginBottom:"8px"}}>No Access</div>
            <div style={{fontSize:"12px",color:B.gray400}}>Your account ({userEmail}) has not been assigned a role. Contact an administrator.</div>
          </div></Card>
        ):<>

        {/* ADMIN TAB */}
        {tab==="admin"&&<AdminPanel counties={counties} properties={properties} users={users} onSave={handleAdminSave} saving={adminSaving} lastSaved={cfgSaved} isAdmin={isAdmin}/>}

        {/* DASHBOARD TAB */}
        {tab==="dashboard"&&<Dashboard history={history} properties={properties}/>}

        {/* REVIEW QUEUE TAB */}
        {tab==="review"&&<ReviewQueue history={history} loading={histLoad} onAction={handleReviewAction} onLeaseOutcome={handleLeaseOutcome} onResetOutcome={handleResetOutcome} onReviewSelect={loadForReview} userRoles={effectiveRoles} userEmail={userEmail} users={users} properties={properties} counties={counties}/>}

        {/* HISTORY TAB */}
        {tab==="history"&&<HistoryPanel history={history} loading={histLoad} onSelect={loadFromHistory} userRoles={effectiveRoles} isAdmin={isAdmin} onDelete={handleDelete} properties={properties}/>}

        {/* CALCULATOR TAB */}
        {tab==="calculator"&&(
          <>
            {!canSubmit&&<div style={{background:B.wBg,border:`1px solid ${B.wBr}`,borderRadius:"6px",padding:"8px 14px",marginBottom:"12px",fontSize:"11px",color:B.gold500,fontWeight:600}}>
              ðŸ‘ View-only mode â€” You do not have permission to submit verifications. Contact an Admin to get access.
            </div>}
            <Card style={{marginBottom:"12px"}}>
              <div style={sCss}>Property & Unit Information</div>
              <div style={{display:"grid",gridTemplateColumns:"0.8fr 1fr 1.2fr 1.5fr 1fr 0.7fr 0.7fr 0.8fr",gap:"10px"}}>
                <F label="Date"><I type="date" value={vDate} onChange={setVDate}/></F>
                <F label="Reviewer"><I value={reviewer} onChange={setReviewer} placeholder="Your name"/></F>
                <F label="Primary Applicant"><I value={primaryApplicantName} onChange={setPAN} placeholder="Applicant full name"/></F>
                <F label="Property"><Sel value={propIdx} onChange={v=>{setPropIdx(v);setUnitCfg(null);setRent("")}} options={properties.map((p,i)=>({value:i,label:`${p.name} (${p.county?.split(",")[0]||""})`}))} placeholder="Select property"/></F>
                <F label="Unit Config"><Sel value={unitCfg?`${unitCfg.bedrooms}-${unitCfg.ami}`:""} onChange={v=>{const[b,a]=v.split("-").map(Number);const u=units.find(u=>u.bedrooms===b&&u.ami===a);setUnitCfg(u);if(u)setRent(String(u.marketRent))}} options={units.map(u=>({value:`${u.bedrooms}-${u.ami}`,label:`${u.bedrooms}BR / ${(u.ami*100).toFixed(0)}% AMI`}))} placeholder="Select"/></F>
                <F label="Unit #"><I value={unitNum} onChange={setUnitNum} placeholder="e.g. 162"/></F>
                <F label="Occupants"><I type="number" value={occ} onChange={setOcc} placeholder={unitCfg?String(anchorP(br)):"â€”"}/></F>
                <F label="Monthly Rent"><I type="number" value={rent} onChange={setRent} placeholder="0"/></F>
              </div>
              {unitCfg&&countyLimits&&(
                <div style={{background:B.teal50,border:`1px solid ${B.teal600}`,borderRadius:"4px",padding:"6px 10px",marginTop:"8px",fontSize:"10px",color:B.teal500,fontFamily:fm,display:"flex",gap:"20px",flexWrap:"wrap"}}>
                  <span>County: <b style={{color:B.white}}>{prop?.county}</b></span>
                  <span>FY: <b style={{color:B.gold400}}>{countyFY}</b></span>
                  <span>BR: <b style={{color:B.white}}>{br}</b></span>
                  <span>Anchor: <b style={{color:B.gold400}}>{anchorP(br)}p</b></span>
                  <span>Effective: <b style={{color:B.gold500}}>{effP(br,occ?+occ:0)}p</b></span>
                  <span>AMI: <b style={{color:B.white}}>{(ami*100).toFixed(0)}%</b></span>
                  <span>Limit: <b style={{color:B.ok}}><Mon amount={getLimit(ami,effP(br,occ?+occ:0),countyLimits)}/></b></span>
                </div>
              )}
            </Card>

            {/* OCCUPANT DETAILS â€” for print form */}
            <Card style={{marginBottom:"12px"}}>
              <div style={{...sCss,display:"flex",justifyContent:"space-between",alignItems:"center"}}><span>Household Occupant Details</span>
                {occupantDetails.length<8&&<Btn v="small" onClick={()=>setOccupantDetails([...occupantDetails,{name:"",dob:"",relationship:""}])} style={{padding:"2px 8px",fontSize:"10px"}}>+ Add Occupant</Btn>}
              </div>
              <div style={{fontSize:"10px",color:B.teal300,marginBottom:"8px"}}>List all household members (up to 8). Required for printed verification form.</div>
              {occupantDetails.length===0?<div style={{fontSize:"11px",color:B.gray500,textAlign:"center",padding:"8px"}}>No occupants added yet. Click "+ Add Occupant" above.</div>
              :occupantDetails.map((od,i)=>(
                <div key={i} style={{display:"grid",gridTemplateColumns:"1fr 120px 140px 24px",gap:"6px",alignItems:"end",marginBottom:"4px"}}>
                  <F label={i===0?"Full Name":""}><I value={od.name} onChange={v=>{const n=[...occupantDetails];n[i]={...n[i],name:v};setOccupantDetails(n)}} placeholder="Full name"/></F>
                  <F label={i===0?"Date of Birth":""}><I type="date" value={od.dob||""} onChange={v=>{const n=[...occupantDetails];n[i]={...n[i],dob:v};setOccupantDetails(n)}}/></F>
                  <F label={i===0?"Relationship":""}><Sel value={od.relationship} onChange={v=>{const n=[...occupantDetails];n[i]={...n[i],relationship:v};setOccupantDetails(n)}} options={["Self","Spouse","Child","Parent","Sibling","Other"]} placeholder="Select"/></F>
                  <button onClick={()=>setOccupantDetails(occupantDetails.filter((_,idx)=>idx!==i))} style={{background:"transparent",border:"none",color:B.no,cursor:"pointer",fontSize:"15px",padding:"7px 2px",marginBottom:"8px"}}>Ã—</button>
                </div>
              ))}
            </Card>

            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px",marginBottom:"12px"}}>
              <div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"}}>
                  <span style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px"}}>Paystubs ({applicants.length} applicant{applicants.length>1?"s":""})</span>
                  <div style={{display:"flex",gap:"4px"}}>
                    {applicants.length<8&&<Btn v="small" onClick={()=>setApplicants([...applicants,{name:"",paystubs:["","","",""],paystubFrequency:""}])} style={{padding:"2px 6px",fontSize:"9px"}}>+ Applicant</Btn>}
                    {applicants.length>1&&<Btn v="danger" onClick={()=>setApplicants(applicants.slice(0,-1))} style={{padding:"2px 6px",fontSize:"9px"}}>Remove</Btn>}
                  </div>
                </div>
                {applicants.map((a,i)=><PaystubSec key={i} idx={i} data={a} onChange={d=>{const n=[...applicants];n[i]=d;setApplicants(n)}}/>)}
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px",marginTop:"10px"}}>
                  <span style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px"}}>Offer Letters ({offers.length} applicant{offers.length>1?"s":""})</span>
                  <div style={{display:"flex",gap:"4px"}}>
                    {offers.length<8&&<Btn v="small" onClick={()=>setOffers([...offers,{name:"",hourly:"",hoursPerWeek:"",salary:""}])} style={{padding:"2px 6px",fontSize:"9px"}}>+ Applicant</Btn>}
                    {offers.length>1&&<Btn v="danger" onClick={()=>setOffers(offers.slice(0,-1))} style={{padding:"2px 6px",fontSize:"9px"}}>Remove</Btn>}
                  </div>
                </div>
                {offers.map((o,i)=><OfferSec key={i} idx={i} data={o} onChange={d=>{const n=[...offers];n[i]=d;setOffers(n)}}/>)}
              </div>
              <div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"}}>
                  <span style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px"}}>Bank Statements ({banks.length} applicant{banks.length>1?"s":""})</span>
                  <div style={{display:"flex",gap:"4px"}}>
                    {banks.length<8&&<Btn v="small" onClick={()=>setBanks([...banks,{name:"",deposits:["","",""]}])} style={{padding:"2px 6px",fontSize:"9px"}}>+ Applicant</Btn>}
                    {banks.length>1&&<Btn v="danger" onClick={()=>setBanks(banks.slice(0,-1))} style={{padding:"2px 6px",fontSize:"9px"}}>Remove</Btn>}
                  </div>
                </div>
                {banks.map((b,i)=><BankSec key={i} idx={i} data={b} onChange={d=>{const n=[...banks];n[i]=d;setBanks(n)}}/>)}
                <OtherSec items={other} onChange={setOther}/>
                <Card>
                  <div style={sCss}>Income Summary</div>
                  <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}><tbody>
                    {breakdown.map((b,i)=><tr key={i} style={{borderBottom:`1px solid ${B.teal600}`}}><td style={{padding:"5px 0",color:B.teal300}}>{b.label}</td><td style={{padding:"5px 0",textAlign:"right",fontFamily:fm,color:b.amount>0?B.white:B.gray400}}><Mon amount={b.amount}/></td></tr>)}
                    <tr style={{borderTop:`2px solid ${B.gold500}`}}><td style={{padding:"7px 0",fontWeight:800,color:B.white}}>Total Gross Annual</td><td style={{padding:"7px 0",textAlign:"right",fontFamily:fm,fontWeight:800,fontSize:"14px",color:B.gold400}}><Mon amount={total}/></td></tr>
                    <tr><td style={{padding:"3px 0",color:B.gray400,fontSize:"10px"}}>Monthly Gross</td><td style={{padding:"3px 0",textAlign:"right",fontFamily:fm,color:B.gray400,fontSize:"10px"}}><Mon amount={total/12}/></td></tr>
                  </tbody></table>
                </Card>
              </div>
            </div>

            {/* SAVED ATTACHMENTS â€” from loaded record */}
            {savedAttachments.length>0&&<Card style={{marginBottom:"12px"}}><AttachmentList attachments={savedAttachments}/></Card>}

            {/* FILE UPLOAD â€” before decision */}
            {canRun&&pr&&canSubmit&&!reviewMode&&submitSt!=="success"&&(
              <FileUploadZone files={attachmentFiles} setFiles={setAttachmentFiles}/>
            )}

            {/* REVIEWER ACTION PANEL â€” shown when a record is opened from review queue */}
            {reviewMode&&canRun&&pr&&(
              <Card style={{marginBottom:"12px",borderLeft:`3px solid ${reviewMode.type==="regional"?B.purple:B.gold500}`}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}>
                  <div style={{...sCss,color:reviewMode.type==="regional"?B.purple:B.gold500,marginBottom:0,borderBottom:"none",paddingBottom:0}}>{reviewMode.type==="regional"?"âš– Regional Review":"ðŸ“‹ Approver Review"}</div>
                  <Btn v="secondary" onClick={()=>{setReviewMode(null);setTab("review")}} style={{padding:"4px 10px",fontSize:"10px"}}>â† Back to Queue</Btn>
                </div>
                <div style={{fontSize:"11px",color:B.gray300,marginBottom:"10px"}}>
                  Submitted by <b style={{color:B.white}}>{reviewMode.record?.SubmittedByName||reviewMode.record?.Reviewer||"â€”"}</b> on {reviewMode.record?.DateCompleted?new Date(reviewMode.record.DateCompleted).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"â€”"}
                  {reviewMode.record?.ReviewedByName&&<span> | Previously reviewed by <b style={{color:B.white}}>{reviewMode.record.ReviewedByName}</b></span>}
                </div>
                {reviewMode.type==="approver"&&(<div>
                  <F label="Review Notes"><textarea value={reviewNotes} onChange={e=>setReviewNotes(e.target.value)} placeholder="Add review notes..." style={{...iCss,height:"50px",resize:"vertical"}}/></F>
                  <div style={{display:"flex",gap:"8px",flexWrap:"wrap",marginTop:"8px"}}>
                    <Btn v="success" onClick={async()=>{setReviewActing(true);try{await handleReviewAction(reviewMode.itemId,"approve",reviewNotes);setReviewMode(null);setTab("review")}catch(e){alert(e.message)}setReviewActing(false)}} disabled={reviewActing}>âœ“ Approve</Btn>
                    <Btn v="danger" onClick={async()=>{if(!reviewNotes.trim()){alert("Notes required for denial");return}setReviewActing(true);try{await handleReviewAction(reviewMode.itemId,"deny",reviewNotes);setReviewMode(null);setTab("review")}catch(e){alert(e.message)}setReviewActing(false)}} disabled={reviewActing}>âœ— Deny â†’ Regional</Btn>
                    <div style={{borderLeft:`1px solid ${B.teal600}`,margin:"0 4px"}}/>
                    <div style={{display:"flex",gap:"6px",alignItems:"center",flexWrap:"wrap"}}>
                      <Sel value={sendBackReason} onChange={setSendBackReason} options={SEND_BACK_REASONS} placeholder="Send back reason..." style={{width:"220px",fontSize:"10px",padding:"5px 8px"}}/>
                      {sendBackReason==="Other"&&<I value={sendBackOther} onChange={setSendBackOther} placeholder="Describe reason..." style={{width:"200px",fontSize:"10px",padding:"5px 8px"}}/>}
                      <Btn v="sendback" onClick={async()=>{const reason=sendBackReason==="Other"?sendBackOther.trim():sendBackReason;if(!reason){alert("Select a reason");return}setReviewActing(true);try{await handleReviewAction(reviewMode.itemId,"send_back",reason);setReviewMode(null);setTab("review")}catch(e){alert(e.message)}setReviewActing(false)}} disabled={reviewActing||(!sendBackReason)||(sendBackReason==="Other"&&!sendBackOther.trim())}>â†© Send Back</Btn>
                    </div>
                  </div>
                </div>)}
                {reviewMode.type==="regional"&&(<div>
                  <F label="Regional Review Notes"><textarea value={reviewNotes} onChange={e=>setReviewNotes(e.target.value)} placeholder="Override reason or final denial notes..." style={{...iCss,height:"50px",resize:"vertical"}}/></F>
                  <div style={{display:"flex",gap:"8px",marginTop:"8px"}}>
                    <Btn v="override" onClick={async()=>{if(!reviewNotes.trim()){alert("Notes required");return}setReviewActing(true);try{await handleReviewAction(reviewMode.itemId,"override_approve",reviewNotes);setReviewMode(null);setTab("review")}catch(e){alert(e.message)}setReviewActing(false)}} disabled={reviewActing}>âš– Override Approve</Btn>
                    <Btn v="danger" onClick={async()=>{if(!reviewNotes.trim()){alert("Notes required");return}setReviewActing(true);try{await handleReviewAction(reviewMode.itemId,"final_deny",reviewNotes);setReviewMode(null);setTab("review")}catch(e){alert(e.message)}setReviewActing(false)}} disabled={reviewActing}>âœ— Confirm Final Denial</Btn>
                  </div>
                </div>)}
              </Card>
            )}

            {/* ADMIN CORRECTION PANEL â€” edit decisions on completed records */}
            {adminEditFields&&isAdmin&&lastSubmittedId&&!reviewMode&&(
              <Card style={{marginBottom:"12px",borderLeft:`3px solid ${B.purple}`}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}>
                  <div style={{...sCss,color:B.purple,marginBottom:0,borderBottom:"none",paddingBottom:0}}>ðŸ”§ Admin Correction</div>
                  <Btn v="success" onClick={handleAdminEdit} style={{padding:"5px 14px",fontSize:"11px"}}>ðŸ’¾ Save Changes</Btn>
                </div>
                <div style={{fontSize:"10px",color:B.gray400,marginBottom:"10px"}}>Edit review decisions and notes on this completed record. Changes are logged in the audit trail.</div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px",marginBottom:"8px"}}>
                  <F label="Decision"><Sel value={adminEditFields.status} onChange={v=>setAdminEditFields({...adminEditFields,status:v})} options={[
                    {value:WF.APPROVED,label:"Approved"},
                    ...(ami!==0.8?[{value:"Alt AMI Approved",label:"Alt AMI Approved"}]:[]),
                    {value:WF.OVERRIDE_APPROVED,label:"Override Approved"},
                    {value:WF.DENIED,label:"Denied"},
                  ]} placeholder="Select decision"/></F>
                  <F label="Review Notes"><I value={adminEditFields.reviewNotes} onChange={v=>setAdminEditFields({...adminEditFields,reviewNotes:v})} placeholder="Approver review notes"/></F>
                </div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px"}}>
                  <F label="Override By"><I value={adminEditFields.overrideBy} onChange={v=>setAdminEditFields({...adminEditFields,overrideBy:v})} placeholder="Override authorizer name"/></F>
                  <F label="Override / Regional Notes"><I value={adminEditFields.overrideNotes} onChange={v=>setAdminEditFields({...adminEditFields,overrideNotes:v})} placeholder="Override or regional review notes"/></F>
                </div>
              </Card>
            )}

            {/* VERIFICATION DECISION */}
            {canRun&&pr&&(
              <Card style={{marginBottom:"12px"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div style={{...sCss,color:B.gold500,marginBottom:0,borderBottom:"none",paddingBottom:0}}>Verification Decision</div>
                  <div style={{display:"flex",gap:"6px",alignItems:"center"}}>
                    {submitSt==="success"&&<span style={{fontSize:"11px",color:B.ok,fontWeight:700}}>âœ“ Submitted for Review</span>}
                    {submitSt==="error"&&<span style={{fontSize:"11px",color:B.no,fontWeight:600}}>{submitErr}</span>}
                    {canSubmit&&!reviewMode&&<Btn v="success" onClick={handleSubmit} disabled={submitSt==="submitting"} style={{padding:"7px 18px"}}>{submitSt==="submitting"?"Submitting...":(lastSubmittedId?"ðŸ”„ Update & Resubmit":"ðŸ“‹ Submit for Review")}</Btn>}
                  </div>
                </div>
                <div style={{marginTop:"10px"}}>
                  {overrideStatus==="OVERRIDE_APPROVED"?
                    <ResultBadge result={pr.result} reason={pr.reason} variance={pr.variance} tier={ami} overrideStatus={overrideStatus} overrideBy={overrideBy} overrideNotes={overrideNotesDisplay}/>
                    :<ResultBadge result={pr.result} reason={pr.reason} variance={pr.variance} tier={ami}/>
                  }
                  {ar&&!overrideStatus&&<><div style={{fontSize:"10px",color:B.teal300,margin:"6px 0 3px",textTransform:"uppercase",letterSpacing:"0.5px",fontWeight:700}}>Alt AMI Review (80%)</div><ResultBadge result={ar.result} reason={ar.reason} variance={ar.variance} tier={0.8}/></>}
                  {pr.result==="DENIED"&&!ar&&ami===0.8&&!overrideStatus&&<div style={{background:B.noBg,border:`1px solid ${B.noBr}`,borderRadius:"5px",padding:"8px 12px",fontSize:"11px",color:B.no,fontWeight:700,marginTop:"4px"}}>Already at 80% AMI â€” no higher tier available.</div>}
                </div>
                <F label="Verification Notes (optional)" style={{marginTop:"10px"}}><I value={notes} onChange={setNotes} placeholder="Notes for the reviewer..."/></F>
              </Card>
            )}

            {canRun&&pr&&<PrintResult fd={fd} pr={pr} ar={ar} total={total} breakdown={breakdown} reviewer={reviewer} limitsLabel={`${countyFY} HUD Income Limits â€” ${prop?.county||""}`} overrideStatus={overrideStatus} overrideBy={overrideBy} overrideNotes={overrideNotesDisplay} vDate={vDate} auditTrail={auditTrail}/>}
          </>
        )}
        </>}
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(window.AMICalculator));
</script>
</body>
</html>
